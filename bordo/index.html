<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Técnico de Bordo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .report-page { background: white; width: 210mm; min-height: 297mm; margin: 2rem auto; padding: 15mm; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .report-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 1rem; }
        .report-header .company-info { text-align: right; font-size: 10px; }
        .report-title-bar { background-color: #dbeafe; color: #1e3a8a; font-weight: 700; text-align: center; padding: 8px; margin-top: 1.5rem; margin-bottom: 1.5rem; border-radius: 6px; }
        .report-footer { margin-top: auto; display: flex; justify-content: center; align-items: center; gap: 2rem; padding-top: 1rem; }
        .report-footer img { height: 35px; }
        .data-table-report { width: 100%; border-collapse: collapse; font-size: 12px; }
        .data-table-report th, .data-table-report td { border: 1px solid #ccc; padding: 4px 8px; }
        .data-table-report th { background-color: #f0f0f0; text-align: left; }
        .data-table-report tbody tr { height: 1.6em; }
        .row-selected { background-color: #a5b4fc !important; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center; }
        .photo-slot { border: 2px dashed #9ca3af; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 250px; background-color: #f9fafb; position: relative; }
        .photo-slot .image-preview { width: 100%; height: calc(100% - 36px); object-fit: cover; border-radius: 0.5rem 0.5rem 0 0; }
        .photo-slot .upload-label { position: absolute; top: 0; left: 0; right: 0; bottom: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #6b7280; }
        .photo-slot .upload-label:hover { background-color: rgba(0,0,0,0.05); }
        .photo-slot input[type="file"] { display: none; }
        .photo-slot .description-input { width: 100%; border: none; border-top: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem; border-radius: 0 0 0.5rem 0.5rem; background-color: #f3f4f6; }
        @media print { body, .report-page { margin: 0; box-shadow: none; } .report-preview-controls { display: none; } }
    </style>
</head>
<body class="bg-gray-200">
    
    <!-- TELA DE INFORMAÇÕES DO SERVIÇO (BORDO) -->
    <div id="bordo-app-screen" class="hidden p-2 sm:p-6">
        <div class="container mx-auto max-w-5xl">
            <div class="bg-slate-400 p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Seção Informações do Serviço -->
                    <div>
                        <h2 class="text-xl font-bold text-center text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">INFORMAÇÕES DO SERVIÇO</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="bordo-os" class="block text-sm font-medium text-gray-700">OS</label>
                                <input type="text" id="bordo-os" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div>
                                <label for="bordo-rt" class="block text-sm font-medium text-gray-700">RT</label>
                                <input type="text" id="bordo-rt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div class="sm:col-span-2">
                                <label for="bordo-tipo-servico" class="block text-sm font-medium text-gray-700">TIPO DE SERVIÇO</label>
                                <select id="bordo-tipo-servico" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <option value=""></option>
                                    <option>ASTEC</option>
                                    <option>BANCADA</option>
                                    <option>DOCAGEM</option>
                                    <option>INSTALAÇÃO</option>
                                    <option>MANUTENÇÃO CORRETIVA</option>
                                    <option>MANUTENÇÃO PREDITIVA</option>
                                    <option>MANUTENÇÃO PREVENTIVA</option>
                                    <option>MEGAGEM</option>
                                    <option>SERVIÇOS EXTERNOS</option>
                                    <option>SERVIÇOS INTERNOS</option>
                                    <option>VISITA TÉCNICA</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2">
                                <label for="bordo-resumo-servico" class="block text-sm font-medium text-gray-700">RESUMO DO SERVIÇO</label>
                                <select id="bordo-resumo-servico" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                      <option value=""></option>
                                      <option>ANTI-INCRUSTANTE</option>
                                      <option>AUTOMAÇÃO</option>
                                      <option>CJC</option>
                                      <option>DISJUNTOR</option>
                                      <option>ELÉTRICA GERAL</option>
                                      <option>HOLOFOTE DE BUSCA</option>
                                      <option>INSTRUMENTAÇÃO</option>
                                      <option>INVERSOR DE FREQUÊNCIA</option>
                                      <option>LIMPADOR DE PARABRISA</option>
                                      <option>MEGAGEM</option>
                                      <option>OIL MIST DETECTOR</option>
                                      <option>OUTROS SERVIÇOS</option>
                                      <option>SCHALLER</option>
                                      <option>SOFT-STARTER</option>
                                      <option>TERMOGRAFIA</option>
                                      <option>UPS</option>
                                      <option>VÁLVULAS</option>
                                      <option>WEG</option>
                                </select>
                            </div>
                            <div>
                                <label for="bordo-status-servico" class="block text-sm font-medium text-gray-700">STATUS DO SERVIÇO</label>
                                <select id="bordo-status-servico" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                      <option value=""></option>
                                      <option>FINALIZADO</option>
                                      <option>EM ANDAMENTO</option>
                                </select>
                            </div>
                             <div>
                                <label for="bordo-idioma" class="block text-sm font-medium text-gray-700">IDIOMA</label>
                                <select id="bordo-idioma" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <option>Português</option>
                                    <option>Inglês</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção Cliente -->
                    <div class="md:col-span-4 mt-6">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b-2 border-gray-500 pb-2 gap-4">
                            <a href="../" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto text-center">Voltar ao Portal</a>
                             <button id="bordo-saved-reports-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition w-full sm:w-auto">Relatórios Salvos</button>
                            <button id="bordo-avancar-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition w-full sm:w-auto">Avançar</button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="sm:col-span-2">
                                <label for="bordo-cliente" class="block text-sm font-medium text-gray-700">CLIENTE</label>
                                <select id="bordo-cliente" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <option value=""></option>
                                    <option>ÁGUAS DE NITERÓI</option>
                                    <option>ÁGUAS DE NOVA FRIBURGO</option>
                                    <option>ÁGUAS DO IMPERADOR</option>
                                    <option>ALIANÇA NAVEGAÇÃO E LOGÍSTICA</option>
                                    <option>ALTERA INFRASTRUCTURE</option>
                                    <option>Altera&Ocyan</option>
                                    <option>ANGLO AMERICAN</option>
                                    <option>ASGAARD NAVEGAÇÃO S.A.</option>
                                    <option>ASSO MARÍTIMA NAVEGAÇÃO</option>
                                    <option>BARU OFFSHORE NAVEGAÇÃO</option>
                                    <option>BOW ATLANTIC (FLUMAR)</option>
                                    <option>BRAM OFFSHORE TRANSPORTES MARÍTIMOS</option>
                                    <option>CAMORIM</option>
                                    <option>CEDAE</option>
                                    <option>CLUBE DE REGATAS DO FLAMENGO</option>
                                    <option>CONSTELLATION</option>
                                    <option>DETROIT BRASIL</option>
                                    <option>DOF SUBSEA</option>
                                    <option>DOME SERVIÇOS INTEGRADOS</option>
                                    <option>ELCANO</option>
                                    <option>EM&I GROUP</option>
                                    <option>FLA-FLU SERVICOS SA</option>
                                    <option>FUGRO</option>
                                    <option>GRUPO BRAVANTE</option>
                                    <option>GRUPO CBO</option>
                                    <option>GRUPO SOTREQ</option>
                                    <option>GRUPO UNITECH</option>
                                    <option>HARTMANN INDÚSTRIA E COMÉRCIO</option>
                                    <option>HIDROVIAS DO BRASIL</option>
                                    <option>HIGHBRAS</option>
                                    <option>INOV8</option>
                                    <option>KNOT</option>
                                    <option>LOCAR</option>
                                    <option>LOGIN</option>
                                    <option>MAERSK</option>
                                    <option>MAPAMAR</option>
                                    <option>NORSUL</option>
                                    <option>OCEANICA</option>
                                    <option>OCEANPACT</option>
                                    <option>PETROBRAS TRANSPORTES S/A</option>
                                    <option>POSIDONIA</option>
                                    <option>STARNAV SERVIÇOS MARÍTIMOS</option>
                                    <option>TRANSHIP SERVIÇOS MARÍTIMOS</option>
                                    <option>TRANSPETRO</option>
                                    <option>UP OFFSHORE</option>
                                    <option>WILSONS SONS</option>
                                </select>
                            </div>
                            <div class="sm:col-span-2">
                                <label for="bordo-embarcacao" class="block text-sm font-medium text-gray-700">EMBARCAÇÃO</label>
                                <input type="text" id="bordo-embarcacao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div>
                                <label for="bordo-localizacao" class="block text-sm font-medium text-gray-700">LOCALIZAÇÃO</label>
                                <select id="bordo-localizacao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                      <option value=""></option>
                                      <option>B PORT - PORTO DO AÇU</option>
                                      <option>ESTALEIRO RENAVE</option>
                                      <option>DOCK BRASIL</option>
                                      <option>PORTO DE NITERÓI</option>
                                      <option>MACLAREN - PONTA DA AREIA</option>
                                      <option>MACLAREN - ILHA DA CONCEIÇÃO</option>
                                      <option>ESTALEIRO ALIANÇA</option>
                                      <option>ESTALEIRO DOME</option>
                                      <option>FUNDEIO MACAÉ</option>
                                      <option>PORTO DE IMBETIBA</option>
                                      <option>ESTALEIRO MAUÁ</option>
                                      <option>TRIUNFO LOGÍSTICA</option>
                                      <option>PORTO DO RIO</option>
                                      <option>ESTALEIRO TYSSENKRUPP</option>
                                      <option>PORTO DE SANTOS</option>
                                      <option>FUNDEIO BAIA DE GUANABARA</option>
                                      <option>PORTO DE VITÓRIA</option>
                                      <option>RECIFE</option>
                                      <option>FORTALEZA</option>
                                      <option>PORTO DE CHIBATÃO</option>
                                      <option>ESTALEIRO CAMORIM</option>
                                      <option>ARSENAL DA MARINHA DO RIO DE JANEIRO</option>
                                      <option>MARINHA DO BRASIL - ILHA DE MOCANGUE</option>
                                      <option>PECÉM</option>
                                      <option>ESTALEIRO BRASCO - ILHA DA CONCEIÇÃO</option>
                                      <option>ESTALEIRO BRASCO - CAJU</option>
                                      <option>TERMINAL INTERMOOR</option>
                                      <option>GRUPO UNITECH</option>
                                      <option>ESTALEIRO NAVSHIP</option>
                                      <option>ESTALEiro CASSINU</option>
                                      <option>ESTALEIRO SÃO MIGUEL</option>
                                      <option>DETROIT BRASIL</option>
                                      <option>FUNDEIO ANGRA DOS REIS</option>
                                </select>
                            </div>
                            <div>
                                <label for="bordo-cidade-estado" class="block text-sm font-medium text-gray-700">CIDADE - ESTADO</label>
                                <input type="text" id="bordo-cidade-estado" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <div class="mt-1 flex items-center">
                                    <input id="bordo-cidade-nao-encontrada" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="bordo-cidade-nao-encontrada" class="ml-2 block text-sm text-gray-900">Cidade não encontrada</label>
                                </div>
                            </div>
                             <div>
                                <label for="bordo-solicitacao" class="block text-sm font-medium text-gray-700">NÚMERO DA SOLICITAÇÃO</label>
                                <input type="text" id="bordo-solicitacao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div>
                                <label for="bordo-solicitante" class="block text-sm font-medium text-gray-700">SOLICITANTE</label>
                                <input type="text" id="bordo-solicitante" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TELA DE ITENS DO RELATÓRIO DE BORDO -->
    <div id="bordo-itens-screen" class="hidden p-4 sm:p-6">
        <div class="container mx-auto max-w-5xl">
               <div class="mb-4 flex flex-wrap gap-4">
                    <button id="itens-back-to-info-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar</button>
                    <button id="bordo-save-report-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Salvar Relatório</button>
               </div>
            <div class="bg-slate-400 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-6 border-b-2 border-gray-500 pb-2">ITENS DO RELATÓRIO</h2>
                
                <!-- Botões de Ação -->
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
                    <button id="horas-trabalhadas-btn" class="bg-white text-gray-800 font-semibold py-3 px-2 rounded-lg shadow hover:bg-gray-100 transition text-center">HORAS TRABALHADAS</button>
                    <button id="horas-viagem-btn" class="bg-white text-gray-800 font-semibold py-3 px-2 rounded-lg shadow hover:bg-gray-100 transition text-center">HORAS DE VIAGEM</button>
                    <button id="materiais-btn" class="bg-white text-gray-800 font-semibold py-3 px-2 rounded-lg shadow hover:bg-gray-100 transition text-center">MATERIAIS FORNECIDOS</button>
                    <button id="comentarios-btn" class="bg-white text-gray-800 font-semibold py-3 px-2 rounded-lg shadow hover:bg-gray-100 transition text-center">COMENTÁRIOS</button>
                    <button id="descricao-servicos-btn" class="bg-white text-gray-800 font-semibold py-3 px-2 rounded-lg shadow hover:bg-gray-100 transition text-center">DESCRIÇÃO DOS SERVIÇOS</button>
                    <button id="relatorio-fotografico-btn" class="bg-white text-gray-800 font-semibold py-3 px-2 rounded-lg shadow hover:bg-gray-100 transition text-center">RELATÓRIO FOTOGRÁFICO</button>
                </div>

                <!-- Botões Finais -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                       <button id="emitir-relatorio-btn" class="bg-orange-500 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-orange-600 transition sm:col-span-2">EMITIR RELATÓRIO</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAIS E TELAS ADICIONAIS -->
    <div id="modals-container">
        <!-- TELA HORAS TRABALHADAS (MODAL/OVERLAY) -->
        <div id="bordo-horas-trabalhadas-screen" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 p-4 sm:p-6 z-50 flex justify-center items-center">
            <div class="container mx-auto max-w-4xl bg-slate-300 p-6 rounded-lg shadow-lg flex flex-col max-h-[95vh]">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">HORAS TRABALHADAS</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end mb-4">
                       <div class="lg:col-span-1">
                            <label for="horas-trabalhadas-data" class="block text-sm font-medium text-gray-700">DATA</label>
                            <input type="date" id="horas-trabalhadas-data" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                       <div class="lg:col-span-1">
                            <label for="horas-trabalhadas-colaborador" class="block text-sm font-medium text-gray-700">COLABORADORES</label>
                            <select id="horas-trabalhadas-colaborador" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value=""></option>
                                <option>ALAN REIS</option>
                                <option>AMARO FABIANO PESSANHA FERNANDES</option>
                                <option>ANDRÉ SOARES FRANÇA</option>
                                <option>ANTONIO CARLOS EUGENIO LABRE</option>
                                <option>ARTHUR NEVES DOS SANTOS SILVA</option>
                                <option>BRUNO DE ARAUJO ROSA FERREIRA</option>
                                <option>CARLOS EDUARDO GOMES CARVALHO</option>
                                <option>CARLOS HENRIQUE ROSA DA CUNHA</option>
                                <option>DIEGO EUFRÁSIO DE SOUZA</option>
                                <option>EDMILSON CESAR GONÇALVES DOS SANTOS</option>
                                <option>ELAINE DA FONSECA FERNANDES</option>
                                <option>EWERTON ANDRE QUIRINO DA SILVA</option>
                                <option>GABRIEL SILVA DE SOUZA PEREIRA</option>
                                <option>GIOVANNI BOSCO SANT'ANNA DA CONCEIÇÃO</option>
                                <option>GLAUBER DE SOUZA ALVES</option>
                                <option>GUILHERME DA SILVA LYRA</option>
                                <option>GUILHERME SANTOS NASCIMENTO</option>
                                <option>HELLEN DESIRÉE PAIVA RIBEIRO</option>
                                <option>HUELIGTON ROSA CUNHA</option>
                                <option>HUGO PINHEIRO CUNHA</option>
                                <option>IAN SANTANA CUNHA</option>
                                <option>JOÃO LUIZ PEIXOTO CARVALHO</option>
                                <option>JORGE LUIZ LOPES DE SOUZA</option>
                                <option>JORGE WIDSON FARIAS DA SILVA</option>
                                <option>JOSE HENRIQUE SEVERINI PEREIRA</option>
                                <option>KAUAN DE ABREU MEDEIROS POUBEL</option>
                                <option>LETICIA RODRIGUES ARAUJO</option>
                                <option>LUCAS ACHODIAM FRANCO DE MEDEIROS</option>
                                <option>LUCAS DE AMORIM COSTA</option>
                                <option>LUCAS SILVA DE SOUZA</option>
                                <option>LUCIANO ENEAS MARTINS</option>
                                <option>MARIO HENRIQUE DO NASCIMENTO MARTINS</option>
                                <option>MOABE JEFFERSON COSTA SILVA</option>
                                <option>RAFAEL DA SILVA</option>
                                <option>RAFAEL DE CARVALHO TEIXEIRA</option>
                                <option>RAPHAEL DE SOUSA PINHEIRO</option>
                                <option>ROBERTO DE SOUZA POUBEL</option>
                                <option>RODRIGO LUIZ GOMES DE CARVALHO</option>
                                <option>ROOSEVELT BATISTA DOS SANTOS</option>
                                <option>SANDRO MERLIM DOS SANTOS</option>
                                <option>THIAGO DE SOUSA PINHEIRO</option>
                                <option>THIAGO SANTANA PINTO</option>
                                <option>THIAGO SOALHEIRO MOREIRA</option>
                                <option>VITOR ALBERTO OLIVEIRA DOS ANJOS</option>
                                <option>WAGNER NASCIMENTO DA COSTA</option>
                                <option>WALACE DA SILVA MARQUES</option>
                                <option>WANDERSON DA SILVA MARQUES</option>
                                <option>WANDERSON SILVA RODRIGUES</option>
                                <option>WESLEY DA SILVA HCHER</option>
                                <option>WESLEY GAMA DE OLIVEIRA BATISTA</option>
                                <option>WILLIAM DE SOUZA POUBEL JANES</option>
                            </select>
                        </div>
                       <div class="lg:col-span-1">
                            <label for="horas-trabalhadas-inicio" class="block text-sm font-medium text-gray-700">INÍCIO</label>
                            <input type="time" id="horas-trabalhadas-inicio" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                       <div class="lg:col-span-1">
                            <label for="horas-trabalhadas-fim" class="block text-sm font-medium text-gray-700">FIM</label>
                            <input type="time" id="horas-trabalhadas-fim" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                </div>
                <div class="bg-white rounded-lg shadow mb-4 flex-grow overflow-y-auto custom-scrollbar">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-700 text-white sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">DATA</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">COLABORADORES</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">INÍCIO</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">FIM</th>
                                </tr>
                            </thead>
                            <tbody id="horas-trabalhadas-lista" class="bg-white divide-y divide-gray-200">
                                <tr class="text-center">
                                    <td colspan="4" class="py-4 text-gray-500">Nenhum horário adicionado.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex gap-2 order-2 sm:order-1">
                       <button id="horas-trabalhadas-adicionar-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">ADICIONAR</button>
                       <button id="horas-trabalhadas-salvar-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">SALVAR</button>
                       <button id="horas-trabalhadas-excluir-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">EXCLUIR</button>
                    </div>
                    <button id="horas-trabalhadas-voltar-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition order-1 sm:order-2 w-full sm:w-auto">Voltar</button>
                </div>
            </div>
        </div>
        <!-- TELA HORAS VIAGEM (MODAL/OVERLAY) -->
        <div id="bordo-horas-viagem-screen" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 p-4 sm:p-6 z-50 flex justify-center items-center">
            <div class="container mx-auto max-w-5xl bg-slate-300 p-6 rounded-lg shadow-lg flex flex-col max-h-[95vh]">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">HORAS VIAGEM</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end mb-4">
                       <div>
                            <label for="viagem-data" class="block text-sm font-medium text-gray-700">DATA</label>
                            <input type="date" id="viagem-data" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                       <div>
                            <label for="viagem-origem" class="block text-sm font-medium text-gray-700">ORIGEM</label>
                            <input type="text" id="viagem-origem" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                       <div>
                            <label for="viagem-destino" class="block text-sm font-medium text-gray-700">DESTINO</label>
                            <input type="text" id="viagem-destino" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                       <div>
                            <label for="viagem-saida" class="block text-sm font-medium text-gray-700">SAÍDA</label>
                            <input type="time" id="viagem-saida" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                       <div>
                            <label for="viagem-chegada" class="block text-sm font-medium text-gray-700">CHEGADA</label>
                            <input type="time" id="viagem-chegada" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                </div>
                <div class="bg-white rounded-lg shadow mb-4 flex-grow overflow-y-auto custom-scrollbar">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-700 text-white sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">DATA</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ORIGEM</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">DESTINO</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">SAÍDA</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">CHEGADA</th>
                                </tr>
                            </thead>
                            <tbody id="viagem-lista" class="bg-white divide-y divide-gray-200">
                                <tr class="text-center">
                                    <td colspan="5" class="py-4 text-gray-500">Nenhuma viagem adicionada.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex gap-2 order-2 sm:order-1">
                       <button id="viagem-adicionar-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">ADICIONAR</button>
                       <button id="viagem-salvar-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">SALVAR</button>
                       <button id="viagem-excluir-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">EXCLUIR</button>
                    </div>
                    <button id="viagem-voltar-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition order-1 sm:order-2 w-full sm:w-auto">Voltar</button>
                </div>
            </div>
        </div>
        <!-- TELA MATERIAIS FORNECIDOS (MODAL/OVERLAY) -->
        <div id="bordo-materiais-screen" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 p-4 sm:p-6 z-50 flex justify-center items-center">
            <div class="container mx-auto max-w-4xl bg-slate-300 p-6 rounded-lg shadow-lg flex flex-col max-h-[95vh]">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">MATERIAIS FORNECIDOS</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end mb-4">
                    <div class="sm:col-span-2">
                        <label for="material-descricao" class="block text-sm font-medium text-gray-700">DESCRIÇÃO</label>
                        <input type="text" id="material-descricao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    </div>
                    <div>
                        <label for="material-quantidade" class="block text-sm font-medium text-gray-700">QUANTIDADE</label>
                        <input type="number" id="material-quantidade" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow mb-4 flex-grow overflow-y-auto custom-scrollbar">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-700 text-white sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">DESCRIÇÃO</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">QUANTIDADE</th>
                                </tr>
                            </thead>
                            <tbody id="material-lista" class="bg-white divide-y divide-gray-200">
                                <tr class="text-center">
                                    <td colspan="2" class="py-4 text-gray-500">Nenhum material adicionado.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex gap-2 order-2 sm:order-1">
                       <button id="material-adicionar-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">ADICIONAR</button>
                       <button id="material-salvar-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">SALVAR</button>
                       <button id="material-excluir-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">EXCLUIR</button>
                    </div>
                    <button id="material-voltar-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition order-1 sm:order-2 w-full sm:w-auto">Voltar</button>
                </div>
            </div>
        </div>
        <!-- TELA COMENTÁRIOS (MODAL/OVERLAY) -->
        <div id="bordo-comentarios-screen" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 p-4 sm:p-6 z-50 flex justify-center items-center">
            <div class="container mx-auto max-w-2xl bg-slate-300 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">COMENTÁRIOS</h2>
                <div class="mb-4">
                    <textarea id="comentarios-texto" class="w-full h-48 p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Digite seus comentários..."></textarea>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <button id="comentarios-salvar-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition order-2 sm:order-1">SALVAR</button>
                    <button id="comentarios-voltar-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition order-1 sm:order-2 w-full sm:w-auto">Voltar</button>
                </div>
            </div>
        </div>
        <!-- TELA DESCRIÇÃO DOS SERVIÇOS (MODAL/OVERLAY) -->
        <div id="bordo-descricao-servicos-screen" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 p-4 sm:p-6 z-50 flex justify-center items-center">
            <div class="container mx-auto max-w-4xl bg-slate-300 p-6 rounded-lg shadow-lg flex flex-col h-[95vh] sm:h-[90vh]">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">DESCRIÇÃO DE SERVIÇOS</h2>
                <div class="mb-2">
                    <input type="text" value="Página 1" class="w-24 p-1 border border-gray-300 rounded-md shadow-sm text-center" readonly>
                </div>
                <div class="flex-grow mb-4">
                    <textarea id="descricao-servicos-texto" class="w-full h-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Descreva os serviços realizados..."></textarea>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <button id="descricao-servicos-salvar-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition order-2 sm:order-1">SALVAR</button>
                    <div class="flex gap-2 order-3 sm:order-2">
                        <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition opacity-50 cursor-not-allowed">ADICIONAR PÁGINA</button>
                        <button class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition opacity-50 cursor-not-allowed">DELETAR PÁGINA</button>
                    </div>
                    <button id="descricao-servicos-voltar-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition order-1 sm:order-3 w-full sm:w-auto">Voltar</button>
                </div>
            </div>
        </div>
        <!-- TELA RELATÓRIO FOTOGRÁFICO (MODAL/OVERLAY) -->
        <div id="bordo-relatorio-fotografico-screen" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 p-2 sm:p-6 z-50 flex justify-center items-center">
            <div class="container mx-auto max-w-6xl bg-slate-300 p-4 sm:p-6 rounded-lg shadow-lg flex flex-col h-[95vh]">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">RELATÓRIO FOTOGRÁFICO</h2>
                
                <!-- Botões e Paginação -->
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                    <div class="flex items-center justify-center gap-4 order-2 sm:order-1">
                        <button id="photo-prev-page-btn" class="bg-gray-200 p-2 rounded-full shadow hover:bg-gray-300">&lt;</button>
                        <span id="photo-page-indicator">Página 1 de 1</span>
                        <button id="photo-next-page-btn" class="bg-gray-200 p-2 rounded-full shadow hover:bg-gray-300">&gt;</button>
                    </div>
                    <div class="flex gap-2 order-1 sm:order-2">
                         <button id="photo-add-page-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition">ADICIONAR PÁGINA</button>
                         <button id="photo-delete-page-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-red-700 transition">DELETAR PÁGINA</button>
                    </div>
                    <div class="flex gap-2 order-3">
                         <button id="photo-save-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition">SALVAR FOTOS</button>
                         <button id="relatorio-fotografico-voltar-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Voltar</button>
                    </div>
                </div>

                <!-- Área das Imagens -->
                <div class="w-full bg-white p-4 rounded-lg shadow-inner flex-grow overflow-y-auto custom-scrollbar">
                    <div id="photo-pages-container" class="h-full">
                        <!-- Photo pages will be rendered here by JS -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAL DE CONFIRMAÇÃO GENÉRICO -->
        <div id="confirm-modal" class="hidden modal-overlay">
            <div class="modal-content">
                <p id="confirm-modal-message" class="text-lg mb-6">Você tem certeza?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-modal-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                    <button id="confirm-modal-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirmar</button>
                </div>
            </div>
        </div>
        
        <!-- MODAL DE NOTIFICAÇÃO GENÉRICO -->
        <div id="notification-modal" class="hidden modal-overlay">
            <div class="modal-content">
                <p id="notification-modal-message" class="text-lg mb-6">Operação realizada.</p>
                <div class="flex justify-center">
                    <button id="notification-modal-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700 transition">OK</button>
                </div>
            </div>
        </div>

        <!-- TELA DE RELATÓRIOS SALVOS (MODAL) -->
        <div id="saved-reports-screen" class="hidden modal-overlay">
            <div class="container mx-auto max-w-3xl bg-slate-300 p-6 rounded-lg shadow-lg flex flex-col max-h-[95vh]">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-4 border-b-2 border-gray-500 pb-2">RELATÓRIOS SALVOS</h2>
                <div id="saved-reports-list" class="bg-white rounded-lg shadow mb-4 flex-grow overflow-y-auto custom-scrollbar p-4 space-y-3">
                    <!-- Lista de relatórios será inserida aqui -->
                </div>
                <div class="flex justify-end gap-4">
                     <button id="saved-reports-new-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Novo Relatório</button>
                     <button id="saved-reports-close-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Fechar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- ÁREA DE PRÉ-VISUALIZAÇÃO DO RELATÓRIO -->
    <div id="report-preview-screen" class="hidden">
        <div class="bg-gray-500 py-4 px-6 flex justify-center items-center sticky top-0 z-40 gap-4 report-preview-controls">
            <button id="preview-back-to-edit-btn" class="bg-white text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-200 transition">Voltar para Edição</button>
            <button id="print-report-btn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Imprimir</button>
        </div>
        <div id="report-pages-container" class="custom-scrollbar">
            <!-- As páginas do relatório serão geradas aqui -->
        </div>
    </div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- MÓDULO DE NAVEGAÇÃO E MODAIS ---
    const uiManager = {
        screens: { 
            bordoApp: document.getElementById('bordo-app-screen'),
            bordoItens: document.getElementById('bordo-itens-screen'),
            reportPreview: document.getElementById('report-preview-screen'),
        },
        modals: {
            horasTrabalhadas: document.getElementById('bordo-horas-trabalhadas-screen'),
            horasViagem: document.getElementById('bordo-horas-viagem-screen'),
            materiaisFornecidos: document.getElementById('bordo-materiais-screen'),
            comentarios: document.getElementById('bordo-comentarios-screen'),
            descricaoServicos: document.getElementById('bordo-descricao-servicos-screen'),
            relatorioFotografico: document.getElementById('bordo-relatorio-fotografico-screen'),
            savedReports: document.getElementById('saved-reports-screen'),
            confirm: document.getElementById('confirm-modal'),
            notification: document.getElementById('notification-modal'),
        },
        hideAll: function() {
            Object.values(this.screens).forEach(s => s.classList.add('hidden'));
            Object.values(this.modals).forEach(m => m.classList.add('hidden'));
        },
        to: function(screenName) {
            this.hideAll();
            if(this.screens[screenName]) {
                this.screens[screenName].classList.remove('hidden');
            }
        },
        showModal: function(modalName) {
            if(this.modals[modalName]) {
                this.modals[modalName].classList.remove('hidden');
                if (dataManager.modalData[modalName]) {
                    dataManager.modalData[modalName].load();
                }
            }
        },
        hideModal: function(modalName) {
             if(this.modals[modalName]) {
                this.modals[modalName].classList.add('hidden');
            }
        },
        showConfirm: function(message, onConfirm) {
            const confirmModal = this.modals.confirm;
            confirmModal.querySelector('#confirm-modal-message').textContent = message;
            
            const confirmBtn = confirmModal.querySelector('#confirm-modal-confirm-btn');
            const cancelBtn = confirmModal.querySelector('#confirm-modal-cancel-btn');

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                this.hideModal('confirm');
                onConfirm();
            });

            cancelBtn.onclick = () => this.hideModal('confirm');
            this.showModal('confirm');
        },
        showNotification: function(message) {
            const notificationModal = this.modals.notification;
            notificationModal.querySelector('#notification-modal-message').textContent = message;
            notificationModal.querySelector('#notification-modal-ok-btn').onclick = () => this.hideModal('notification');
            this.showModal('notification');
        }
    };

    // --- MÓDULO DE GERENCIAMENTO DE DADOS COM FIRESTORE ---
    const dataManager = {
        reportData: {},
        currentReportId: null, // ID do documento no Firestore
        userId: null,

        init: function(userId) {
            this.userId = userId;
            this.startNewReport();
        },

        getNewReportData: function() {
            return {
                os: '', rt: '', tipoServico: '', resumoServico: '', status: '', idioma: '',
                cliente: '', embarcacao: '', localizacao: '', cidade: '', solicitacao: '', solicitante: '',
                horasTrabalhadas: [],
                horasViagem: [],
                materiais: [],
                comentarios: '',
                descricaoServicos: '',
                fotos: [], 
            };
        },

        startNewReport: function() {
            this.currentReportId = null;
            this.reportData = this.getNewReportData();
            this.populateInfoScreen();
            console.log("Started new report.");
        },

        saveReportToFirestore: async function() {
            if (!this.userId) {
                uiManager.showNotification("Erro: Utilizador não autenticado.");
                return;
            }
            this.collectInfoScreenData();

            const reportCollectionRef = collection(db, 'users', this.userId, 'bordoReports');
            
            try {
                if (this.currentReportId) {
                    // Atualiza um relatório existente
                    const reportRef = doc(db, 'users', this.userId, 'bordoReports', this.currentReportId);
                    await setDoc(reportRef, { ...this.reportData, updatedAt: serverTimestamp() });
                    uiManager.showNotification("Relatório atualizado com sucesso!");
                } else {
                    // Cria um novo relatório
                    const docRef = await addDoc(reportCollectionRef, { ...this.reportData, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                    this.currentReportId = docRef.id; // Armazena o ID do novo documento
                    uiManager.showNotification("Relatório salvo com sucesso!");
                }
            } catch (error) {
                console.error("Error saving report to Firestore:", error);
                uiManager.showNotification("Ocorreu um erro ao salvar o relatório.");
            }
        },

        loadReportFromFirestore: function(reportId, data) {
            this.currentReportId = reportId;
            // Garante que todos os campos existem, mesmo que o dado salvo seja antigo
            this.reportData = { ...this.getNewReportData(), ...data };
            this.populateInfoScreen();
            uiManager.hideModal('savedReports');
            uiManager.to('bordoApp');
            console.log(`Loaded report ${reportId}`);
        },

        deleteReportFromFirestore: async function(reportId) {
             if (!this.userId) return;
             try {
                await deleteDoc(doc(db, 'users', this.userId, 'bordoReports', reportId));
                uiManager.showNotification("Relatório excluído com sucesso.");
                // Se o relatório excluído era o que estava aberto
                if (this.currentReportId === reportId) {
                    this.startNewReport();
                }
                loadAndDisplaySavedReports(); // Atualiza a lista
             } catch(error) {
                console.error("Error deleting report:", error);
                uiManager.showNotification("Erro ao excluir o relatório.");
             }
        },

        populateInfoScreen: function() {
            document.getElementById('bordo-os').value = this.reportData.os || '';
            document.getElementById('bordo-rt').value = this.reportData.rt || '';
            document.getElementById('bordo-tipo-servico').value = this.reportData.tipoServico || '';
            document.getElementById('bordo-resumo-servico').value = this.reportData.resumoServico || '';
            document.getElementById('bordo-status-servico').value = this.reportData.status || '';
            document.getElementById('bordo-idioma').value = this.reportData.idioma || 'Português';
            document.getElementById('bordo-cliente').value = this.reportData.cliente || '';
            document.getElementById('bordo-embarcacao').value = this.reportData.embarcacao || '';
            document.getElementById('bordo-localizacao').value = this.reportData.localizacao || '';
            document.getElementById('bordo-cidade-estado').value = this.reportData.cidade || '';
            document.getElementById('bordo-solicitacao').value = this.reportData.solicitacao || '';
            document.getElementById('bordo-solicitante').value = this.reportData.solicitante || '';
        },
        
        collectInfoScreenData: function() {
            this.reportData.os = document.getElementById('bordo-os').value;
            this.reportData.rt = document.getElementById('bordo-rt').value;
            this.reportData.tipoServico = document.getElementById('bordo-tipo-servico').value;
            this.reportData.resumoServico = document.getElementById('bordo-resumo-servico').value;
            this.reportData.status = document.getElementById('bordo-status-servico').value;
            this.reportData.idioma = document.getElementById('bordo-idioma').value;
            this.reportData.cliente = document.getElementById('bordo-cliente').value;
            this.reportData.embarcacao = document.getElementById('bordo-embarcacao').value;
            this.reportData.localizacao = document.getElementById('bordo-localizacao').value;
            this.reportData.cidade = document.getElementById('bordo-cidade-estado').value;
            this.reportData.solicitacao = document.getElementById('bordo-solicitacao').value;
            this.reportData.solicitante = document.getElementById('bordo-solicitante').value;
        },

        modalData: {
            horasTrabalhadas: {
                tempData: [], isDirty: false,
                load: function() { this.tempData = JSON.parse(JSON.stringify(dataManager.reportData.horasTrabalhadas)); this.isDirty = false; updateTable('horasTrabalhadas', this.tempData); },
                save: function() { dataManager.reportData.horasTrabalhadas = JSON.parse(JSON.stringify(this.tempData)); this.isDirty = false; uiManager.showNotification('Horas trabalhadas salvas com sucesso!'); uiManager.hideModal('horasTrabalhadas'); }
            },
            horasViagem: {
                tempData: [], isDirty: false,
                load: function() { this.tempData = JSON.parse(JSON.stringify(dataManager.reportData.horasViagem)); this.isDirty = false; updateTable('horasViagem', this.tempData); },
                save: function() { dataManager.reportData.horasViagem = JSON.parse(JSON.stringify(this.tempData)); this.isDirty = false; uiManager.showNotification('Horas de viagem salvas com sucesso!'); uiManager.hideModal('horasViagem');}
            },
            materiaisFornecidos: {
                tempData: [], isDirty: false,
                load: function() { this.tempData = JSON.parse(JSON.stringify(dataManager.reportData.materiais)); this.isDirty = false; updateTable('materiais', this.tempData); },
                save: function() { dataManager.reportData.materiais = JSON.parse(JSON.stringify(this.tempData)); this.isDirty = false; uiManager.showNotification('Materiais salvos com sucesso!'); uiManager.hideModal('materiaisFornecidos'); }
            },
            relatorioFotografico: {
                tempData: [], isDirty: false, currentPage: 0,
                load: function() { 
                    this.tempData = JSON.parse(JSON.stringify(dataManager.reportData.fotos)); 
                    if (this.tempData.length === 0) {
                        this.tempData.push(Array.from({ length: 6 }, () => ({ src: null, desc: '' })));
                    }
                    this.isDirty = false; 
                    this.currentPage = 0;
                    photoManager.renderPage();
                },
                save: function() { 
                    dataManager.reportData.fotos = JSON.parse(JSON.stringify(this.tempData)); 
                    this.isDirty = false; 
                    uiManager.showNotification('Relatório fotográfico salvo!'); 
                    uiManager.hideModal('relatorioFotografico'); 
                }
            }
        }
    };

    // --- LÓGICA DE GERAÇÃO DO RELATÓRIO ---
    function generateReportPreview() {
        dataManager.collectInfoScreenData();

        const container = document.getElementById('report-pages-container');
        container.innerHTML = ''; 

        const formData = {
            rt: dataManager.reportData.rt,
            tipoServico: dataManager.reportData.tipoServico,
            resumoServico: dataManager.reportData.resumoServico,
            embarcacao: dataManager.reportData.embarcacao,
            cliente: dataManager.reportData.cliente,
            localizacao: dataManager.reportData.localizacao,
            cidade: dataManager.reportData.cidade,
            solicitacao: dataManager.reportData.solicitacao,
            solicitante: dataManager.reportData.solicitante,
            status: dataManager.reportData.status,
            descricao: dataManager.reportData.descricaoServicos
        };

        const createReportHeader = (data) => `<header class="report-header"><img src="https://placehold.co/150x50/cccccc/222222?text=UNITED+POWER" alt="Logo Empresa" style="height: 50px;"><div class="company-info"><p>atendimento@grupounitech.com.br</p><p>(21) 98762-2155 / (21) 97119-2155</p><p>(21) 2624-0109 / (21) 2628-6411</p></div><div class="text-right"><p><span class="font-bold">RT:</span> ${data.rt || 'N/P'}</p><p>${data.tipoServico || 'N/P'}</p><p>${data.resumoServico || 'N/P'}</p></div></header>`;
        const createReportFooter = () => `<footer class="report-footer"><img src="https://placehold.co/100x40/cccccc/222222?text=Service+Center" alt="Logo Parceiro 1"><img src="https://placehold.co/150x40/cccccc/222222?text=SCHALLER" alt="Logo Parceiro 2"></footer>`;

        const capa = document.createElement('div');
        capa.className = 'report-page';
        capa.innerHTML = `${createReportHeader(formData)}<main class="flex-grow flex flex-col"><div class="report-title-bar">DADOS DO CLIENTE</div><div class="grid grid-cols-2 gap-x-8 gap-y-4 text-sm"><div class="flex items-center gap-4 col-span-2"><img src="https://placehold.co/80x80/cccccc/222222?text=LOGO" alt="Logo Cliente"><div><p class="font-bold text-base">${formData.cliente || 'NÃO PREENCHIDO'}</p><p>${formData.embarcacao || 'EMBARCAÇÃO NÃO PREENCHIDA'}</p></div></div><div><p><span class="font-bold">LOCALIZAÇÃO:</span></p><p>${formData.localizacao || 'N/P'}</p><p>${formData.cidade || 'N/P'}</p></div><div><p><span class="font-bold">N° de Solicitação:</span> ${formData.solicitacao || 'N/P'}</p><p><span class="font-bold">Solicitante:</span> ${formData.solicitante || 'N/P'}</p></div></div><div class="report-title-bar">DESCRIÇÃO DOS SERVIÇOS</div><div class="border p-4 rounded-md text-xs whitespace-pre-wrap break-words flex-grow">${formData.descricao || 'NÃO PREENCHIDO'}</div><div class="mt-4"><span class="font-bold">Status do Serviço:</span> ${formData.status || 'NÃO PREENCHIDO'}</div></main>${createReportFooter()}`;
        container.appendChild(capa);

        const subcapa = document.createElement('div');
        subcapa.className = 'report-page';
        let materiaisHtml = '';
        for(let i = 0; i < 15; i++) { materiaisHtml += `<tr style="height: 1.6em;"><td>${(dataManager.reportData.materiais[i] || { desc: '' }).desc}</td><td>${(dataManager.reportData.materiais[i] || { qtd: '' }).qtd}</td></tr>`; }
        subcapa.innerHTML = `${createReportHeader(formData)}<main class="flex-grow flex flex-col" style="min-height: 0;"><div class="flex flex-col" style="flex-basis: 60%;"><div class="report-title-bar">COMENTÁRIOS</div><div class="border p-4 rounded-md text-xs whitespace-pre-wrap break-words h-full">${dataManager.reportData.comentarios || 'Nenhum comentário adicional.'}</div></div><div class="flex flex-col mt-4 flex-grow"><div class="report-title-bar">MATERIAIS FORNECIDOS</div><table class="data-table-report"><thead><tr><th>DESCRIÇÃO</th><th style="width: 120px;">QUANTIDADE</th></tr></thead><tbody>${materiaisHtml}</tbody></table></div></main>${createReportFooter()}`;
        container.appendChild(subcapa);

        const paginaHoras = document.createElement('div');
        paginaHoras.className = 'report-page';
        let horasViagemHtml = '';
        for(let i = 0; i < 5; i++) { const item = dataManager.reportData.horasViagem[i] || {}; const fDate = item.data ? `${item.data.split('-')[2]}/${item.data.split('-')[1]}/${item.data.split('-')[0]}` : ''; horasViagemHtml += `<tr><td>${fDate}</td><td>${item.origem || ''}</td><td>${item.destino || ''}</td><td>${item.saida || ''}</td><td>${item.chegada || ''}</td></tr>`; }
        let horasTrabalhadasHtml = '';
        for(let i = 0; i < 20; i++) { const item = dataManager.reportData.horasTrabalhadas[i] || {}; const fDate = item.data ? `${item.data.split('-')[2]}/${item.data.split('-')[1]}/${item.data.split('-')[0]}` : ''; horasTrabalhadasHtml += `<tr><td>${fDate}</td><td>${item.colaborador || ''}</td><td>${item.inicio || ''}</td><td>${item.fim || ''}</td></tr>`; }
        paginaHoras.innerHTML = `${createReportHeader(formData)}<main class="flex-grow flex flex-col text-xs"><div class="report-title-bar text-sm">HORAS DE VIAGEM</div><table class="data-table-report"><thead><tr><th>DATA</th><th>ORIGEM</th><th>DESTINO</th><th>SAÍDA</th><th>CHEGADA</th></tr></thead><tbody>${horasViagemHtml}</tbody></table><div class="report-title-bar text-sm mt-6">HORAS TRABALHADAS</div><table class="data-table-report"><thead><tr><th>DATA</th><th>COLABORADORES</th><th>INICIO</th><th>FIM</th></tr></thead><tbody>${horasTrabalhadasHtml}</tbody></table><div class="report-title-bar text-sm mt-6">DESLOCAMENTO DE RETORNO</div><table class="data-table-report"><thead><tr><th>DATA</th><th>DESCRIÇÃO</th><th style="width: 150px;">HORÁRIO</th></tr></thead><tbody><tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td colspan="3" class="text-red-600 font-bold text-center">OBS.: HORÁRIO DE RETORNO SUJEITO A ALTERAÇÃO DEVIDO A LOGÍSTICA DE DESLOCAMENTO.</td></tr></tbody></table><div class="mt-auto pt-12 flex justify-around items-end text-center"><div><div class="border-b border-black w-64 pb-1"></div><p class="mt-1">ASS. TÉCNICO</p></div><div><div class="border-b border-black w-64 pb-1"></div><p class="mt-1">ASS. CLIENTE</p></div></div></main>${createReportFooter()}`;
        container.appendChild(paginaHoras);

        dataManager.reportData.fotos.forEach(pageData => {
            const hasPhotos = pageData.some(p => p.src);
            if (!hasPhotos) return;

            const photoPage = document.createElement('div');
            photoPage.className = 'report-page';
            let photoGridHtml = '';

            pageData.forEach(photo => {
                if (photo.src) {
                    photoGridHtml += `<div><div class="border border-black p-1 flex items-center justify-center" style="height: 75mm;"><img src="${photo.src}" class="max-w-full max-h-full object-contain"></div><div class="border border-black border-t-0 p-1 text-center text-xs flex items-center justify-center" style="height: 10mm;"><span>${photo.desc || '&nbsp;'}</span></div></div>`;
                } else {
                    photoGridHtml += `<div><div class="border border-gray-300" style="height: 85mm;"></div></div>`;
                }
            });

            photoPage.innerHTML = `${createReportHeader(formData)}<main class="flex-grow flex flex-col"><div class="report-title-bar text-sm">RELATÓRIO FOTOGRÁFICO</div><div class="grid grid-cols-2 gap-4" style="align-content: start;">${photoGridHtml}</div></main>${createReportFooter()}`;
            container.appendChild(photoPage);
        });

        uiManager.to('reportPreview');
    }
    
    // --- LÓGICA DAS TABELAS E FORMULÁRIOS DOS MODAIS ---
    function updateTable(type, data) {
        let tbody, emptyMsg, rowGenerator;
        const getTbody = (id) => document.getElementById(id);
        const createRow = (content) => `<tr class="text-center"><td colspan="10" class="py-4 text-gray-500">${content}</td></tr>`;

        if (type === 'horasTrabalhadas') {
            tbody = getTbody('horas-trabalhadas-lista');
            emptyMsg = createRow('Nenhum horário adicionado.');
            rowGenerator = (item, index) => { const fDate = item.data.split('-').reverse().join('/'); return `<tr data-index="${index}" class="cursor-pointer hover:bg-gray-100"><td class="px-6 py-3">${fDate}</td><td class="px-6 py-3">${item.colaborador}</td><td class="px-6 py-3">${item.inicio}</td><td class="px-6 py-3">${item.fim}</td></tr>`; };
        } else if (type === 'horasViagem') {
            tbody = getTbody('viagem-lista');
            emptyMsg = createRow('Nenhuma viagem adicionada.');
            rowGenerator = (item, index) => { const fDate = item.data.split('-').reverse().join('/'); return `<tr data-index="${index}" class="cursor-pointer hover:bg-gray-100"><td class="px-6 py-3">${fDate}</td><td class="px-6 py-3">${item.origem}</td><td class="px-6 py-3">${item.destino}</td><td class="px-6 py-3">${item.saida}</td><td class="px-6 py-3">${item.chegada}</td></tr>`; };
        } else if (type === 'materiais') {
             tbody = getTbody('material-lista');
             emptyMsg = createRow('Nenhum material adicionado.');
             rowGenerator = (item, index) => `<tr data-index="${index}" class="cursor-pointer hover:bg-gray-100"><td class="px-6 py-3">${item.desc}</td><td class="px-6 py-3">${item.qtd}</td></tr>`;
        }

        tbody.innerHTML = data.length === 0 ? emptyMsg : '';
        if (data.length > 0) {
            data.sort((a, b) => (a.data && b.data) ? new Date(a.data) - new Date(b.data) : 0);
            data.forEach((item, index) => { tbody.innerHTML += rowGenerator(item, index); });
            tbody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => {
                    tbody.querySelector('.row-selected')?.classList.remove('row-selected');
                    row.classList.add('row-selected');
                });
            });
        }
    }

    // --- LÓGICA DO RELATÓRIO FOTOGRÁFICO ---
    const photoManager = {
        container: document.getElementById('photo-pages-container'),
        pageIndicator: document.getElementById('photo-page-indicator'),
        
        renderPage: function() {
            const photoModal = dataManager.modalData.relatorioFotografico;
            const pageData = photoModal.tempData[photoModal.currentPage] || [];
            this.container.innerHTML = '';

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 gap-4 h-full';
            
            for (let i = 0; i < 6; i++) {
                const photo = pageData[i] ? { ...pageData[i] } : { src: null, desc: '' };
                const slotIndex = i;

                const slot = document.createElement('div');
                slot.className = 'photo-slot';
                
                const hasImage = photo.src;

                slot.innerHTML = `
                    <input type="file" id="photo-input-${photoModal.currentPage}-${slotIndex}" accept="image/*">
                    <label for="photo-input-${photoModal.currentPage}-${slotIndex}" class="upload-label" style="display: ${hasImage ? 'none' : 'flex'};">
                        <span>INSERIR IMAGEM</span>
                    </label>
                    <img src="${photo.src || ''}" class="image-preview" style="display: ${hasImage ? 'block' : 'none'};">
                    <input type="text" class="description-input" placeholder="Descrição da imagem..." value="${photo.desc}">
                `;

                slot.querySelector('input[type="file"]').addEventListener('change', (e) => this.handleImageUpload(e, slotIndex));
                slot.querySelector('.description-input').addEventListener('input', (e) => this.handleDescriptionChange(e, slotIndex));

                grid.appendChild(slot);
            }
            this.container.appendChild(grid);
            this.updatePageIndicator();
        },

        handleImageUpload: function(event, slotIndex) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const photoModal = dataManager.modalData.relatorioFotografico;
                photoModal.tempData[photoModal.currentPage][slotIndex].src = e.target.result;
                photoModal.isDirty = true;
                this.renderPage();
            };
            reader.readAsDataURL(file);
        },

        handleDescriptionChange: function(event, slotIndex) {
            const photoModal = dataManager.modalData.relatorioFotografico;
            photoModal.tempData[photoModal.currentPage][slotIndex].desc = event.target.value;
            photoModal.isDirty = true;
        },

        updatePageIndicator: function() {
            const photoModal = dataManager.modalData.relatorioFotografico;
            this.pageIndicator.textContent = `Página ${photoModal.currentPage + 1} de ${photoModal.tempData.length}`;
        },

        nextPage: function() {
            const photoModal = dataManager.modalData.relatorioFotografico;
            if (photoModal.currentPage < photoModal.tempData.length - 1) {
                photoModal.currentPage++;
                this.renderPage();
            }
        },

        prevPage: function() {
            const photoModal = dataManager.modalData.relatorioFotografico;
            if (photoModal.currentPage > 0) {
                photoModal.currentPage--;
                this.renderPage();
            }
        },

        addPage: function() {
            const photoModal = dataManager.modalData.relatorioFotografico;
            photoModal.tempData.push(Array.from({ length: 6 }, () => ({ src: null, desc: '' })));
            photoModal.isDirty = true;
            photoModal.currentPage = photoModal.tempData.length - 1;
            this.renderPage();
        },

        deletePage: function() {
            const photoModal = dataManager.modalData.relatorioFotografico;
            if (photoModal.tempData.length <= 1) {
                uiManager.showNotification("Não é possível excluir a única página.");
                return;
            }
            uiManager.showConfirm("Tem certeza que deseja excluir esta página de fotos?", () => {
                photoModal.tempData.splice(photoModal.currentPage, 1);
                photoModal.isDirty = true;
                if (photoModal.currentPage >= photoModal.tempData.length) {
                    photoModal.currentPage = photoModal.tempData.length - 1;
                }
                this.renderPage();
            });
        }
    };

    function setupModalEventListeners() {
        const setupCrud = (type, inputs, dataStore, tableType) => {
            const modalId = type.replace(/-/g, '');
            const modalInfo = {
                'horastrabalhadas': { modalName: 'horasTrabalhadas', tableId: 'horas-trabalhadas-lista' },
                'viagem': { modalName: 'horasViagem', tableId: 'viagem-lista' },
                'material': { modalName: 'materiaisFornecidos', tableId: 'material-lista' }
            };
            const currentModal = modalInfo[modalId];

            document.getElementById(`${type}-adicionar-btn`).addEventListener('click', () => {
                const newItem = {};
                let allFilled = true;
                for (const input of inputs) {
                    const el = document.getElementById(`${type}-${input}`);
                    if (!el.value) allFilled = false;
                    newItem[input] = el.value;
                }
                if (allFilled) {
                    dataStore.tempData.push(newItem);
                    dataStore.isDirty = true;
                    updateTable(tableType, dataStore.tempData);
                    inputs.forEach(input => { 
                        const el = document.getElementById(`${type}-${input}`);
                        if (el.type !== 'date') {
                           el.value = ''; 
                        }
                    });
                } else {
                    uiManager.showNotification('Por favor, preencha todos os campos.');
                }
            });
            document.getElementById(`${type}-excluir-btn`).addEventListener('click', () => {
                const selectedRow = document.querySelector(`#${currentModal.tableId} .row-selected`);
                if (selectedRow) {
                    dataStore.tempData.splice(parseInt(selectedRow.dataset.index, 10), 1);
                    dataStore.isDirty = true;
                    updateTable(tableType, dataStore.tempData);
                } else {
                    uiManager.showNotification('Selecione uma linha para excluir.');
                }
            });
            document.getElementById(`${type}-salvar-btn`).addEventListener('click', () => dataStore.save());
            document.getElementById(`${type}-voltar-btn`).addEventListener('click', () => {
                if (dataStore.isDirty) {
                    uiManager.showConfirm('Você tem alterações não salvas. Deseja sair?', () => uiManager.hideModal(currentModal.modalName));
                } else {
                    uiManager.hideModal(currentModal.modalName);
                }
            });
        };
        setupCrud('horas-trabalhadas', ['data', 'colaborador', 'inicio', 'fim'], dataManager.modalData.horasTrabalhadas, 'horasTrabalhadas');
        setupCrud('viagem', ['data', 'origem', 'destino', 'saida', 'chegada'], dataManager.modalData.horasViagem, 'horasViagem');
        setupCrud('material', ['descricao', 'quantidade'], dataManager.modalData.materiaisFornecidos, 'materiais');

        const comentariosTextarea = document.getElementById('comentarios-texto');
        document.getElementById('comentarios-btn').addEventListener('click', () => { comentariosTextarea.value = dataManager.reportData.comentarios; uiManager.showModal('comentarios'); });
        document.getElementById('comentarios-salvar-btn').addEventListener('click', () => { dataManager.reportData.comentarios = comentariosTextarea.value; uiManager.showNotification('Comentários salvos!'); uiManager.hideModal('comentarios'); });
        document.getElementById('comentarios-voltar-btn').addEventListener('click', () => { if (dataManager.reportData.comentarios !== comentariosTextarea.value) { uiManager.showConfirm('Alterações não salvas. Deseja sair?', () => uiManager.hideModal('comentarios')); } else { uiManager.hideModal('comentarios'); } });

        const descTextarea = document.getElementById('descricao-servicos-texto');
        document.getElementById('descricao-servicos-btn').addEventListener('click', () => { descTextarea.value = dataManager.reportData.descricaoServicos; uiManager.showModal('descricaoServicos'); });
        document.getElementById('descricao-servicos-salvar-btn').addEventListener('click', () => { dataManager.reportData.descricaoServicos = descTextarea.value; uiManager.showNotification('Descrição salva!'); uiManager.hideModal('descricaoServicos'); });
        document.getElementById('descricao-servicos-voltar-btn').addEventListener('click', () => { if (dataManager.reportData.descricaoServicos !== descTextarea.value) { uiManager.showConfirm('Alterações não salvas. Deseja sair?', () => uiManager.hideModal('descricaoServicos')); } else { uiManager.hideModal('descricaoServicos'); } });
        
        const photoModal = dataManager.modalData.relatorioFotografico;
        document.getElementById('photo-save-btn').addEventListener('click', () => photoModal.save());
        document.getElementById('relatorio-fotografico-voltar-btn').addEventListener('click', () => { if (photoModal.isDirty) { uiManager.showConfirm('Você tem fotos não salvas. Deseja sair?', () => uiManager.hideModal('relatorioFotografico')); } else { uiManager.hideModal('relatorioFotografico'); } });
        document.getElementById('photo-next-page-btn').addEventListener('click', () => photoManager.nextPage());
        document.getElementById('photo-prev-page-btn').addEventListener('click', () => photoManager.prevPage());
        document.getElementById('photo-add-page-btn').addEventListener('click', () => photoManager.addPage());
        document.getElementById('photo-delete-page-btn').addEventListener('click', () => photoManager.deletePage());
    }

    function setupClientLocationHandlers() {
        const clientLocationMap = { 'TRANSPETRO': 'FUNDEIO BAIA DE GUANABARA', 'PETROBRAS TRANSPORTES S/A': 'FUNDEIO BAIA DE GUANABARA', 'GRUPO CBO': 'PORTO DE NITERÓI', 'WILSONS SONS': 'PORTO DE SANTOS', 'MAERSK': 'PORTO DO RIO', 'DOF SUBSEA': 'FUNDEIO MACAÉ', 'GRUPO BRAVANTE': 'PORTO DO RIO', 'ALTERA INFRASTRUCTURE': 'FUNDEIO BAIA DE GUANABARA', 'CONSTELLATION': 'PORTO DE IMBETIBA', 'DOME SERVIÇOS INTEGRADOS': 'ESTALEIRO DOME', };
        const locationCityMap = { 'B PORT - PORTO DO AÇU': 'São João da Barra - RJ', 'ESTALEIRO RENAVE': 'Niterói - RJ', 'DOCK BRASIL': 'Niterói - RJ', 'PORTO DE NITERÓI': 'Niterói - RJ', 'MACLAREN - PONTA DA AREIA': 'Niterói - RJ', 'MACLAREN - ILHA DA CONCEIÇÃO': 'Niterói - RJ', 'ESTALEIRO ALIANÇA': 'Niterói - RJ', 'ESTALEIRO DOME': 'São João da Barra - RJ', 'FUNDEIO MACAÉ': 'Macaé - RJ', 'PORTO DE IMBETIBA': 'Macaé - RJ', 'ESTALEIRO MAUÁ': 'Niterói - RJ', 'TRIUNFO LOGÍSTICA': 'São Gonçalo - RJ', 'PORTO DO RIO': 'Rio de Janeiro - RJ', 'ESTALEIRO TYSSENKRUPP': 'Itaguaí - RJ', 'PORTO DE SANTOS': 'Santos - SP', 'FUNDEIO BAIA DE GUANABARA': 'Rio de Janeiro / Niterói - RJ', 'PORTO DE VITÓRIA': 'Vitória - ES', 'RECIFE': 'Recife - PE', 'FORTALEZA': 'Fortaleza - CE', 'PORTO DE CHIBATÃO': 'Manaus - AM', 'ESTALEIRO CAMORIM': 'Angra dos Reis - RJ', 'ARSENAL DA MARINHA DO RIO DE JANEIRO': 'Rio de Janeiro - RJ', 'MARINHA DO BRASIL - ILHA DE MOCANGUE': 'Niterói - RJ', 'PECÉM': 'São Gonçalo do Amarante - CE', 'ESTALEIRO BRASCO - ILHA DA CONCEIÇÃO': 'Niterói - RJ', 'ESTALEIRO BRASCO - CAJU': 'Rio de Janeiro - RJ', 'TERMINAL INTERMOOR': 'Niterói - RJ', 'GRUPO UNITECH': 'São Gonçalo - RJ', 'ESTALEIRO NAVSHIP': 'Navegantes - SC', 'ESTALEiro CASSINU': 'Itajaí - SC', 'ESTALEIRO SÃO MIGUEL': 'São Gonçalo - RJ', 'DETROIT BRASIL': 'Rio de Janeiro - RJ', 'FUNDEIO ANGRA DOS REIS': 'Angra dos Reis - RJ' };

        const clienteSelect = document.getElementById('bordo-cliente');
        const localizacaoSelect = document.getElementById('bordo-localizacao');
        const cidadeInput = document.getElementById('bordo-cidade-estado');
        const cidadeNaoEncontradaCheckbox = document.getElementById('bordo-cidade-nao-encontrada');

        function updateCityFromLocation() {
            if (cidadeNaoEncontradaCheckbox.checked) {
                cidadeInput.value = '';
                cidadeInput.readOnly = false;
            } else {
                const selectedLocation = localizacaoSelect.value;
                const city = locationCityMap[selectedLocation] || '';
                cidadeInput.value = city;
                cidadeInput.readOnly = true;
            }
        }

        function updateLocationFromClient() {
            const selectedClient = clienteSelect.value;
            const defaultLocation = clientLocationMap[selectedClient];
            if (defaultLocation) {
                localizacaoSelect.value = defaultLocation;
                localizacaoSelect.dispatchEvent(new Event('change'));
            }
        }
        
        clienteSelect.addEventListener('change', updateLocationFromClient);
        localizacaoSelect.addEventListener('change', () => {
            cidadeNaoEncontradaCheckbox.checked = false;
            updateCityFromLocation();
        });
        cidadeNaoEncontradaCheckbox.addEventListener('change', updateCityFromLocation);

        const loadedCity = dataManager.reportData.cidade || '';
        const mappedCity = locationCityMap[dataManager.reportData.localizacao] || '';
        if (loadedCity && loadedCity !== mappedCity) {
            cidadeNaoEncontradaCheckbox.checked = true;
            cidadeInput.readOnly = false;
        } else if (!cidadeNaoEncontradaCheckbox.checked) {
            cidadeInput.readOnly = true;
            if(dataManager.reportData.localizacao){
                updateCityFromLocation();
            }
        }
    }

    async function loadAndDisplaySavedReports() {
        if (!dataManager.userId) return;
        const reportCollectionRef = collection(db, 'users', dataManager.userId, 'bordoReports');
        const listContainer = document.getElementById('saved-reports-list');
        listContainer.innerHTML = '<p class="text-gray-500">A carregar relatórios...</p>';

        try {
            const querySnapshot = await getDocs(reportCollectionRef);
            const reports = [];
            querySnapshot.forEach((doc) => {
                reports.push({ id: doc.id, ...doc.data() });
            });

            if (reports.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">Nenhum relatório salvo.</p>';
                return;
            }
            
            // Ordena os relatórios pela data de atualização, do mais recente para o mais antigo
            reports.sort((a, b) => (b.updatedAt?.toDate() || 0) - (a.updatedAt?.toDate() || 0));

            listContainer.innerHTML = reports.map(report => {
                 const date = report.updatedAt ? report.updatedAt.toDate().toLocaleString('pt-BR') : 'Data indisponível';
                 return `
                    <div class="flex items-center justify-between p-3 rounded-lg border bg-white hover:bg-gray-50">
                        <div>
                            <p class="font-semibold text-blue-700">${report.os || 'Sem OS'} - ${report.embarcacao || 'Sem Embarcação'}</p>
                            <p class="text-xs text-gray-500">Última atualização: ${date}</p>
                        </div>
                        <div class="flex gap-2">
                             <button data-load-id="${report.id}" class="bg-blue-500 text-white px-3 py-1 text-xs rounded hover:bg-blue-600">Carregar</button>
                             <button data-delete-id="${report.id}" class="bg-red-500 text-white px-3 py-1 text-xs rounded hover:bg-red-600">Excluir</button>
                        </div>
                    </div>
                 `
            }).join('');
            
            // Adiciona os event listeners para os novos botões
            listContainer.querySelectorAll('[data-load-id]').forEach(button => {
                button.addEventListener('click', () => {
                    const reportId = button.dataset.loadId;
                    const reportData = reports.find(r => r.id === reportId);
                    dataManager.loadReportFromFirestore(reportId, reportData);
                });
            });
            listContainer.querySelectorAll('[data-delete-id]').forEach(button => {
                button.addEventListener('click', () => {
                     const reportId = button.dataset.deleteId;
                     uiManager.showConfirm("Tem certeza que deseja excluir este relatório permanentemente?", () => {
                        dataManager.deleteReportFromFirestore(reportId);
                     });
                });
            });

        } catch (error) {
            console.error("Error loading saved reports:", error);
            listContainer.innerHTML = '<p class="text-red-500">Erro ao carregar relatórios.</p>';
        }
    }


    // --- INICIALIZAÇÃO DO FIREBASE E APP ---
    const firebaseConfig = {
        apiKey: "AIzaSyAoPtdpU3MYRUCdj0dvn1LHYBv-ESWWH80",
        authDomain: "relatorios-tecnicos-app.firebaseapp.com",
        projectId: "relatorios-tecnicos-app",
        storageBucket: "relatorios-tecnicos-app.appspot.com",
        messagingSenderId: "280958854421",
        appId: "1:280958854421:web:90e4b288f3c57592d9351c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            dataManager.init(user.uid);
            
            setupClientLocationHandlers();
            setupModalEventListeners();

            document.getElementById('bordo-avancar-btn').addEventListener('click', () => {
                dataManager.collectInfoScreenData();
                uiManager.to('bordoItens');
            });
            document.getElementById('itens-back-to-info-btn').addEventListener('click', () => uiManager.to('bordoApp'));
            document.getElementById('bordo-save-report-btn').addEventListener('click', () => dataManager.saveReportToFirestore());
            
            document.getElementById('horas-trabalhadas-btn').addEventListener('click', () => uiManager.showModal('horasTrabalhadas'));
            document.getElementById('horas-viagem-btn').addEventListener('click', () => uiManager.showModal('horasViagem'));
            document.getElementById('materiais-btn').addEventListener('click', () => uiManager.showModal('materiaisFornecidos'));
            document.getElementById('comentarios-btn').addEventListener('click', () => uiManager.showModal('comentarios'));
            document.getElementById('descricao-servicos-btn').addEventListener('click', () => uiManager.showModal('descricaoServicos'));
            document.getElementById('relatorio-fotografico-btn').addEventListener('click', () => uiManager.showModal('relatorioFotografico'));
            
            document.getElementById('emitir-relatorio-btn').addEventListener('click', generateReportPreview);
            document.getElementById('preview-back-to-edit-btn').addEventListener('click', () => uiManager.to('bordoItens'));
            document.getElementById('print-report-btn').addEventListener('click', () => window.print());
            
            document.getElementById('bordo-saved-reports-btn').addEventListener('click', () => {
                loadAndDisplaySavedReports();
                uiManager.showModal('savedReports');
            });
            document.getElementById('saved-reports-close-btn').addEventListener('click', () => uiManager.hideModal('savedReports'));
            document.getElementById('saved-reports-new-btn').addEventListener('click', () => {
                uiManager.showConfirm("Deseja iniciar um novo relatório? O progresso atual (se não foi salvo) será perdido.", () => {
                    dataManager.startNewReport();
                    uiManager.hideModal('savedReports');
                    uiManager.to('bordoApp');
                });
            });
            
            uiManager.to('bordoApp');

        } else {
            window.location.href = '../index.html';
        }
    });

</script>
</body>
</html>

