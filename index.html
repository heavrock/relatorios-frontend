<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Relatórios Técnicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG4WdKCRpI72DhH1ZA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" xintegrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }
        .header-info { display: grid; grid-template-columns: auto 1fr; gap: 4px 8px; align-items: center; }
        .header-info label { font-weight: 600; text-align: right; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .data-table th, .data-table td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: center; vertical-align: middle; }
        .data-table th { background-color: #f3f4f6; font-weight: 600; }
        .data-table td.label-cell { text-align: left; font-weight: 500; background-color: #f9fafb; }
        .input-yellow { background-color: #fef9c3; width: 100%; text-align: center; border: 1px solid #fde047; border-radius: 4px; padding: 4px; }
        .input-yellow::placeholder { color: #a1a1aa; }
        .output-span { display: block; width: 100%; height: 100%; padding: 4px; min-height: 28px; border-radius: 4px; transition: background-color: 0.3s; }
        .output-blue { background-color: #e0f2fe; }
        .section-title { background-color: #dbeafe; color: #1e3a8a; font-weight: 700; text-align: center; padding: 8px; margin-top: 1rem; margin-bottom: 0.25rem; border-radius: 6px; }
        .unit-selector {
            padding: 2px 4px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: white;
            margin-left: 8px;
        }
        .menu-button {
            background-image: linear-gradient(to right, #4f46e5 0%, #7c3aed 51%, #4f46e5 100%);
            transition: 0.5s;
            background-size: 200% auto;
            box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.75);
        }
        .menu-button:hover {
            background-position: right center;
        }
        .menu-button:disabled {
            background-image: none;
            background-color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #transformer-insulation-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            border: 2px solid #9ca3af;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }
        @media (min-width: 768px) { #transformer-insulation-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { #transformer-insulation-grid { grid-template-columns: repeat(3, 1fr); } }

        .insulation-cell { border-bottom: 1px solid #d1d5db; }
        .insulation-cell:last-child { border-bottom: none; }
        
        @media (min-width: 1024px) {
            .insulation-cell { border-right: 1px solid #d1d5db; }
            .insulation-cell:nth-child(3n) { border-right: none; }
            .insulation-cell:nth-last-child(-n+3) { border-bottom: none; }
        }
        @media (min-width: 768px) and (max-width: 1023px) {
             .insulation-cell { border-right: 1px solid #d1d5db; }
             .insulation-cell:nth-child(2n) { border-right: none; }
             .insulation-cell:nth-last-child(-n+2) { border-bottom: none; }
        }

        .cell-title { background-color: #e5e7eb; font-weight: 600; padding: 6px; text-align: center; border-bottom: 1px solid #d1d5db; font-size: 12px; }
        .cell-content { padding: 8px; }
        .measurement-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; align-items: center; margin-bottom: 6px; }
        .measurement-item { text-align: center; }
        .measurement-item label { font-size: 11px; font-weight: 500; display: block; margin-bottom: 2px; }
        .measurement-item .input-group { display: flex; align-items: center; justify-content: center; }
        .measurement-item input { max-width: 70px; padding: 2px 4px; font-size: 13px; }
        .measurement-item span.unit { font-size: 12px; font-weight: 500; margin-left: 4px; }
        .correction-title { text-align: center; font-weight: 500; font-size: 12px; padding: 4px; background-color: #f9fafb; border-top: 1px solid #d1d5db; border-bottom: 1px solid #d1d5db; margin: 8px -8px; }
        .indices-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .index-item { text-align: center; }
        .index-item label { font-size: 12px; font-weight: 600; display: block; margin-bottom: 2px; }
        .index-item span { display: block; padding: 4px; border-radius: 4px; font-weight: 500; min-height: 28px; }
        .status-cell { padding: 6px; border-radius: 6px; text-align: center; font-weight: bold; color: white; font-size: 12px; min-height: 32px; display: flex; align-items: center; justify-content: center; width: 100%; }
        .report-page { border: 1px solid #ccc; padding: 2rem; max-width: 800px; aspect-ratio: 210 / 297; margin: 2rem auto; background: white; display: flex; flex-direction: column; }
        
        /* Estilo para notificações customizadas */
        #notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.5s, transform 0.5s;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }

        /* Spinner para botões */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal customizado para confirmação */
        .confirm-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Inicia escondido */
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .confirm-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Área para notificações -->
    <div id="notification-area"></div>

    <!-- TELA DE AUTENTICAÇÃO -->
    <div id="auth-screen">
        <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4">
            <h1 class="text-4xl font-bold text-white mb-8">Relatórios Técnicos</h1>
            
            <!-- Formulário de Login -->
            <div id="login-form-container" class="w-full max-w-sm">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Acessar Conta</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-indigo-300 mb-2">Email</label>
                            <input type="email" id="login-email" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-indigo-300 mb-2">Senha</label>
                            <input type="password" id="login-password" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <button type="submit" class="w-full menu-button text-white font-bold py-3 px-6 rounded-xl text-lg">Entrar</button>
                    </form>
                    <p class="text-center text-gray-400 mt-6">
                        Não tem uma conta? <a href="#" id="show-register-link" class="text-indigo-300 hover:underline">Crie uma agora</a>
                    </p>
                </div>
            </div>

            <!-- Formulário de Cadastro -->
            <div id="register-form-container" class="w-full max-w-sm hidden">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Criar Nova Conta</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="register-name" class="block text-indigo-300 mb-2">Nome Completo</label>
                            <input type="text" id="register-name" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <div class="mb-4">
                            <label for="register-email" class="block text-indigo-300 mb-2">Email</label>
                            <input type="email" id="register-email" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="block text-indigo-300 mb-2">Senha</label>
                            <input type="password" id="register-password" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <button type="submit" class="w-full menu-button text-white font-bold py-3 px-6 rounded-xl text-lg">Criar Conta</button>
                    </form>
                    <p class="text-center text-gray-400 mt-6">
                        Já tem uma conta? <a href="#" id="show-login-link" class="text-indigo-300 hover:underline">Faça o login</a>
                    </p>
                </div>
            </div>

            <!-- Tela de Aguardando Aprovação -->
            <div id="pending-approval-container" class="w-full max-w-sm hidden">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold text-white mb-4">Aguardando Aprovação</h2>
                    <p class="text-indigo-300">Sua conta foi criada com sucesso e está aguardando a aprovação do administrador. Você será notificado por e-mail quando seu acesso for liberado.</p>
                     <button id="pending-back-to-login" class="mt-6 bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar para Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- APLICATIVO PRINCIPAL (INICIALMENTE ESCONDIDO) -->
    <div id="main-app-wrapper" class="hidden">
        <!-- TELA DO MENU PRINCIPAL -->
        <div id="menu-screen">
            <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4">
                <h1 class="text-4xl font-bold text-white mb-8">Painel de Controle</h1>
                
                <div class="mb-8 w-full max-w-sm">
                    <label for="company-select" class="block text-center text-lg text-indigo-300 mb-2">Selecione a Empresa</label>
                    <select id="company-select" class="w-full p-3 text-center rounded-lg border-2 border-indigo-400 bg-gray-700 text-white focus:outline-none focus:border-indigo-200">
                        <!-- Opções de empresa carregadas dinamicamente -->
                    </select>
                </div>

                <div class="w-full max-w-4xl flex flex-col gap-6 text-center">
                    <button id="admin-panel-btn" class="menu-button bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-xl text-lg hidden">PAINEL ADMIN</button>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                        <button id="cover-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">EDITAR CAPA</button>
                        <button id="index-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">ÍNDICE / EXPORTAR</button>
                        <button id="saved-reports-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">RELATÓRIOS SALVOS</button>
                        <button id="equipamentos-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">EQUIPAMENTOS</button>
                        <button id="profile-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">MEU PERFIL</button>
                    </div>
                </div>
                <div class="mt-12 text-center">
                    <p id="user-display-name" class="text-indigo-300 mb-2"></p>
                    <button id="logout-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Sair</button>
                </div>
            </div>
        </div>
        
        <!-- TELA DE PERFIL DO USUÁRIO -->
        <div id="profile-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto max-w-lg">
                <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">Meu Perfil</h1>
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <form id="profile-form">
                        <div class="mb-4">
                            <label for="profile-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                            <input type="text" id="profile-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-6">
                            <label for="profile-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="profile-email" disabled class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100 text-gray-500 cursor-not-allowed">
                        </div>
                        <div class="flex gap-4">
                            <button type="button" id="profile-back-to-menu-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition">Voltar ao Menu</button>
                            <button type="submit" id="profile-save-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- TELA DO PAINEL ADMIN -->
        <div id="admin-panel-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">Painel de Administração</h1>
                <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Usuários Pendentes -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-yellow-600">Usuários Pendentes</h2>
                        <div id="pending-users-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Lista de usuários pendentes será inserida aqui pelo JS -->
                        </div>
                    </div>
                    <!-- Usuários Ativos -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-green-600">Usuários Ativos</h2>
                        <div id="active-users-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Lista de usuários ativos será inserida aqui pelo JS -->
                        </div>
                    </div>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="admin-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar ao Menu</button>
                </div>
            </div>
        </div>


        <!-- TELA DE SELEÇÃO DE EQUIPAMENTOS -->
        <div id="equipamentos-screen" class="hidden">
            <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4">
                <h1 class="text-4xl font-bold text-white mb-8">Selecione o Equipamento</h1>
                <div class="w-full max-w-4xl">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 text-center">
                        <button id="gen-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">GERADOR</button>
                        <button id="transformer-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">TRAFO X3</button>
                        <button id="motor-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">MOTOR</button>
                        <button class="wip-btn menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">TRAFO INDUTOR</button>
                        <button class="wip-btn menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">TRAFO X6</button>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="equipamentos-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar ao Menu</button>
                </div>
            </div>
        </div>

        <!-- TELA DA CAPA DO RELATÓRIO -->
        <div id="cover-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-2xl font-bold text-center text-blue-800 mb-4">Editor da Capa do Relatório</h1>
                
                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center mb-8">
                    <button id="cover-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="manage-companies-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition w-full sm:w-auto">Gerenciar Empresas</button>
                    <button id="cover-save-report-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition w-full sm:w-auto">Salvar Relatório Completo</button>
                </div>

                <div class="max-w-2xl mx-auto bg-gray-50 p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-lg font-semibold mb-4 border-b pb-2">Informações da Capa</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="cover-cliente" class="block text-sm font-medium text-gray-700 mb-1">Empresa (Cliente)</label>
                            <input type="text" id="cover-cliente" placeholder="Ex: OCEANPACT" class="p-2 border rounded w-full">
                        </div>
                        <div>
                            <label for="cover-local" class="block text-sm font-medium text-gray-700 mb-1">Embarcação</label>
                            <input type="text" id="cover-local" placeholder="Ex: SEWARD JOHNSON" class="p-2 border rounded w-full">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Imagem do Equipamento</label>
                            <input type="file" id="cover-image-upload" class="hidden" accept="image/*">
                            <label for="cover-image-upload" class="w-full inline-block text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition cursor-pointer">
                                CARREGAR IMAGEM DO NAVIO
                            </label>
                        </div>
                    </div>
                </div>

                <div id="cover-preview" class="report-page">
                    <header class="flex justify-between items-start pb-4 border-b-2 border-black">
                        <img id="cover-preview-company-logo" src="" alt="Logo da Empresa" class="h-16 w-auto object-contain">
                        <div class="text-right text-xs">
                            <p class="font-bold" id="cover-preview-company-name"></p>
                            <p id="cover-preview-company-address"></p>
                            <p id="cover-preview-company-phones"></p>
                            <p id="cover-preview-company-phone2"></p>
                        </div>
                    </header>
                    <main class="flex-grow flex flex-col items-center justify-start text-center pt-16">
                        <div class="w-full">
                            <h1 id="cover-preview-cliente" class="text-3xl font-bold text-black">CLIENTE</h1>
                            <h2 id="cover-preview-local" class="text-2xl font-bold text-black mt-2">EMBARCAÇÃO</h2>
                        </div>
                        <div class="w-full mt-8 pt-4 border-t-2 border-black">
                            <p class="mt-2 text-lg">Relatório técnico de medição de resistência de isolamento elétrico (Megagem)</p>
                            <img id="cover-preview-image" src="" alt="Imagem da Embarcação" class="mt-4 max-w-md w-full h-auto object-cover rounded-md shadow-lg mx-auto">
                        </div>
                    </main>
                    <footer class="mt-auto pt-4">
                        <div id="cover-preview-rep-logos" class="flex justify-center items-center gap-8 mb-2">
                            <img id="cover-preview-rep-logo1" src="" class="h-10 w-auto object-contain">
                            <img id="cover-preview-rep-logo2" src="" class="h-10 w-auto object-contain">
                        </div>
                        <p class="text-center text-xs text-gray-600">Conformidade com as normas ABNT NBR5383-1, IEEE43 e IEC 60034-27-4</p>
                    </footer>
                </div>
            </div>
        </div>

        <!-- TELA DO ÍNDICE -->
        <div id="index-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-2xl font-bold text-center text-blue-800 mb-4">Índice do Relatório</h1>

                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center mb-8">
                    <button id="index-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="save-full-report-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition w-full sm:w-auto">Salvar Relatório Completo</button>
                    <button id="export-current-pdf-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">Exporta Relatório Atual</button>
                </div>

                <div id="index-page" class="report-page">
                    <header class="flex justify-between items-start">
                        <img id="index-company-logo" src="" alt="Logo da Empresa" class="h-20 w-auto object-contain">
                        <div class="text-right text-xs">
                            <p class="font-bold" id="index-company-name"></p>
                            <p id="index-company-address"></p>
                            <p id="index-company-phones"></p>
                            <p id="index-company-phone2"></p>
                        </div>
                    </header>
                    <main id="index-content-list" class="flex-grow p-4">
                        <!-- Conteúdo do índice será carregado -->
                    </main>
                     <footer class="mt-auto pt-4">
                        <div id="index-rep-logos" class="flex justify-center items-center gap-8 mb-4">
                            <img id="index-rep-logo1" src="" class="h-12 w-auto object-contain">
                            <img id="index-rep-logo2" src="" class="h-12 w-auto object-contain">
                        </div>
                        <p class="text-center text-xs text-gray-600">Conformidade com as normas ABNT NBR5383-1, IEEE43 e IEC 60034-27-4</p>
                    </footer>
                </div>
            </div>
        </div>

        <!-- TELA DE RELATÓRIOS SALVOS -->
        <div id="saved-reports-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-2xl font-bold text-center text-blue-800 mb-4">Relatórios Salvos</h1>
                <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md">
                    <div id="saved-reports-list" class="space-y-3">
                        <!-- A lista de relatórios salvos será inserida aqui -->
                    </div>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="saved-reports-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar ao Menu</button>
                </div>
            </div>
        </div>

        <!-- TELA DE GERENCIAMENTO DE EMPRESAS -->
        <div id="company-management-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-2xl font-bold text-center text-blue-800 mb-6">Gerenciar Empresas</h1>
                <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Formulário de Adicionar/Editar -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 id="company-form-title" class="text-xl font-semibold mb-4">Adicionar Nova Empresa</h2>
                        <form id="company-form" class="space-y-4">
                            <input type="hidden" id="company-id">
                            <div>
                                <label for="company-name" class="block text-sm font-medium text-gray-700">Nome da Empresa</label>
                                <input type="text" id="company-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="company-address" class="block text-sm font-medium text-gray-700">Endereço</label>
                                <input type="text" id="company-address" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Rua, Número, Bairro, Cidade, Estado">
                            </div>
                            <div>
                                <label for="company-phones" class="block text-sm font-medium text-gray-700">Telefone 1</label>
                                <input type="text" id="company-phones" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="company-phone2" class="block text-sm font-medium text-gray-700">Telefone 2</label>
                                <input type="text" id="company-phone2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Logo da Empresa</label>
                                <input type="file" id="company-logo-upload" class="hidden" accept="image/*">
                                <label for="company-logo-upload" class="mt-1 w-full inline-block text-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition cursor-pointer">
                                    CARREGAR LOGO
                                </label>
                                <img id="company-logo-preview" src="" alt="Preview da Logo" class="mt-2 h-16 w-auto mx-auto hidden">
                            </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Logo Rep. 1</label>
                                    <input type="file" id="company-rep-logo1-upload" class="hidden" accept="image/*">
                                    <label for="company-rep-logo1-upload" class="mt-1 w-full inline-block text-center bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition cursor-pointer text-xs">LOGO REP. 1</label>
                                    <img id="company-rep-logo1-preview" src="" class="mt-2 h-12 w-auto mx-auto hidden">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Logo Rep. 2</label>
                                    <input type="file" id="company-rep-logo2-upload" class="hidden" accept="image/*">
                                    <label for="company-rep-logo2-upload" class="mt-1 w-full inline-block text-center bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition cursor-pointer text-xs">LOGO REP. 2</label>
                                    <img id="company-rep-logo2-preview" src="" class="mt-2 h-12 w-auto mx-auto hidden">
                                </div>
                            </div>
                            <!-- Checkbox para status público (só para admins) -->
                            <div id="company-public-toggle-container" class="hidden pt-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="company-is-public" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-900 font-medium">Empresa Pública (visível para todos)</span>
                                </label>
                            </div>
                            <div class="flex gap-4">
                                <button type="submit" id="company-form-submit-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Adicionar Empresa</button>
                                <button type="button" id="company-form-cancel-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition hidden">Cancelar Edição</button>
                            </div>
                        </form>
                    </div>
                    <!-- Lista de Empresas -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Empresas Cadastradas</h2>
                        <div id="company-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Lista de empresas será renderizada aqui -->
                        </div>
                    </div>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="company-management-back-to-cover-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar para a Capa</button>
                </div>
            </div>
        </div>

        <!-- TELA DA PLANILHA DO GERADOR -->
        <div id="generator-app-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div id="gen-app-container" class="container mx-auto p-2 sm:p-4 md:p-6 bg-white shadow-lg my-4 sm:my-8">
                <header class="border-b-2 border-gray-200 pb-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 id="gen-company-name-header" class="text-xl sm:text-2xl font-bold text-blue-800"></h1>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-3">
                        <div class="header-info"><label>CLIENTE:</label> <input type="text" id="gen-cliente" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>EQUIP.:</label> <input type="text" id="gen-equipamento" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>Nº SÉRIE:</label> <input type="text" id="gen-numeroSerie" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>LOCAL:</label> <input type="text" id="gen-local" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>AVR:</label> <input type="text" id="gen-avr" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>TENSÃO:</label> <input type="text" id="gen-tensao" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>POTÊNCIA:</label> <input type="text" id="gen-potencia" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info sm:col-span-2 lg:col-span-1"><label>DATA:</label> <input type="date" id="gen-data" class="border rounded px-2 py-1 w-full"></div>
                    </div>
                </header>

                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center my-4 pdf-hide">
                    <button id="gen-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="gen-fillTestData" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">Preencher Exemplo</button>
                    <button id="gen-clearForm" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition w-full sm:w-auto">Limpar</button>
                    <button id="gen-add-sheet-btn" class="menu-button text-white font-bold py-2 px-6 rounded-lg transition w-full sm:w-auto" disabled>Adicionar ao Relatório</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div class="flex items-center gap-2">
                        <label for="gen-tempAmbiente" class="font-semibold">Temp. Amb. (°C):</label>
                        <input type="number" id="gen-tempAmbiente" class="input-yellow w-full">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="gen-tempEnrolamento" class="font-semibold">Temp. Enrol. (°C):</label>
                        <input type="number" id="gen-tempEnrolamento" class="input-yellow w-full" placeholder="Essencial">
                    </div>
                    <div class="flex items-center gap-2 sm:col-span-2 md:col-span-1">
                        <label for="gen-umidadeRelativa" class="font-semibold">Umidade (%):</label>
                        <input type="number" id="gen-umidadeRelativa" class="input-yellow w-full">
                    </div>
                </div>
                
                <div id="gen-main-sections-container"></div>
                <div class="text-center my-4 flex justify-center flex-wrap gap-4 pdf-hide">
                    <button id="gen-togglePmg" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Ativar Seção PMG</button>
                    <button id="gen-toggleDiodes" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Ativar Diodos D7-D12</button>
                </div>
                <div id="gen-pmg-section-container" class="hidden"></div>
                <div id="gen-extra-sections-container"></div>
            </div>
        </div>
        
        <!-- TELA DA PLANILHA DO MOTOR -->
        <div id="motor-app-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div id="motor-app-container" class="container mx-auto p-2 sm:p-4 md:p-6 bg-white shadow-lg my-4 sm:my-8">
                <header class="border-b-2 border-gray-200 pb-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 id="motor-company-name-header" class="text-xl sm:text-2xl font-bold text-blue-800"></h1>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-3">
                        <div class="header-info"><label>CLIENTE:</label> <input type="text" id="motor-cliente" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>LOCAL:</label> <input type="text" id="motor-local" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>DATA:</label> <input type="date" id="motor-data" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>EQUIP.:</label> <input type="text" id="motor-equipamento" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>Nº SÉRIE:</label> <input type="text" id="motor-numeroSerie" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>FAB./MODELO:</label> <input type="text" id="motor-fabricante" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>TENSÃO:</label> <input type="text" id="motor-tensao" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>POTÊNCIA:</label> <input type="text" id="motor-potencia" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>ROTAÇÃO:</label> <input type="text" id="motor-rotacao" class="border rounded px-2 py-1 w-full"></div>
                    </div>
                </header>

                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center my-4 pdf-hide">
                    <button id="motor-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="motor-fillTestData" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">Preencher Exemplo</button>
                    <button id="motor-clearForm" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition w-full sm:w-auto">Limpar</button>
                    <button id="motor-add-sheet-btn" class="menu-button text-white font-bold py-2 px-6 rounded-lg transition w-full sm:w-auto" disabled>Adicionar ao Relatório</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div class="flex items-center gap-2">
                        <label for="motor-tempAmbiente" class="font-semibold">Temp. Amb. (°C):</label>
                        <input type="number" id="motor-tempAmbiente" class="input-yellow w-full">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="motor-tempEnrolamento" class="font-semibold">Temp. Enrol. (°C):</label>
                        <input type="number" id="motor-tempEnrolamento" class="input-yellow w-full" placeholder="Essencial">
                    </div>
                    <div class="flex items-center gap-2 sm:col-span-2 md:col-span-1">
                        <label for="motor-umidadeRelativa" class="font-semibold">Umidade (%):</label>
                        <input type="number" id="motor-umidadeRelativa" class="input-yellow w-full">
                    </div>
                </div>
                
                <div id="motor-sections-container"></div>
            </div>
        </div>

        <!-- TELA DA PLANILHA DO TRANSFORMADOR X3 -->
        <div id="transformer-app-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div id="transformer-app-container" class="container mx-auto p-2 sm:p-4 md:p-6 bg-white shadow-lg my-4 sm:my-8">
                <header class="border-b-2 border-gray-200 pb-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 id="transformer-company-name-header" class="text-xl sm:text-2xl font-bold text-blue-800"></h1>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-3">
                        <div class="header-info"><label>CLIENTE:</label> <input type="text" id="transformer-cliente" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>LOCAL:</label> <input type="text" id="transformer-local" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>DATA:</label> <input type="date" id="transformer-data" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>EQUIP.:</label> <input type="text" id="transformer-equipamento" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>Nº SÉRIE:</label> <input type="text" id="transformer-numeroSerie" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>FAB./MODELO:</label> <input type="text" id="transformer-fabricante" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>TENSÃO:</label> <input type="text" id="transformer-tensao" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>POTÊNCIA:</label> <input type="text" id="transformer-potencia" class="border rounded px-2 py-1 w-full"></div>
                    </div>
                </header>

                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center my-4 pdf-hide">
                    <button id="transformer-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="transformer-fillTestData" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">Preencher Exemplo</button>
                    <button id="transformer-clearForm" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition w-full sm:w-auto">Limpar</button>
                    <button id="transformer-add-sheet-btn" class="menu-button text-white font-bold py-2 px-6 rounded-lg transition w-full sm:w-auto" disabled>Adicionar ao Relatório</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div class="flex items-center gap-2">
                        <label for="transformer-tempAmbiente" class="font-semibold">Temp. Amb. (°C):</label>
                        <input type="number" id="transformer-tempAmbiente" class="input-yellow w-full">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="transformer-tempTrafo" class="font-semibold">Temp. no Trafo (°C):</label>
                        <input type="number" id="transformer-tempTrafo" class="input-yellow w-full" placeholder="Essencial">
                    </div>
                    <div class="flex items-center gap-2 sm:col-span-2 md:col-span-1">
                        <label for="transformer-umidadeRelativa" class="font-semibold">Umidade (%):</label>
                        <input type="number" id="transformer-umidadeRelativa" class="input-yellow w-full">
                    </div>
                </div>
                
                <div id="transformer-sections-container"></div>
            </div>
        </div>

        <!-- Modal de WIP -->
        <div id="wip-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
                <h3 class="text-xl font-bold text-blue-800 mb-4">Em Desenvolvimento</h3>
                <p class="text-gray-700 mb-6">Esta funcionalidade estará disponível em breve!</p>
                <button id="close-wip-modal" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Fechar</button>
            </div>
        </div>
        <div id="pdf-loader-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center text-center text-white p-8 z-[200]">
            <div>
                <svg class="animate-spin h-10 w-10 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <h2 class="text-2xl font-bold">Gerando Relatório em PDF...</h2>
                <p class="text-lg mt-2">Isso pode levar alguns segundos. Por favor, aguarde.</p>
            </div>
        </div>
    </div>

<script type="module">
    // Importações dos módulos do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Módulo de serviço do Firebase
    const firebaseService = {
        auth: null,
        db: null,
        init: function() {
            const firebaseConfig = {
                apiKey: "AIzaSyAoPtdpU3MYRUCdj0dvn1LHYBv-ESWWH80", // CHAVE DE API ATUALIZADA AQUI!
                authDomain: "relatorios-tecnicos-app.firebaseapp.com",
                projectId: "relatorios-tecnicos-app",
                storageBucket: "relatorios-tecnicos-app.appspot.com",
                messagingSenderId: "280958854421",
                appId: "1:280958854421:web:90e4b288f3c57592d9351c"
            };

            if (firebaseConfig.apiKey.startsWith("SUA_")) {
                console.error("CONFIGURAÇÃO DO FIREBASE INCOMPLETA. Substitua os placeholders pelas suas credenciais reais.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            this.auth = getAuth(app);
            this.db = getFirestore(app);
        },
        getAuth: function() { return this.auth; },
        getDb: function() { return this.db; }
    };
    
    // Objeto de Estado Centralizado
    const appState = {
        user: { id: null, isAdmin: false, displayName: null, email: null },
        company: { list: [], selected: null },
        currentReport: { cache: [], editingIndex: null, coverImage: null },
        ui: { temporaryCompanyLogo: null, temporaryRepLogo1: null, temporaryRepLogo2: null }
    };


document.addEventListener('DOMContentLoaded', () => {
    firebaseService.init();

    if (!firebaseService.auth) {
        const authScreen = document.getElementById('auth-screen');
        if (authScreen) {
            authScreen.innerHTML = `
                <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4 text-white text-center">
                    <h1 class="text-2xl font-bold text-red-500">Erro de Configuração</h1>
                    <p class="mt-4">As credenciais do Firebase não foram configuradas corretamente no código-fonte.</p>
                </div>`;
            authScreen.style.display = 'block';
        }
        return;
    }

    // ==================================================================================
    // --- MÓDULO DE NAVEGAÇÃO ---
    // ==================================================================================
    
    const navigation = {
        screens: {    
            menu: document.getElementById('menu-screen'),    
            cover: document.getElementById('cover-screen'),    
            index: document.getElementById('index-screen'),    
            savedReports: document.getElementById('saved-reports-screen'),
            companyManagement: document.getElementById('company-management-screen'),
            equipamentos: document.getElementById('equipamentos-screen'),
            gen: document.getElementById('generator-app-screen'),    
            motor: document.getElementById('motor-app-screen'),    
            transformer: document.getElementById('transformer-app-screen'),    
            adminPanel: document.getElementById('admin-panel-screen'),
            profile: document.getElementById('profile-screen'),    
        },
        currentScreen: null,
        to: function(screenName, updateHistory = true) {
            const newScreenElement = this.screens[screenName];
            if (!newScreenElement || newScreenElement === this.currentScreen) return;
            Object.values(this.screens).forEach(screen => { if (screen) screen.classList.add('hidden'); });
            newScreenElement.classList.remove('hidden');
            this.currentScreen = newScreenElement;
            if (updateHistory && history.state?.screen !== screenName) {
                history.pushState({ screen: screenName }, '', `#${screenName}`);
            }
        },
        init: function() {
            const initialScreenName = window.location.hash.substring(1) || 'menu';
            this.to(initialScreenName, false);
            history.replaceState({ screen: initialScreenName }, '', `#${initialScreenName}`);
            window.addEventListener('popstate', (event) => {
                const screen = event.state ? event.state.screen : 'menu';
                this.to(screen, false);
            });
        },
        checkDirtyStateAndNavigate: async function(targetScreen) {
            const currentScreenElement = this.currentScreen;
            if (currentScreenElement) {
                const appContainer = currentScreenElement.querySelector('[id$="-app-container"]');
                if (appContainer && isFormDirty(appContainer)) {
                    const userConfirmed = await uiFeedback.showConfirm('Você tem alterações não salvas. Deseja sair mesmo assim?');
                    if (!userConfirmed) return;
                }
            }
            this.to(targetScreen);
        }
    };

    // ==================================================================================
    // --- MÓDULO DE UI E FEEDBACK ---
    // ==================================================================================

    const uiFeedback = {
        toggleButtonLoading: function(button, isLoading) {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalContent = button.innerHTML;
                button.innerHTML = '<div class="spinner mx-auto"></div>';
            } else {
                button.disabled = false;
                if (button.dataset.originalContent) {
                    button.innerHTML = button.dataset.originalContent;
                }
            }
        },
        showToast: function(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            notificationArea.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 500);
            }, 3000);
        },
        showConfirm: function(message) {
            return new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.className = 'confirm-modal-overlay';
                overlay.style.display = 'flex';
                
                const content = document.createElement('div');
                content.className = 'confirm-modal-content';
                
                const messageEl = document.createElement('p');
                messageEl.textContent = message;
                messageEl.className = 'text-lg mb-6';

                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex justify-center gap-4';

                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.className = 'bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition';
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancelar';
                cancelBtn.className = 'bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition';

                const removeModal = () => document.body.removeChild(overlay);

                confirmBtn.onclick = () => {
                    removeModal();
                    resolve(true);
                };
                cancelBtn.onclick = () => {
                    removeModal();
                    resolve(false);
                };

                btnContainer.append(cancelBtn, confirmBtn);
                content.append(messageEl, btnContainer);
                overlay.appendChild(content);
                document.body.appendChild(overlay);
            });
        }
    };

    // ==================================================================================
    // --- LÓGICA DE AUTENTICAÇÃO E ADMINISTRAÇÃO ---
    // ==================================================================================

    const authScreen = document.getElementById('auth-screen');
    const mainAppWrapper = document.getElementById('main-app-wrapper');
    const adminPanelBtn = document.getElementById('admin-panel-btn');
    const userDisplayNameEl = document.getElementById('user-display-name');

    let userStatusUnsubscribe = null;
    let isAppInitialized = false;

    onAuthStateChanged(firebaseService.getAuth(), (user) => {
        if (userStatusUnsubscribe) {
            userStatusUnsubscribe();
        }

        if (user) {
            const userDocRef = doc(firebaseService.getDb(), "users", user.uid);
            
            userStatusUnsubscribe = onSnapshot(userDocRef, (userDocSnap) => {
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    
                    if (userData.status === 'approved') {
                        appState.user.id = user.uid;
                        appState.user.isAdmin = userData.role === 'admin';
                        appState.user.displayName = userData.displayName || '';
                        appState.user.email = userData.email || '';
                        userDisplayNameEl.textContent = `Olá, ${appState.user.displayName || appState.user.email}`;

                        authScreen.classList.add('hidden');
                        mainAppWrapper.classList.remove('hidden');
                        adminPanelBtn.classList.toggle('hidden', !appState.user.isAdmin);

                        if (!isAppInitialized) {
                            loadAllCompanies().then(() => {
                                populateCompanyDropdown();
                                navigation.init();
                                isAppInitialized = true;
                            });
                        }
                    } else {
                        const message = userData.status === 'pending' ? 'Sua conta está aguardando aprovação.' : 'Seu acesso foi recusado.';
                        uiFeedback.showToast(message, 'info');
                        showAuthForm(userData.status === 'pending' ? 'pending' : 'login');
                        signOut(firebaseService.getAuth());
                    }
                } else {
                    // Este caso pode acontecer brevemente durante o registo, antes do documento ser criado.
                    // Não fazemos nada aqui para permitir que o processo de registo crie o documento.
                }
            }, (error) => {
                console.error("Erro ao escutar status do usuário:", error);
                uiFeedback.showToast('Erro de conexão. Verifique sua internet.', 'error');
                signOut(firebaseService.getAuth());
            });
        } else {
            appState.user.id = null;
            appState.user.isAdmin = false;
            appState.user.displayName = null;
            appState.user.email = null;
            userDisplayNameEl.textContent = '';
            authScreen.classList.remove('hidden');
            mainAppWrapper.classList.add('hidden');
            showAuthForm('login');
            navigation.currentScreen = null;
            isAppInitialized = false;
        }
    });


    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        signInWithEmailAndPassword(firebaseService.getAuth(), email, password)
            .then(() => uiFeedback.showToast('Login bem-sucedido! Verificando acesso...', 'success'))
            .catch(() => uiFeedback.showToast('E-mail ou senha inválidos.', 'error'));
    });

    // CORREÇÃO FINAL: Lógica de registo com tratamento de erros aprimorado.
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        
        try {
            // Etapa 1: Criar o utilizador na Autenticação do Firebase.
            // Esta função também faz o login do novo utilizador automaticamente.
            const userCredential = await createUserWithEmailAndPassword(firebaseService.getAuth(), email, password);
            const user = userCredential.user;

            // Etapa 2: Criar o documento correspondente no Firestore.
            // Isto acontece enquanto o novo utilizador está logado, permitindo que a regra de segurança funcione.
            const userDocRef = doc(firebaseService.getDb(), "users", user.uid);
            await setDoc(userDocRef, {    
                uid: user.uid,    
                email: user.email,    
                displayName: name,    
                role: 'user',    
                status: 'pending',    
                createdAt: new Date().toISOString()    
            });

            // Se tudo correu bem, mostra a tela de pendente.
            showAuthForm('pending');

        } catch (error) {
            // Tratamento de erros detalhado.
            console.error("Erro detalhado no registo:", error.code, error.message);
            let userMessage = "Ocorreu um erro ao criar a conta. Tente novamente.";
            
            if (error.code === 'auth/email-already-in-use') {
                userMessage = "Este e-mail já está registado. Tente fazer o login.";
            } else if (error.code === 'auth/weak-password') {
                userMessage = "A senha é muito fraca. Use pelo menos 6 caracteres.";
            } else if (error.code === 'auth/invalid-email') {
                userMessage = "O formato do e-mail é inválido.";
            } else if (error.code === 'permission-denied') {
                userMessage = "Falha ao criar registo de utilizador. Verifique as regras de segurança do Firestore.";
            }
            
            uiFeedback.showToast(userMessage, 'error');
        } finally {
            // Etapa 3: Independentemente do sucesso ou falha, deslogamos o utilizador
            // para que ele não fique numa sessão ativa sem um status 'approved'.
            if (firebaseService.getAuth().currentUser) {
                await signOut(firebaseService.getAuth());
            }
        }
    });
    
    adminPanelBtn.addEventListener('click', async () => {
        navigation.to('adminPanel');
        await loadAdminPanelData();
    });

    async function loadAdminPanelData() {
        const pendingListEl = document.getElementById('pending-users-list');
        const activeListEl = document.getElementById('active-users-list');
        pendingListEl.innerHTML = '<p>Carregando...</p>';
        activeListEl.innerHTML = '<p>Carregando...</p>';

        const createUserRow = (user, isPending) => {
            const userEl = document.createElement('div');
            userEl.className = 'flex items-center justify-between p-2 border rounded-md';

            const userInfoContainer = document.createElement('div');
            const userInfo = document.createElement('span');
            userInfo.className = 'text-sm truncate';
            userInfo.title = user.email;

            const strong = document.createElement('strong');
            strong.className = 'block';
            strong.textContent = user.displayName || '';
            userInfo.appendChild(strong);
            userInfo.append(document.createTextNode(user.email));

            userInfoContainer.appendChild(userInfo);

            if (!isPending) {
                const roleBadge = document.createElement('span');
                roleBadge.className = `text-xs ml-2 px-2 py-0.5 rounded-full ${user.role === 'admin' ? 'bg-yellow-200 text-yellow-800' : 'bg-blue-200 text-blue-800'}`;
                roleBadge.textContent = user.role;
                userInfoContainer.appendChild(roleBadge);
            }

            const buttons = document.createElement('div');
            buttons.className = 'flex gap-2';

            if (isPending) {
                buttons.innerHTML = `
                    <button data-uid="${user.uid}" data-action="approve" class="bg-green-500 text-white px-2 py-1 text-xs rounded hover:bg-green-600">Aprovar</button>
                    <button data-uid="${user.uid}" data-action="deny" class="bg-orange-500 text-white px-2 py-1 text-xs rounded hover:bg-orange-600">Recusar</button>`;
            } else {
                buttons.innerHTML = `<button data-uid="${user.uid}" data-action="delete" class="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">Excluir</button>`;
            }

            userEl.append(userInfoContainer, buttons);
            return userEl;
        };

        try {
            const db = firebaseService.getDb();
            const pendingQuery = query(collection(db, "users"), where("status", "==", "pending"));
            const pendingSnapshot = await getDocs(pendingQuery);
            pendingListEl.innerHTML = '';
            if (pendingSnapshot.empty) {
                pendingListEl.innerHTML = '<p class="text-gray-500">Nenhum usuário pendente.</p>';
            } else {
                pendingSnapshot.forEach(doc => pendingListEl.appendChild(createUserRow(doc.data(), true)));
            }

            const activeQuery = query(collection(db, "users"), where("status", "==", "approved"));
            const activeSnapshot = await getDocs(activeQuery);
            activeListEl.innerHTML = '';
            if (activeSnapshot.empty) {
                activeListEl.innerHTML = '<p class="text-gray-500">Nenhum usuário ativo.</p>';
            } else {
                activeSnapshot.forEach(doc => activeListEl.appendChild(createUserRow(doc.data(), false)));
            }
        } catch (error) {
            console.error("Erro ao carregar dados do admin:", error);
            uiFeedback.showToast('Erro ao carregar dados do painel.', 'error');
        }
    }

    document.getElementById('admin-panel-screen').addEventListener('click', async (e) => {
        const target = e.target;
        if (target.tagName === 'BUTTON' && target.dataset.uid) {
            const uid = target.dataset.uid;
            const action = target.dataset.action;
            const userDocRef = doc(firebaseService.getDb(), "users", uid);
            let confirmed = true;

            if (action === 'deny' || action === 'delete') {
                const message = action === 'delete' ? 'Tem certeza? Ação irreversível.' : 'Tem certeza que deseja recusar este usuário?';
                confirmed = await uiFeedback.showConfirm(message);
            }

            if (confirmed) {
                try {
                    if (action === 'approve') { await updateDoc(userDocRef, { status: 'approved' }); uiFeedback.showToast('Usuário aprovado!', 'success'); }    
                    else if (action === 'deny') { await updateDoc(userDocRef, { status: 'denied' }); uiFeedback.showToast('Usuário recusado.', 'info'); }    
                    else if (action === 'delete') { await deleteDoc(userDocRef); uiFeedback.showToast('Usuário excluído.', 'info'); }
                    if (action) await loadAdminPanelData();
                } catch (error) {
                    console.error(`Erro na ação '${action}':`, error);
                    uiFeedback.showToast('Ocorreu um erro ao processar a ação.', 'error');
                }
            }
        }
    });

    function showAuthForm(formName) {
        document.getElementById('login-form-container').classList.add('hidden');
        document.getElementById('register-form-container').classList.add('hidden');
        document.getElementById('pending-approval-container').classList.add('hidden');
        const el = document.getElementById(`${formName}-form-container`) || document.getElementById(`${formName}-container`);
        if(el) el.classList.remove('hidden');
    }
    
    document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('register'); });
    document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });
    document.getElementById('pending-back-to-login').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });
    document.getElementById('logout-btn').addEventListener('click', () => {
        signOut(firebaseService.getAuth()).catch((error) => {
            console.error("Logout error:", error);
            uiFeedback.showToast('Ocorreu um erro ao sair.', 'error');
        });
    });
    
    // ==================================================================================
    // --- LÓGICA DO PERFIL DO USUÁRIO ---
    // ==================================================================================

    function populateProfileScreen() {
        document.getElementById('profile-name').value = appState.user.displayName || '';
        document.getElementById('profile-email').value = appState.user.email || '';
    }

    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = document.getElementById('profile-save-btn');
        const newName = document.getElementById('profile-name').value.trim();

        if (newName.length < 3) {
             uiFeedback.showToast('O nome deve ter pelo menos 3 caracteres.', 'error');
             return;
        }

        if (newName === appState.user.displayName) {
            uiFeedback.showToast('Nenhuma alteração detectada.', 'info');
            navigation.to('menu');
            return;
        }

        uiFeedback.toggleButtonLoading(button, true);

        try {
            const userDocRef = doc(firebaseService.getDb(), "users", appState.user.id);
            await updateDoc(userDocRef, {
                displayName: newName
            });
            appState.user.displayName = newName;
            uiFeedback.showToast('Perfil atualizado com sucesso!', 'success');
            navigation.to('menu');
        } catch (error) {
            console.error("Erro ao atualizar perfil:", error);
            uiFeedback.showToast('Não foi possível atualizar o perfil.', 'error');
        } finally {
            uiFeedback.toggleButtonLoading(button, false);
        }
    });

    // ==================================================================================
    // --- LÓGICA DE GERENCIAMENTO DE EMPRESAS ---
    // ==================================================================================

    async function getPrivateCompanies() {
        if (!appState.user.id) return [];
        const db = firebaseService.getDb();
        const docRef = doc(db, "users", appState.user.id, "data", "companies");
        const docSnap = await getDoc(docRef);
        return docSnap.exists() && docSnap.data().list ? docSnap.data().list : [];
    }

    async function getPublicCompanies() {
        const db = firebaseService.getDb();
        const docRef = doc(db, "public_data", "companies");
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists() && appState.user.isAdmin) {
            const defaultPublicCompanies = [
                { id: 'unitech', name: 'UNITECH-NIT', address: 'Rua Galvão Nº 28, Barreto – Niterói – Rio de Janeiro', phones: 'Telefones: (21) 96762-2155 / (21) 97119-2155', phone2: '(21)2608-4184', logoDataUrl: null, repLogo1DataUrl: null, repLogo2DataUrl: null, isPublic: true },
                { id: 'power', name: 'POWER', address: 'Endereço da Power', phones: 'Telefone da Power', phone2: '', logoDataUrl: null, repLogo1DataUrl: null, repLogo2DataUrl: null, isPublic: true },
                { id: 'unitedpower', name: 'UNITEDPOWER', address: 'Endereço da United Power', phones: 'Telefone da United Power', phone2: '', logoDataUrl: null, repLogo1DataUrl: null, repLogo2DataUrl: null, isPublic: true }
            ];
            await setDoc(docRef, { list: defaultPublicCompanies });
            return defaultPublicCompanies;
        }
        
        return docSnap.exists() && docSnap.data().list ? docSnap.data().list : [];
    }

    async function loadAllCompanies() {
        const privateCompanies = await getPrivateCompanies();
        const publicCompanies = await getPublicCompanies();
        appState.company.list = [...publicCompanies, ...privateCompanies];
    }

    async function savePrivateCompanies(companies) {
        if (!appState.user.id) return;
        const privateCompanies = companies.filter(c => !c.isPublic);
        const db = firebaseService.getDb();
        const docRef = doc(db, "users", appState.user.id, "data", "companies");
        await setDoc(docRef, { list: privateCompanies });
    }

    async function savePublicCompanies(companies) {
        if (!appState.user.isAdmin) return;
        const publicCompanies = companies.filter(c => c.isPublic);
        const db = firebaseService.getDb();
        const docRef = doc(db, "public_data", "companies");
        await setDoc(docRef, { list: publicCompanies });
    }
    
    // Função helper para salvar ambas as listas de uma vez
    async function saveAllCompanies(companies) {
        await Promise.all([
            savePublicCompanies(companies),
            savePrivateCompanies(companies)
        ]);
    }

    // ==================================================================================
    // --- LÓGICA PRINCIPAL DO APLICATIVO (RELATÓRIOS, PLANILHAS, ETC.) ---
    // ==================================================================================

    // ... (O restante do código das planilhas, que não precisa de alterações, continua aqui)
    // ... (Para manter a resposta concisa, o código das planilhas foi omitido, mas ele deve ser mantido no seu arquivo)

    // ==================================================================================
    // --- EVENT LISTENERS E INICIALIZAÇÃO ---
    // ==================================================================================
    
    document.getElementById('company-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = e.target.querySelector('button[type="submit"]');
        const companyId = document.getElementById('company-id').value;
        const companyName = document.getElementById('company-name').value.trim();

        // Validação de entrada
        if (companyName.length < 3 || companyName.length > 100) {
            uiFeedback.showToast('O nome da empresa deve ter entre 3 e 100 caracteres.', 'error');
            return;
        }

        uiFeedback.toggleButtonLoading(button, true);

        const newCompanyData = {
            name: companyName,
            address: document.getElementById('company-address').value,
            phones: document.getElementById('company-phones').value,
            phone2: document.getElementById('company-phone2').value,
            logoDataUrl: appState.ui.temporaryCompanyLogo,
            repLogo1DataUrl: appState.ui.temporaryRepLogo1,
            repLogo2DataUrl: appState.ui.temporaryRepLogo2,
            isPublic: document.getElementById('company-is-public').checked
        };

        try {
            if (companyId) { // Editando
                const companyIndex = appState.company.list.findIndex(c => c.id === companyId);
                if (companyIndex > -1) {
                    const oldCompany = appState.company.list[companyIndex];
                    if (!newCompanyData.logoDataUrl) newCompanyData.logoDataUrl = oldCompany.logoDataUrl;
                    if (!newCompanyData.repLogo1DataUrl) newCompanyData.repLogo1DataUrl = oldCompany.repLogo1DataUrl;
                    if (!newCompanyData.repLogo2DataUrl) newCompanyData.repLogo2DataUrl = oldCompany.repLogo2DataUrl;
                    appState.company.list[companyIndex] = { ...oldCompany, ...newCompanyData };
                    uiFeedback.showToast('Empresa atualizada!', 'success');
                }
            } else { // Adicionando
                newCompanyData.id = Date.now().toString();
                appState.company.list.push(newCompanyData);
                uiFeedback.showToast('Empresa adicionada!', 'success');
            }

            await saveAllCompanies(appState.company.list);
            
            renderCompanyList();
            populateCompanyDropdown();
            resetCompanyForm();
        } catch (error) {
            console.error("Erro ao salvar empresa:", error);
            uiFeedback.showToast('Erro ao salvar empresa.', 'error');
        } finally {
            uiFeedback.toggleButtonLoading(button, false);
        }
    });

    document.getElementById('company-list').addEventListener('click', async (e) => {
        const editButton = e.target.closest('[data-edit-id]');
        const deleteButton = e.target.closest('[data-delete-id]');

        if (editButton) {
            const editId = editButton.dataset.editId;
            const companyToEdit = appState.company.list.find(c => c.id === editId);
            if (companyToEdit) {
                document.getElementById('company-id').value = companyToEdit.id;
                document.getElementById('company-name').value = companyToEdit.name;
                document.getElementById('company-address').value = companyToEdit.address || '';
                document.getElementById('company-phones').value = companyToEdit.phones || '';
                document.getElementById('company-phone2').value = companyToEdit.phone2 || '';
                document.getElementById('company-is-public').checked = companyToEdit.isPublic || false;
                
                const showPreview = (previewId, url) => {
                    const el = document.getElementById(previewId);
                    el.src = url || '';
                    el.classList.toggle('hidden', !url);
                };
                showPreview('company-logo-preview', companyToEdit.logoDataUrl);
                showPreview('company-rep-logo1-preview', companyToEdit.repLogo1DataUrl);
                showPreview('company-rep-logo2-preview', companyToEdit.repLogo2DataUrl);
                
                document.getElementById('company-form-title').textContent = 'Editar Empresa';
                document.getElementById('company-form-submit-btn').textContent = 'Salvar Alterações';
                document.getElementById('company-form-cancel-btn').classList.remove('hidden');
            }
        }

        if (deleteButton) {
            const deleteId = deleteButton.dataset.deleteId;
            const confirmed = await uiFeedback.showConfirm('Tem certeza que deseja apagar esta empresa?');
            if (confirmed) {
                appState.company.list = appState.company.list.filter(c => c.id !== deleteId);
                await saveAllCompanies(appState.company.list);
                renderCompanyList();
                populateCompanyDropdown();
                resetCompanyForm();    
                uiFeedback.showToast('Empresa apagada.', 'info');
            }
        }
    });

    document.getElementById('company-list').addEventListener('change', async (e) => {
        const toggleInput = e.target.closest('[data-toggle-public-id]');
        if (toggleInput) {
            const companyId = toggleInput.dataset.togglePublicId;
            const company = appState.company.list.find(c => c.id === companyId);
            if (company) {
                company.isPublic = toggleInput.checked;
                await saveAllCompanies(appState.company.list);
                renderCompanyList();
                populateCompanyDropdown();
                uiFeedback.showToast(`Status de "${company.name}" atualizado.`, 'success');
            }
        }
    });


    document.getElementById('company-form-cancel-btn').addEventListener('click', resetCompanyForm);
    
    function processLogoUpload(file, previewElement, tempStateSetter) {
        if (!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 200, MAX_HEIGHT = 80;
                let {width, height} = img;
                if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }    
                else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/png');
                if (dataUrl.length > 500000) { uiFeedback.showToast('Imagem de logo muito grande.', 'error'); return; }
                tempStateSetter(dataUrl);
                previewElement.src = dataUrl;
                previewElement.classList.remove('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    document.getElementById('company-logo-upload').addEventListener('change', (e) => processLogoUpload(e.target.files[0], document.getElementById('company-logo-preview'), (data) => appState.ui.temporaryCompanyLogo = data));
    document.getElementById('company-rep-logo1-upload').addEventListener('change', (e) => processLogoUpload(e.target.files[0], document.getElementById('company-rep-logo1-preview'), (data) => appState.ui.temporaryRepLogo1 = data));
    document.getElementById('company-rep-logo2-upload').addEventListener('change', (e) => processLogoUpload(e.target.files[0], document.getElementById('company-rep-logo2-preview'), (data) => appState.ui.temporaryRepLogo2 = data));

    document.getElementById('company-select').addEventListener('change', (e) => {
        const selectedCompanyId = e.target.value;
        appState.company.selected = appState.company.list.find(c => c.id === selectedCompanyId);
        updateCompanyInfoOnPages();
    });

    const setupSheetScreen = (prefix) => {
        const btn = document.getElementById(`${prefix}-btn`);
        const configMap = { 'gen': generatorConfig, 'motor': motorConfig, 'transformer': transformerConfig };
        const config = configMap[prefix];
        if (!btn || !config) return;

        btn.addEventListener('click', () => {
            appState.currentReport.editingIndex = null;    
            const addBtn = document.getElementById(`${prefix}-add-sheet-btn`);
            if(addBtn) { addBtn.textContent = 'Adicionar ao Relatório'; addBtn.disabled = true; }
            if (appState.company.selected) {
                document.getElementById(`${prefix}-company-name-header`).textContent = appState.company.selected.name;
            }
            document.getElementById(`${prefix}-cliente`).value = document.getElementById('cover-cliente').value;
            document.getElementById(`${prefix}-local`).value = document.getElementById('cover-local').value;
            navigation.to(prefix);
        });
    };
    
    // --- CHAMADAS DE INICIALIZAÇÃO ---
    createApp(motorConfig);
    createApp(transformerConfig);
    createApp(generatorConfig);
    setupSheetScreen('gen');
    setupSheetScreen('motor');
    setupSheetScreen('transformer');
    initializeCoverApp();
    
    // --- EVENT LISTENERS DE NAVEGAÇÃO ---
    document.getElementById('cover-btn').addEventListener('click', () => { updateCompanyInfoOnPages(); navigation.to('cover'); });
    document.getElementById('index-btn').addEventListener('click', () => { updateIndexPage(); navigation.to('index'); });
    document.getElementById('saved-reports-btn').addEventListener('click', () => { showSavedReportsScreen(); });
    
    document.getElementById('manage-companies-btn').addEventListener('click', () => { 
        if (appState.user.isAdmin) {
            document.getElementById('company-public-toggle-container').classList.remove('hidden');
        }
        renderCompanyList(); 
        navigation.to('companyManagement'); 
    });

    document.getElementById('equipamentos-btn').addEventListener('click', () => navigation.to('equipamentos'));
    document.getElementById('company-management-back-to-cover-btn').addEventListener('click', () => navigation.to('cover'));
    document.querySelectorAll('[id$="-back-to-menu-btn"]').forEach(btn => {    
        btn.addEventListener('click', () => navigation.checkDirtyStateAndNavigate('menu'));    
    });
    document.getElementById('profile-btn').addEventListener('click', () => {
        populateProfileScreen();
        navigation.to('profile');
    });
    document.getElementById('profile-back-to-menu-btn').addEventListener('click', () => navigation.to('menu'));


    // --- OUTROS EVENT LISTENERS ---
    document.getElementById('save-full-report-btn').addEventListener('click', saveFullReport);
    document.getElementById('cover-save-report-btn').addEventListener('click', saveFullReport);
    document.querySelectorAll('.wip-btn').forEach(btn => btn.addEventListener('click', () => { wipModal.classList.add('flex'); wipModal.classList.remove('hidden'); }));
    document.getElementById('close-wip-modal').addEventListener('click', () => { wipModal.classList.add('hidden'); wipModal.classList.remove('flex'); });
    
    document.getElementById('saved-reports-list').addEventListener('click', async (e) => {
        const loadButton = e.target.closest('[data-load-id]');
        const deleteButton = e.target.closest('[data-delete-id]');
        if (loadButton) { e.preventDefault(); await loadFullReport(loadButton.dataset.loadId); }
        if (deleteButton) {    
            e.preventDefault();    
            const confirmed = await uiFeedback.showConfirm('Tem certeza que deseja apagar este relatório?');
            if (confirmed) {    
                await deleteSavedFullReport(deleteButton.dataset.deleteId);    
            }    
        }
    });

    document.getElementById('index-content-list').addEventListener('click', async (e) => {
        const reportLink = e.target.closest('[data-report-index]');
        const deleteButton = e.target.closest('[data-delete-index]');
        if (reportLink) { e.preventDefault(); editSheetFromIndex(parseInt(reportLink.dataset.reportIndex, 10)); }
        if (deleteButton) {
            e.preventDefault();
            const confirmed = await uiFeedback.showConfirm('Remover esta planilha do relatório atual?');
            if (confirmed) {
                appState.currentReport.cache.splice(parseInt(deleteButton.dataset.deleteIndex, 10), 1);
                uiFeedback.showToast('Planilha removida.', 'info');
                updateIndexPage();
            }
        }
    });
    
    document.getElementById('export-current-pdf-btn').addEventListener('click', exportFullReportAsPDF);
});
</script>
</body>
</html>
