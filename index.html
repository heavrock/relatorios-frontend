<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Relatórios Técnicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }
        .header-info { display: grid; grid-template-columns: auto 1fr; gap: 4px 8px; align-items: center; }
        .header-info label { font-weight: 600; text-align: right; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .data-table th, .data-table td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: center; vertical-align: middle; }
        .data-table th { background-color: #f3f4f6; font-weight: 600; }
        .data-table td.label-cell { text-align: left; font-weight: 500; background-color: #f9fafb; }
        .input-yellow { background-color: #fef9c3; width: 100%; text-align: center; border: 1px solid #fde047; border-radius: 4px; padding: 4px; }
        .input-yellow::placeholder { color: #a1a1aa; }
        .output-span { display: block; width: 100%; height: 100%; padding: 4px; min-height: 28px; border-radius: 4px; transition: background-color: 0.3s; }
        .output-blue { background-color: #e0f2fe; }
        .section-title { background-color: #dbeafe; color: #1e3a8a; font-weight: 700; text-align: center; padding: 8px; margin-top: 1.5rem; margin-bottom: 0.5rem; border-radius: 6px; }
        .unit-selector {
            padding: 2px 4px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: white;
            margin-left: 8px;
        }
        .menu-button {
            background-image: linear-gradient(to right, #4f46e5 0%, #7c3aed 51%, #4f46e5 100%);
            transition: 0.5s;
            background-size: 200% auto;
            box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.75);
        }
        .menu-button:hover {
            background-position: right center;
        }
        .menu-button:disabled {
            background-image: none;
            background-color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #transformer-insulation-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            border: 2px solid #9ca3af;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }
        @media (min-width: 768px) { #transformer-insulation-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { #transformer-insulation-grid { grid-template-columns: repeat(3, 1fr); } }

        .insulation-cell { border-bottom: 1px solid #d1d5db; }
        .insulation-cell:last-child { border-bottom: none; }
        
        @media (min-width: 1024px) {
            .insulation-cell { border-right: 1px solid #d1d5db; }
            .insulation-cell:nth-child(3n) { border-right: none; }
            .insulation-cell:nth-last-child(-n+3) { border-bottom: none; }
        }
        @media (min-width: 768px) and (max-width: 1023px) {
             .insulation-cell { border-right: 1px solid #d1d5db; }
             .insulation-cell:nth-child(2n) { border-right: none; }
             .insulation-cell:nth-last-child(-n+2) { border-bottom: none; }
        }

        .cell-title { background-color: #e5e7eb; font-weight: 600; padding: 6px; text-align: center; border-bottom: 1px solid #d1d5db; font-size: 12px; }
        .cell-content { padding: 8px; }
        .measurement-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; align-items: center; margin-bottom: 6px; }
        .measurement-item { text-align: center; }
        .measurement-item label { font-size: 11px; font-weight: 500; display: block; margin-bottom: 2px; }
        .measurement-item .input-group { display: flex; align-items: center; justify-content: center; }
        .measurement-item input { max-width: 70px; padding: 2px 4px; font-size: 13px; }
        .measurement-item span.unit { font-size: 12px; font-weight: 500; margin-left: 4px; }
        .correction-title { text-align: center; font-weight: 500; font-size: 12px; padding: 4px; background-color: #f9fafb; border-top: 1px solid #d1d5db; border-bottom: 1px solid #d1d5db; margin: 8px -8px; }
        .indices-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .index-item { text-align: center; }
        .index-item label { font-size: 12px; font-weight: 600; display: block; margin-bottom: 2px; }
        .index-item span { display: block; padding: 4px; border-radius: 4px; font-weight: 500; min-height: 28px; }
        .status-cell { padding: 6px; border-radius: 6px; text-align: center; font-weight: bold; color: white; font-size: 12px; min-height: 32px; display: flex; align-items: center; justify-content: center; width: 100%; }
        .report-page { border: 1px solid #ccc; padding: 2rem; max-width: 800px; aspect-ratio: 210 / 297; margin: 2rem auto; background: white; display: flex; flex-direction: column; }
        
        /* Estilo para notificações customizadas */
        #notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.5s, transform 0.5s;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }

    </style>
</head>
<body class="bg-gray-100">

    <!-- Área para notificações -->
    <div id="notification-area"></div>

    <!-- TELA DE AUTENTICAÇÃO -->
    <div id="auth-screen">
        <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4">
            <h1 class="text-4xl font-bold text-white mb-8">Relatórios Técnicos</h1>
            
            <!-- Formulário de Login -->
            <div id="login-form-container" class="w-full max-w-sm">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Acessar Conta</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-indigo-300 mb-2">Email</label>
                            <input type="email" id="login-email" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-indigo-300 mb-2">Senha</label>
                            <input type="password" id="login-password" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <button type="submit" class="w-full menu-button text-white font-bold py-3 px-6 rounded-xl text-lg">Entrar</button>
                    </form>
                    <p class="text-center text-gray-400 mt-6">
                        Não tem uma conta? <a href="#" id="show-register-link" class="text-indigo-300 hover:underline">Crie uma agora</a>
                    </p>
                </div>
            </div>

            <!-- Formulário de Cadastro -->
            <div id="register-form-container" class="w-full max-w-sm hidden">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Criar Nova Conta</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="register-email" class="block text-indigo-300 mb-2">Email</label>
                            <input type="email" id="register-email" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="block text-indigo-300 mb-2">Senha</label>
                            <input type="password" id="register-password" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <button type="submit" class="w-full menu-button text-white font-bold py-3 px-6 rounded-xl text-lg">Criar Conta</button>
                    </form>
                    <p class="text-center text-gray-400 mt-6">
                        Já tem uma conta? <a href="#" id="show-login-link" class="text-indigo-300 hover:underline">Faça o login</a>
                    </p>
                </div>
            </div>

            <!-- Tela de Aguardando Aprovação -->
            <div id="pending-approval-container" class="w-full max-w-sm hidden">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold text-white mb-4">Aguardando Aprovação</h2>
                    <p class="text-indigo-300">Sua conta foi criada com sucesso e está aguardando a aprovação do administrador. Você será notificado por e-mail quando seu acesso for liberado.</p>
                     <button id="pending-back-to-login" class="mt-6 bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar para Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- APLICATIVO PRINCIPAL (INICIALMENTE ESCONDIDO) -->
    <div id="main-app-wrapper" class="hidden">
        <!-- TELA DO MENU PRINCIPAL -->
        <div id="menu-screen">
            <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4">
                <h1 class="text-4xl font-bold text-white mb-8">Painel de Controle</h1>
                
                <div class="mb-8 w-full max-w-sm">
                    <label for="company-select" class="block text-center text-lg text-indigo-300 mb-2">Selecione a Empresa</label>
                    <select id="company-select" class="w-full p-3 text-center rounded-lg border-2 border-indigo-400 bg-gray-700 text-white focus:outline-none focus:border-indigo-200">
                        <!-- Opções de empresa carregadas dinamicamente -->
                    </select>
                </div>

                <div class="w-full max-w-xl">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 text-center">
                         <button id="cover-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">EDITAR CAPA</button>
                         <button id="index-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">ÍNDICE / EXPORTAR</button>
                         <button id="saved-reports-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">RELATÓRIOS SALVOS</button>
                         <button id="equipamentos-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">EQUIPAMENTOS</button>
                         <!-- O botão do painel admin será exibido aqui se o usuário for admin -->
                         <button id="admin-panel-btn" class="menu-button bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-xl text-lg sm:col-span-2 hidden">PAINEL ADMIN</button>
                     </div>
                </div>
                <div class="mt-8">
                    <button id="logout-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Sair</button>
                </div>
            </div>
        </div>
        
        <!-- TELA DO PAINEL ADMIN -->
        <div id="admin-panel-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">Painel de Administração</h1>
                <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Usuários Pendentes -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-yellow-600">Usuários Pendentes</h2>
                        <div id="pending-users-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Lista de usuários pendentes será inserida aqui pelo JS -->
                        </div>
                    </div>
                    <!-- Usuários Ativos -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-green-600">Usuários Ativos</h2>
                        <div id="active-users-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Lista de usuários ativos será inserida aqui pelo JS -->
                        </div>
                    </div>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="admin-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar ao Menu</button>
                </div>
            </div>
        </div>


        <!-- TELA DE SELEÇÃO DE EQUIPAMENTOS (NOVA) -->
        <div id="equipamentos-screen" class="hidden">
            <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4">
                <h1 class="text-4xl font-bold text-white mb-8">Selecione o Equipamento</h1>
                <div class="w-full max-w-4xl">
                     <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 text-center">
                         <button id="gen-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">GERADOR</button>
                         <button id="transformer-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">TRAFO X3</button>
                         <button id="motor-btn" class="menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">MOTOR</button>
                         <button class="wip-btn menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">TRAFO INDUTOR</button>
                         <button class="wip-btn menu-button text-white font-bold py-4 px-6 rounded-xl text-lg">TRAFO X6</button>
                     </div>
                </div>
                <div class="mt-8">
                    <button id="equipamentos-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar ao Menu</button>
                </div>
            </div>
        </div>

        <!-- TELA DA CAPA DO RELATÓRIO -->
        <div id="cover-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-2xl font-bold text-center text-blue-800 mb-4">Editor da Capa do Relatório</h1>
                
                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center mb-8">
                    <button id="cover-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="manage-companies-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition w-full sm:w-auto">Gerenciar Empresas</button>
                    <button id="cover-save-report-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition w-full sm:w-auto">Salvar Relatório Completo</button>
                </div>

                <div class="max-w-2xl mx-auto bg-gray-50 p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-lg font-semibold mb-4 border-b pb-2">Informações da Capa</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="cover-cliente" class="block text-sm font-medium text-gray-700 mb-1">Empresa (Cliente)</label>
                            <input type="text" id="cover-cliente" placeholder="Ex: OCEANPACT" class="p-2 border rounded w-full">
                        </div>
                        <div>
                            <label for="cover-local" class="block text-sm font-medium text-gray-700 mb-1">Embarcação</label>
                            <input type="text" id="cover-local" placeholder="Ex: SEWARD JOHNSON" class="p-2 border rounded w-full">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Imagem do Equipamento</label>
                            <input type="file" id="cover-image-upload" class="hidden" accept="image/*">
                            <label for="cover-image-upload" class="w-full inline-block text-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition cursor-pointer">
                                CARREGAR IMAGEM DO NAVIO
                            </label>
                        </div>
                    </div>
                </div>

                <div id="cover-preview" class="report-page">
                    <header class="flex justify-end items-start">
                        <div class="text-right text-xs">
                            <p class="font-bold" id="cover-preview-company-name"></p>
                            <p id="cover-preview-company-address"></p>
                            <p id="cover-preview-company-phones"></p>
                            <p id="cover-preview-company-phone2"></p>
                        </div>
                    </header>
                    <main class="flex-grow flex flex-col items-center justify-center text-center -mt-8">
                        <h1 id="cover-preview-cliente" class="text-4xl font-bold text-black border-b-2 border-black pb-2">CLIENTE</h1>
                        <h2 id="cover-preview-local" class="text-3xl font-bold text-black mt-2">EMBARCAÇÃO</h2>
                        <p class="mt-8 text-xl">Relatório técnico de medição de resistência de isolamento elétrico (Megagem)</p>
                        <img id="cover-preview-image" src="" alt="Imagem da Embarcação" class="mt-6 max-w-sm w-full h-auto object-cover rounded-md shadow-lg">
                    </main>
                    <footer class="text-center text-xs text-gray-600 mt-auto pt-4">
                        <p>Conformidade com as normas ABNT NBR5383-1, IEEE43 e IEC 60034-27-4</p>
                    </footer>
                </div>
            </div>
        </div>

        <!-- TELA DO ÍNDICE -->
        <div id="index-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-2xl font-bold text-center text-blue-800 mb-4">Índice do Relatório</h1>

                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center mb-8">
                    <button id="index-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="save-full-report-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition w-full sm:w-auto">Salvar Relatório Completo</button>
                    <button id="export-current-pdf-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">Exporta Relatório Atual</button>
                </div>

                <div id="index-page" class="report-page">
                    <header class="flex justify-end items-start">
                        <div class="text-right text-xs">
                            <p class="font-bold" id="index-company-name"></p>
                            <p id="index-company-address"></p>
                            <p id="index-company-phones"></p>
                            <p id="index-company-phone2"></p>
                        </div>
                    </header>
                    <main id="index-content-list" class="flex-grow p-4">
                        <!-- Conteúdo do índice será carregado -->
                    </main>
                    <footer class="text-center text-xs text-gray-600 mt-auto pt-4">
                        <p>Conformidade com as normas ABNT NBR5383-1, IEEE43 e IEC 60034-27-4</p>
                    </footer>
                </div>
            </div>
        </div>

        <!-- TELA DE RELATÓRIOS SALVOS -->
        <div id="saved-reports-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-2xl font-bold text-center text-blue-800 mb-4">Relatórios Salvos</h1>
                <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md">
                    <div id="saved-reports-list" class="space-y-3">
                        <!-- A lista de relatórios salvos será inserida aqui -->
                    </div>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="saved-reports-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar ao Menu</button>
                </div>
            </div>
        </div>

        <!-- TELA DE GERENCIAMENTO DE EMPRESAS -->
        <div id="company-management-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div class="container mx-auto">
                <h1 class="text-2xl font-bold text-center text-blue-800 mb-6">Gerenciar Empresas</h1>
                <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Formulário de Adicionar/Editar -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 id="company-form-title" class="text-xl font-semibold mb-4">Adicionar Nova Empresa</h2>
                        <form id="company-form" class="space-y-4">
                            <input type="hidden" id="company-id">
                            <div>
                                <label for="company-name" class="block text-sm font-medium text-gray-700">Nome da Empresa</label>
                                <input type="text" id="company-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="company-address" class="block text-sm font-medium text-gray-700">Endereço</label>
                                <input type="text" id="company-address" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Rua, Número, Bairro, Cidade, Estado">
                            </div>
                            <div>
                                <label for="company-phones" class="block text-sm font-medium text-gray-700">Telefone 1</label>
                                <input type="text" id="company-phones" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="company-phone2" class="block text-sm font-medium text-gray-700">Telefone 2</label>
                                <input type="text" id="company-phone2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="flex gap-4">
                                <button type="submit" id="company-form-submit-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Adicionar Empresa</button>
                                <button type="button" id="company-form-cancel-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition hidden">Cancelar Edição</button>
                            </div>
                        </form>
                    </div>
                    <!-- Lista de Empresas -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Empresas Cadastradas</h2>
                        <div id="company-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Lista de empresas será renderizada aqui -->
                        </div>
                    </div>
                </div>
                <div class="flex justify-center mt-8">
                    <button id="company-management-back-to-cover-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar para a Capa</button>
                </div>
            </div>
        </div>

        <!-- TELA DA PLANILHA DO GERADOR -->
        <div id="generator-app-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div id="gen-app-container" class="container mx-auto p-2 sm:p-4 md:p-6 bg-white shadow-lg my-4 sm:my-8">
                <header class="border-b-2 border-gray-200 pb-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 id="gen-company-name-header" class="text-xl sm:text-2xl font-bold text-blue-800"></h1>
                        </div>
                        <div id="gen-usage-counter" class="text-sm font-semibold p-2 rounded-md transition-colors duration-300"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-3">
                        <div class="header-info"><label>CLIENTE:</label> <input type="text" id="gen-cliente" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>TÉCNICO:</label> <input type="text" id="gen-tecnico" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>EQUIP.:</label> <input type="text" id="gen-equipamento" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>Nº SÉRIE:</label> <input type="text" id="gen-numeroSerie" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>LOCAL:</label> <input type="text" id="gen-local" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>AVR:</label> <input type="text" id="gen-avr" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>TENSÃO:</label> <input type="text" id="gen-tensao" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>POTÊNCIA:</label> <input type="text" id="gen-potencia" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info sm:col-span-2 lg:col-span-1"><label>DATA:</label> <input type="date" id="gen-data" class="border rounded px-2 py-1 w-full"></div>
                    </div>
                </header>

                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center my-4 pdf-hide">
                    <button id="gen-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="gen-fillTestData" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">Preencher Exemplo</button>
                    <button id="gen-clearForm" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition w-full sm:w-auto">Limpar</button>
                    <button id="gen-add-sheet-btn" class="menu-button text-white font-bold py-2 px-6 rounded-lg transition w-full sm:w-auto" disabled>Adicionar ao Relatório</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div class="flex items-center gap-2">
                        <label for="gen-tempAmbiente" class="font-semibold">Temp. Amb. (°C):</label>
                        <input type="number" id="gen-tempAmbiente" class="input-yellow w-full">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="gen-tempEnrolamento" class="font-semibold">Temp. Enrol. (°C):</label>
                        <input type="number" id="gen-tempEnrolamento" class="input-yellow w-full" placeholder="Essencial">
                    </div>
                    <div class="flex items-center gap-2 sm:col-span-2 md:col-span-1">
                        <label for="gen-umidadeRelativa" class="font-semibold">Umidade (%):</label>
                        <input type="number" id="gen-umidadeRelativa" class="input-yellow w-full">
                    </div>
                </div>
                
                <div id="gen-main-sections-container"></div>
                <div class="text-center my-4">
                    <button id="gen-togglePmg" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Ativar Seção PMG</button>
                </div>
                <div id="gen-pmg-section-container" class="hidden"></div>
                <div id="gen-extra-sections-container"></div>
            </div>
        </div>
        
        <!-- TELA DA PLANILHA DO MOTOR -->
        <div id="motor-app-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div id="motor-app-container" class="container mx-auto p-2 sm:p-4 md:p-6 bg-white shadow-lg my-4 sm:my-8">
                <header class="border-b-2 border-gray-200 pb-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 id="motor-company-name-header" class="text-xl sm:text-2xl font-bold text-blue-800"></h1>
                        </div>
                        <div id="motor-usage-counter" class="text-sm font-semibold p-2 rounded-md transition-colors duration-300"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-3">
                        <div class="header-info"><label>CLIENTE:</label> <input type="text" id="motor-cliente" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>LOCAL:</label> <input type="text" id="motor-local" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>DATA:</label> <input type="date" id="motor-data" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>EQUIP.:</label> <input type="text" id="motor-equipamento" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>Nº SÉRIE:</label> <input type="text" id="motor-numeroSerie" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>FAB./MODELO:</label> <input type="text" id="motor-fabricante" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>TENSÃO:</label> <input type="text" id="motor-tensao" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>POTÊNCIA:</label> <input type="text" id="motor-potencia" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>ROTAÇÃO:</label> <input type="text" id="motor-rotacao" class="border rounded px-2 py-1 w-full"></div>
                    </div>
                </header>

                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center my-4 pdf-hide">
                    <button id="motor-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="motor-fillTestData" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">Preencher Exemplo</button>
                    <button id="motor-clearForm" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition w-full sm:w-auto">Limpar</button>
                    <button id="motor-add-sheet-btn" class="menu-button text-white font-bold py-2 px-6 rounded-lg transition w-full sm:w-auto" disabled>Adicionar ao Relatório</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div class="flex items-center gap-2">
                        <label for="motor-tempAmbiente" class="font-semibold">Temp. Amb. (°C):</label>
                        <input type="number" id="motor-tempAmbiente" class="input-yellow w-full">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="motor-tempEnrolamento" class="font-semibold">Temp. Enrol. (°C):</label>
                        <input type="number" id="motor-tempEnrolamento" class="input-yellow w-full" placeholder="Essencial">
                    </div>
                    <div class="flex items-center gap-2 sm:col-span-2 md:col-span-1">
                        <label for="motor-umidadeRelativa" class="font-semibold">Umidade (%):</label>
                        <input type="number" id="motor-umidadeRelativa" class="input-yellow w-full">
                    </div>
                </div>
                
                <div id="motor-sections-container"></div>
            </div>
        </div>

        <!-- TELA DA PLANILHA DO TRANSFORMADOR X3 -->
        <div id="transformer-app-screen" class="hidden bg-gray-100 min-h-screen p-4">
            <div id="transformer-app-container" class="container mx-auto p-2 sm:p-4 md:p-6 bg-white shadow-lg my-4 sm:my-8">
                <header class="border-b-2 border-gray-200 pb-6 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 id="transformer-company-name-header" class="text-xl sm:text-2xl font-bold text-blue-800"></h1>
                        </div>
                        <div id="transformer-usage-counter" class="text-sm font-semibold p-2 rounded-md transition-colors duration-300"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-3">
                        <div class="header-info"><label>CLIENTE:</label> <input type="text" id="transformer-cliente" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>LOCAL:</label> <input type="text" id="transformer-local" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>DATA:</label> <input type="date" id="transformer-data" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>EQUIP.:</label> <input type="text" id="transformer-equipamento" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>Nº SÉRIE:</label> <input type="text" id="transformer-numeroSerie" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>FAB./MODELO:</label> <input type="text" id="transformer-fabricante" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>TENSÃO:</label> <input type="text" id="transformer-tensao" class="border rounded px-2 py-1 w-full"></div>
                        <div class="header-info"><label>POTÊNCIA:</label> <input type="text" id="transformer-potencia" class="border rounded px-2 py-1 w-full"></div>
                    </div>
                </header>

                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-center my-4 pdf-hide">
                    <button id="transformer-back-to-menu-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition w-full sm:w-auto">Voltar ao Menu</button>
                    <button id="transformer-fillTestData" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition w-full sm:w-auto">Preencher Exemplo</button>
                    <button id="transformer-clearForm" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition w-full sm:w-auto">Limpar</button>
                    <button id="transformer-add-sheet-btn" class="menu-button text-white font-bold py-2 px-6 rounded-lg transition w-full sm:w-auto" disabled>Adicionar ao Relatório</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div class="flex items-center gap-2">
                        <label for="transformer-tempAmbiente" class="font-semibold">Temp. Amb. (°C):</label>
                        <input type="number" id="transformer-tempAmbiente" class="input-yellow w-full">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="transformer-tempTrafo" class="font-semibold">Temp. no Trafo (°C):</label>
                        <input type="number" id="transformer-tempTrafo" class="input-yellow w-full" placeholder="Essencial">
                    </div>
                    <div class="flex items-center gap-2 sm:col-span-2 md:col-span-1">
                        <label for="transformer-umidadeRelativa" class="font-semibold">Umidade (%):</label>
                        <input type="number" id="transformer-umidadeRelativa" class="input-yellow w-full">
                    </div>
                </div>
                
                <div id="transformer-sections-container"></div>
            </div>
        </div>

        <!-- Overlay de Limite de Uso e Modal de WIP -->
        <div id="usage-limit-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 hidden items-center justify-center text-center text-white p-8 z-[100]">
            <div>
                <h2 class="text-3xl font-bold text-red-500 mb-4">Limite de Uso Atingido</h2>
                <p class="text-xl">Para continuar utilizando esta ferramenta, por favor, entre em contato com o Técnico Roosevelt Santos.</p>
            </div>
        </div>
        <div id="wip-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
                <h3 class="text-xl font-bold text-blue-800 mb-4">Em Desenvolvimento</h3>
                <p class="text-gray-700 mb-6">Esta funcionalidade estará disponível em breve!</p>
                <button id="close-wip-modal" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Fechar</button>
            </div>
        </div>
        <div id="pdf-loader-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center text-center text-white p-8 z-[200]">
            <div>
                <svg class="animate-spin h-10 w-10 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <h2 class="text-2xl font-bold">Gerando Relatório em PDF...</h2>
                <p class="text-lg mt-2">Isso pode levar alguns segundos. Por favor, aguarde.</p>
            </div>
        </div>
    </div>

<script type="module">
    // Importações do Firebase - Mantidas como na v9 para compatibilidade com seu código
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // Sua configuração do Firebase
    const firebaseConfig = {
      apiKey: "***REMOVED***",
      authDomain: "relatorios-tecnicos-app.firebaseapp.com",
      projectId: "relatorios-tecnicos-app",
      storageBucket: "relatorios-tecnicos-app.appspot.com",
      messagingSenderId: "280958854421",
      appId: "1:280958854421:web:90e4b288f3c57592d9351c"
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

document.addEventListener('DOMContentLoaded', () => {
    // ==================================================================================
    // --- LÓGICA DE AUTENTICAÇÃO E ADMINISTRAÇÃO ---
    // ==================================================================================

    // --- Elementos da UI de Autenticação ---
    const authScreen = document.getElementById('auth-screen');
    const mainAppWrapper = document.getElementById('main-app-wrapper');
    const loginFormContainer = document.getElementById('login-form-container');
    const registerFormContainer = document.getElementById('register-form-container');
    const pendingApprovalContainer = document.getElementById('pending-approval-container');
    const adminPanelBtn = document.getElementById('admin-panel-btn');

    // --- Lógica de estado da autenticação ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Usuário está autenticado, agora precisamos verificar seu status no Firestore
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                
                if (userData.status === 'approved') {
                    // ACESSO PERMITIDO
                    currentUserId = user.uid;
                    authScreen.classList.add('hidden');
                    mainAppWrapper.classList.remove('hidden');
                    
                    // Mostra o botão de admin se o usuário tiver a role
                    if (userData.role === 'admin') {
                        adminPanelBtn.classList.remove('hidden');
                    } else {
                        adminPanelBtn.classList.add('hidden');
                    }
                    
                    // Carrega os dados do usuário do Firestore
                    companyList = await getCompanies();
                    populateCompanyDropdown();

                    const initialScreen = window.location.hash.substring(1) || 'menu';
                    const screenElement = screens[initialScreen] || screens.menu;
                    showScreen(screenElement, false);
                    history.replaceState({ screen: initialScreen }, '', `#${initialScreen}`);

                } else if (userData.status === 'pending') {
                    // CONTA PENDENTE
                    showToast('Sua conta está aguardando aprovação.', 'info');
                    showAuthForm('pending');
                    await signOut(auth); // Desloga o usuário para que ele não fique "preso"
                } else if (userData.status === 'denied') {
                    // CONTA RECUSADA
                    showToast('Seu acesso foi recusado pelo administrador.', 'error');
                    showAuthForm('login');
                    await signOut(auth);
                } else {
                    // Status desconhecido, trata como pendente por segurança
                    showToast('O status da sua conta é indefinido. Contate o suporte.', 'error');
                    showAuthForm('login');
                    await signOut(auth);
                }
            } else {
                // Documento do usuário não existe no Firestore (pode ser um erro ou um usuário órfão)
                // Para novos cadastros, isso é resolvido no fluxo de registro.
                // Para logins, isso significa que o usuário não pode acessar.
                showToast('Seus dados não foram encontrados. Por favor, cadastre-se novamente ou contate o suporte.', 'error');
                await signOut(auth);
                showAuthForm('login');
            }
        } else {
            // Usuário está deslogado
            currentUserId = null;
            authScreen.classList.remove('hidden');
            mainAppWrapper.classList.add('hidden');
            showAuthForm('login'); // Mostra o formulário de login por padrão
            showScreen(null, false);
        }
    });

    // --- Manipulador do formulário de Login ---
    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                // O onAuthStateChanged vai cuidar do resto
                showToast('Verificando credenciais...', 'info');
            })
            .catch((error) => {
                showToast(`Erro no login: Usuário ou senha inválidos.`, 'error');
            });
    });

    // --- Manipulador do formulário de Cadastro (ATUALIZADO COM MELHOR ERRO) ---
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // Cria o documento do usuário no Firestore com status 'pending'
            const userDocRef = doc(db, "users", user.uid);
            await setDoc(userDocRef, {
                uid: user.uid,
                email: user.email,
                role: 'user', // Todos os novos usuários são 'user' por padrão
                status: 'pending', // Todos os novos usuários precisam de aprovação
                createdAt: new Date().toISOString()
            });

            // Mostra a tela de "Aguardando Aprovação"
            showAuthForm('pending');
            
            // Desloga o usuário para que o onAuthStateChanged não o autorize indevidamente
            await signOut(auth);

        } catch (error) {
            // **MELHORIA APLICADA AQUI**
            if (error.code === 'auth/email-already-in-use') {
                showToast('Este e-mail já está cadastrado. Aguarde a aprovação ou contate o suporte.', 'error');
            } else {
                showToast(`Erro ao criar conta: ${error.message}`, 'error');
            }
        }
    });
    
    // --- Lógica do Painel de Admin ---
    adminPanelBtn.addEventListener('click', async () => {
        showScreen(screens.adminPanel);
        await loadAdminPanelData();
    });

    async function loadAdminPanelData() {
        const pendingListEl = document.getElementById('pending-users-list');
        const activeListEl = document.getElementById('active-users-list');
        pendingListEl.innerHTML = '<p>Carregando...</p>';
        activeListEl.innerHTML = '<p>Carregando...</p>';

        try {
            // Busca usuários pendentes
            const pendingQuery = query(collection(db, "users"), where("status", "==", "pending"));
            const pendingSnapshot = await getDocs(pendingQuery);
            pendingListEl.innerHTML = pendingSnapshot.empty ? '<p class="text-gray-500">Nenhum usuário pendente.</p>' : '';
            pendingSnapshot.forEach(doc => {
                const user = doc.data();
                const userEl = document.createElement('div');
                userEl.className = 'flex items-center justify-between p-2 border rounded-md';
                userEl.innerHTML = `
                    <span class="text-sm truncate" title="${user.email}">${user.email}</span>
                    <div class="flex gap-2">
                        <button data-uid="${user.uid}" data-action="approve" class="bg-green-500 text-white px-2 py-1 text-xs rounded hover:bg-green-600">Aprovar</button>
                        <button data-uid="${user.uid}" data-action="deny" class="bg-orange-500 text-white px-2 py-1 text-xs rounded hover:bg-orange-600">Recusar</button>
                    </div>
                `;
                pendingListEl.appendChild(userEl);
            });

            // Busca usuários ativos
            const activeQuery = query(collection(db, "users"), where("status", "==", "approved"));
            const activeSnapshot = await getDocs(activeQuery);
            activeListEl.innerHTML = activeSnapshot.empty ? '<p class="text-gray-500">Nenhum usuário ativo.</p>' : '';
            activeSnapshot.forEach(doc => {
                const user = doc.data();
                const userEl = document.createElement('div');
                userEl.className = 'flex items-center justify-between p-2 border rounded-md';
                userEl.innerHTML = `
                    <div>
                        <span class="text-sm truncate" title="${user.email}">${user.email}</span>
                        <span class="text-xs ml-2 px-2 py-0.5 rounded-full ${user.role === 'admin' ? 'bg-yellow-200 text-yellow-800' : 'bg-blue-200 text-blue-800'}">${user.role}</span>
                    </div>
                    <button data-uid="${user.uid}" data-action="delete" class="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">Excluir</button>
                `;
                activeListEl.appendChild(userEl);
            });
        } catch (error) {
            console.error("Erro ao carregar dados do admin:", error);
            showToast('Erro ao carregar dados do painel.', 'error');
            pendingListEl.innerHTML = '<p class="text-red-500">Erro ao carregar.</p>';
            activeListEl.innerHTML = '<p class="text-red-500">Erro ao carregar.</p>';
        }
    }

    // Delegação de eventos para os botões do painel de admin (ATUALIZADO)
    document.getElementById('admin-panel-screen').addEventListener('click', async (e) => {
        const target = e.target;
        if (target.tagName === 'BUTTON' && target.dataset.uid) {
            const uid = target.dataset.uid;
            const action = target.dataset.action;
            const userDocRef = doc(db, "users", uid);

            if (action === 'approve') {
                await updateDoc(userDocRef, { status: 'approved' });
                showToast('Usuário aprovado!', 'success');
            } else if (action === 'deny') {
                // **MELHORIA APLICADA AQUI**
                // Apenas muda o status para 'denied', não apaga o registro.
                // Isso impede que o usuário se cadastre novamente com o mesmo e-mail.
                if (confirm('Tem certeza que deseja recusar este usuário? Ele não poderá mais acessar ou se cadastrar com este e-mail.')) {
                    await updateDoc(userDocRef, { status: 'denied' });
                    showToast('Usuário recusado.', 'info');
                }
            } else if (action === 'delete') {
                // **AVISO IMPORTANTE**
                // Esta ação apaga apenas o registro do Firestore.
                // O usuário ainda existirá no "Firebase Authentication" e não poderá se cadastrar novamente.
                // Para apagar o usuário completamente, é necessário usar uma Cloud Function com o Firebase Admin SDK.
                if (confirm('Tem certeza que deseja EXCLUIR PERMANENTEMENTE este usuário do banco de dados?')) {
                    await deleteDoc(userDocRef);
                    showToast('Registro do usuário excluído.', 'info');
                }
            }
            
            // Recarrega os dados do painel após a ação
            if (action) await loadAdminPanelData();
        }
    });

    // --- Funções de controle da UI de autenticação ---
    function showAuthForm(formName) {
        loginFormContainer.classList.add('hidden');
        registerFormContainer.classList.add('hidden');
        pendingApprovalContainer.classList.add('hidden');

        if (formName === 'login') {
            loginFormContainer.classList.remove('hidden');
        } else if (formName === 'register') {
            registerFormContainer.classList.remove('hidden');
        } else if (formName === 'pending') {
            pendingApprovalContainer.classList.remove('hidden');
        }
    }
    
    document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('register'); });
    document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });
    document.getElementById('pending-back-to-login').addEventListener('click', (e) => { e.preventDefault(); showAuthForm('login'); });
    document.getElementById('logout-btn').addEventListener('click', () => {
        signOut(auth).catch((error) => showToast(`Erro ao sair: ${error.message}`, 'error'));
    });
    
    // ==================================================================================
    // --- O RESTANTE DO SEU CÓDIGO (sem alterações) ---
    // ==================================================================================

    // --- DADOS GLOBAIS E CONFIGURAÇÃO ---
    let localReportsCache = []; 
    let currentlyEditingIndex = null;
    let coverImageDataUrl = null; 
    let companyList = [];
    let currentCompany = null;
    let currentUserId = null; // Guardará o ID do usuário logado

    // --- LÓGICA DE CÁLCULO E CONFIGURAÇÕES DAS PLANILHAS ---
    const getKtInsulation = (temp, targetTemp) => Math.pow(2, (targetTemp - temp) / 10);
    const getKtOhmic = (temp, targetTemp) => (234.5 + targetTemp) / (234.5 + temp);
    const statusColors = { 'Perigoso': '#ef4444', 'Pobre': '#f97316', 'Questionável': '#facc15', 'Confiável': '#a3e635', 'Bom': '#4ade80', 'Excelente': '#16a34a', '': '#FFFFFF' };
    const darkTextStatus = ['Questionável', 'Confiável', 'Bom'];
    const evaluateIndex = (value, thresholds) => { if (isNaN(value) || value === null || value <= 0) return { status: '', color: statusColors[''] }; for (const t of thresholds) { if (value < t.limit) return { status: t.status, color: statusColors[t.status] }; } return { status: 'Excelente', color: statusColors['Excelente'] }; };
    const evaluateIA = (v) => evaluateIndex(v, [{ limit: 1, status: 'Perigoso' }, { limit: 1.1, status: 'Pobre' }, { limit: 1.25, status: 'Questionável' }, { limit: 1.4, status: 'Confiável' }, { limit: 1.6, status: 'Bom' }]);
    const evaluateIP = (v) => evaluateIndex(v, [{ limit: 1, status: 'Perigoso' }, { limit: 1.5, status: 'Pobre' }, { limit: 2, status: 'Questionável' }, { limit: 3, status: 'Confiável' }, { limit: 4, status: 'Bom' }]);
    
    const reportSheetHandlers = {
        init: (container, recalc, getEl, clearForm, collectSheetData, config) => {
            const addSheetBtn = getEl('add-sheet-btn');
            const fillTestDataBtn = getEl('fillTestData');
            const clearFormBtn = getEl('clearForm');

            if (fillTestDataBtn) {
                fillTestDataBtn.addEventListener('click', () => {
                    if (!config.testData) { console.error(`Dados de teste não encontrados para ${config.appName}`); return; }
                        Object.entries(config.testData.header).forEach(([key, value]) => {
                            const el = getEl(key);
                            if(el) el.value = value;
                        });
                        config.sections.forEach(section => {
                            section.rows.forEach(row => {
                                const data = config.testData.sections[section.name]?.[row.id];
                                if (data === undefined) return;
                                if (section.type === 'insulation') {
                                        const reg30sInput = container.querySelector(`input[data-row="${row.id}"][data-col="reg30s"]`); if(reg30sInput) reg30sInput.value = data[0];
                                        const reg1minInput = container.querySelector(`input[data-row="${row.id}"][data-col="reg1min"]`); if(reg1minInput) reg1minInput.value = data[1];
                                        const reg10minInput = container.querySelector(`input[data-row="${row.id}"][data-col="reg10min"]`); if(reg10minInput) reg10minInput.value = data[2];
                                } else if (section.type === 'diodes') {
                                    if (data.d1_d6) { data.d1_d6.forEach((val, i) => { const input = container.querySelector(`input[data-row="gen-diodes-dir"][data-col="d${i + 1}"]`); if (input) input.value = val; }); }
                                    if (data.d7_d12) { data.d7_d12.forEach((val, i) => { const input = container.querySelector(`input[data-row="gen-diodes-dir"][data-col="d${i + 7}"]`); if (input) input.value = val; }); }
                                } else {
                                    const regInput = container.querySelector(`input[data-row="${row.id}"][data-col="reg"]`);
                                    if (regInput) {
                                        regInput.value = (typeof data === 'object' && data !== null && data.reg !== undefined) ? data.reg : data;
                                    }
                                }
                            });
                        });
                        recalc();
                });
            }
            
            clearFormBtn.addEventListener('click', () => {
                if (isFormDirty(container)) {
                    if (!confirm('Você tem certeza que deseja limpar o formulário? Os dados inseridos serão perdidos.')) {
                        return;
                    }
                }
                clearForm(config);
            });

            if (!addSheetBtn) return;
            const headerInputs = [getEl('equipamento')];
            function validateHeader() {
                addSheetBtn.disabled = !headerInputs.every(input => input && input.value.trim() !== '');
            }
            headerInputs.forEach(input => { if (input) input.addEventListener('input', validateHeader); });

            addSheetBtn.addEventListener('click', () => {
                const sheetData = collectSheetData(container, config);
                
                if (currentlyEditingIndex !== null) {
                    localReportsCache[currentlyEditingIndex] = sheetData;
                    showToast(`Planilha "${sheetData.header.equipamento}" atualizada.`, 'success');
                    currentlyEditingIndex = null;
                } else {
                    localReportsCache.push(sheetData);
                    showToast(`Planilha para "${sheetData.header.equipamento}" adicionada.`, 'success');
                }
                
                clearForm(config, true); 
                ['equipamento', 'numeroSerie', 'avr', 'tensao', 'potencia', 'tecnico', 'responsavelTecnico', 'rotacao', 'fabricante'].forEach(id => { 
                    const el = getEl(id); 
                    if(el) el.value = ''; 
                });
                
                addSheetBtn.textContent = 'Adicionar ao Relatório';
                validateHeader();
                
                showScreen(screens.index);
                updateIndexPage();
            });
            validateHeader();
        }
    };

    const motorConfig = { prefix: 'motor', appName: 'Motor', containerId: 'motor-app-container', containerIds: [{ id: 'motor-sections-container', type: 'main' }], usageKey: 'unitechMotorAppUsageCount_v2', usageLimit: 20, tempInputId: 'tempEnrolamento', insulation: { targetTemp: 40 }, ohmic: { targetTemp: 25 }, layout: 'table', specialHandlers: reportSheetHandlers, sections: [ { name: 'ESTATOR PRINCIPAL', type: 'insulation', rows: [ { id: 'motor-uxmassa', label: 'U x Massa' }, { id: 'motor-vxmassa', label: 'V x Massa' }, { id: 'motor-wxmassa', label: 'W x Massa' }, { id: 'motor-uxv', label: 'U x V' }, { id: 'motor-vxw', label: 'V x W' }, { id: 'motor-wxu', label: 'W x U' }, ]}, { name: 'RESISTÊNCIA AQUECIMENTO', type: 'heating', rows: [{ id: 'motor-heating-massa', label: 'Massa' }] }, { name: 'MEDIÇÃO RESISTÊNCIA ÔHMICA', type: 'ohmic', rows: [ { id: 'motor-ohm-u', label: 'Fase U' }, { id: 'motor-ohm-v', label: 'Fase V' }, { id: 'motor-ohm-w', label: 'Fase W' }, ]}, { name: 'ASSINATURA', type: 'signature', rows: [{ id: 'motor-responsavelTecnico', label: 'Responsável Técnico' }] } ], htmlTemplates: { 'heating': (s) => `<thead><tr><th>CONEXÃO</th><th>Resist. aquec. (MΩ)</th></tr></thead><tbody>${s.rows.map(r => `<tr><td class="label-cell">${r.label}</td><td><input type="number" step="any" data-row="${r.id}" data-col="reg" class="input-yellow"></td></tr>`).join('')}</tbody>`, 'ohmic': (s) => `<thead><tr><th>CONEXÃO</th><th>Valor Registrado</th><th>Corrigido à 25°C</th></tr></thead><tbody>${s.rows.map(r => `<tr><td class="label-cell"><div class="flex items-center justify-between"><span>${r.label}</span><select data-row="${r.id}" data-col="unit" class="unit-selector"><option>MΩ</option><option>Ω</option><option>mΩ</option><option>µΩ</option></select></div></td><td><input type="number" step="any" data-row="${r.id}" data-col="reg" class="input-yellow"></td><td><span data-row="${r.id}" data-col="corr" class="output-span output-blue"></span></td></tr>`).join('')}</tbody>`, 'signature': (s) => `<tbody><tr><td><div class="p-4 bg-gray-50 rounded-lg border"><label for="${s.rows[0].id}" class="font-semibold">${s.rows[0].label}:</label><input type="text" id="${s.rows[0].id}" data-row="${s.rows[0].id}" data-col="reg" class="border rounded px-2 py-1 w-full mt-2" placeholder="Digite o nome do responsável"></div></td></tr></tbody>` }, testData: { header: { cliente: 'Cliente Motor Exemplo', local: 'Oficina Central', data: new Date().toISOString().split('T')[0], equipamento: 'Motor Bomba Principal', numeroSerie: 'SN-MTR-1234', fabricante: 'WEG / W22', tensao: '440V', potencia: '150 CV', rotacao: '1750 RPM', tempAmbiente: 28, tempEnrolamento: 45, umidadeRelativa: 65 }, sections: { 'ESTATOR PRINCIPAL': { 'motor-uxmassa': [1500, 1800, 2500], 'motor-vxmassa': [1600, 1900, 2600], 'motor-wxmassa': [1550, 1850, 2550], 'motor-uxv': [2000, 2200, 3000], 'motor-vxw': [2100, 2300, 3100], 'motor-wxu': [2050, 2250, 3050] }, 'RESISTÊNCIA AQUECIMENTO': { 'motor-heating-massa': 2.5 }, 'MEDIÇÃO RESISTÊNCIA ÔHMICA': { 'motor-ohm-u': 0.05, 'motor-ohm-v': 0.05, 'motor-ohm-w': 0.05 }, 'ASSINATURA': { 'motor-responsavelTecnico': { reg: 'Roosevelt Santos' } } } } }; 
    const transformerConfig = { prefix: 'transformer', appName: 'Transformador', containerId: 'transformer-app-container', containerIds: [{ id: 'transformer-sections-container', type: 'main' }], usageKey: 'unitechTrafoAppUsageCount_v2', usageLimit: 20, tempInputId: 'tempTrafo', insulation: { targetTemp: 75 }, ohmic: { targetTemp: 25 }, layout: 'grid', specialHandlers: reportSheetHandlers, sections: [ { name: 'MEDIÇÕES REALIZADAS', type: 'insulation', rows: [ { id: 'h1h2-low-gnd', title: 'Alta(H1/H2) para Terra com Baixa(X1/X2) em Guard' }, { id: 'x1x2-high-gnd', title: 'Baixa(X1/X2) para Terra com Alta(H1/H2) em Guard' }, { id: 'h1h2-x1x2-gnd', title: 'Alta(H1/H2) para Baixa(X1/X2) com Terra em Guard' }, { id: 'h2h3-low-gnd', title: 'Alta(H2/H3) para Terra com Baixa(X2/X3) em Guard' }, { id: 'x2x3-high-gnd', title: 'Baixa(X2/X3) para Terra com Alta(H2/H3) em Guard' }, { id: 'h2h3-x2x3-gnd', title: 'Alta(H2/H3) para Baixa(X2/X3) com Terra em Guard' }, { id: 'h1h3-low-gnd', title: 'Alta(H1/H3) para Terra com Baixa(X1/X3) em Guard' }, { id: 'x1x3-high-gnd', title: 'Baixa(X1/X3) para Terra com Alta(H1/H3)em Guard' }, { id: 'h1h3-x1x3-gnd', title: 'Alta(H1/H3) para Baixa(X1/X3) com Terra em Guard' }, ]}, { name: 'MEDIÇÃO RESISTÊNCIA ÔHMICA (Corrigido para 25°C)', type: 'ohmic', rows: [ { id: 'x1-x2', label: 'X1-X2' }, { id: 'x1-x1', label: 'X1-X1' }, { id: 'x2-x3', label: 'X2-X3' }, { id: 'x2-x2', label: 'X2-X2' }, { id: 'x1-x3', label: 'X1-X3' }, { id: 'x3-x3', label: 'X3-X3' }, { id: 'h1-h2', label: 'H1-H2' }, { id: 'h1-h1', label: 'H1-H1' }, { id: 'h2-h3', label: 'H2-H3' }, { id: 'h2-h2', label: 'H2-H2' }, { id: 'h1-h3', label: 'H1-H3' }, { id: 'h3-h3', label: 'H3-H3' }, ]}, { name: 'ASSINATURA', type: 'signature', rows: [{ id: 'transformer-responsavelTecnico', label: 'Responsável Técnico' }] } ], htmlTemplates: { 'ohmic': (s) => { let body = ''; for (let i = 0; i < 6; i++) { const r1 = s.rows[i*2]; const r2 = s.rows[i*2+1]; body += `<tr><td><input type="number" step="any" data-row="${r1.id}" data-col="reg" class="input-yellow"></td><td class="label-cell">${r1.label}</td><td><span data-row="${r1.id}" data-col="corr" class="output-span output-blue"></span></td><td><input type="number" step="any" data-row="${r2.id}" data-col="reg" class="input-yellow"></td><td class="label-cell">${r2.label}</td><td><span data-row="${r2.id}" data-col="corr" class="output-span output-blue"></span></td></tr>`; } return `<thead><tr><th>Valor Registrado (mΩ)</th><th>CONEXÃO</th><th>Corrigido à 25°C</th><th>Valor Registrado (mΩ)</th><th>CONEXÃO</th><th>Corrigido à 25°C</th></tr></thead><tbody>${body}</tbody>`; }, 'signature': motorConfig.htmlTemplates.signature }, testData: { header: { cliente: 'OCEANPACT', local: 'MAC LAREN', data: '2025-01-04', equipamento: 'TRANSFORMADOR-BOW THRUSTER', numeroSerie: '155544KW', fabricante: 'WEG', tensao: 'Primário 440V / Secundário 440V', potencia: '50KVA', tempAmbiente: 33.7, tempTrafo: 40.7, umidadeRelativa: 50 }, sections: { 'MEDIÇÕES REALIZADAS': { 'h1h2-low-gnd': [22000, 22000, 22000], 'x1x2-high-gnd': [22000, 22000, 22000], 'h1h2-x1x2-gnd': [22000, 22000, 22000], 'h2h3-low-gnd': [22000, 22000, 22000], 'x2x3-high-gnd': [22000, 22000, 22000], 'h2h3-x2x3-gnd': [22000, 22000, 22000], 'h1h3-low-gnd': [22000, 22000, 22000], 'x1x3-high-gnd': [22000, 22000, 22000], 'h1h3-x1x3-gnd': [22000, 22000, 22000] }, 'MEDIÇÃO RESISTÊNCIA ÔHMICA (Corrigido para 25°C)': { 'x1-x2': 0.35, 'x1-x1': 0.32, 'x2-x3': 0.34, 'x2-x2': 0.33, 'x1-x3': 0.36, 'x3-x3': 0.31, 'h1-h2': 0.45, 'h1-h1': 0.42, 'h2-h3': 0.44, 'h2-h2': 0.43, 'h1-h3': 0.46, 'h3-h3': 0.41 }, 'ASSINATURA': { 'transformer-responsavelTecnico': { reg: 'Roosevelt Santos' } } } } }; 
    const generatorConfig = { prefix: 'gen', appName: 'Gerador', containerId: 'gen-app-container', containerIds: [ { id: 'gen-main-sections-container', type: 'main' }, { id: 'gen-pmg-section-container', type: 'pmg' }, { id: 'gen-extra-sections-container', type: 'extra' }, ], usageKey: 'unitechGenAppUsageCount_v2', usageLimit: 20, tempInputId: 'tempEnrolamento', insulation: { targetTemp: 40 }, ohmic: { targetTemp: 25 }, layout: 'table', specialHandlers: { init: (container, recalc, getEl, clearForm, collectSheetData) => { reportSheetHandlers.init(container, recalc, getEl, clearForm, collectSheetData, generatorConfig); const pmgBtn = getEl('togglePmg'); const pmgSection = getEl('pmg-section-container'); const pmgOhmicRow = document.getElementById('gen-pmg-ohmic-row'); if(pmgBtn) { pmgBtn.addEventListener('click', () => { const isHidden = pmgSection.classList.contains('hidden'); pmgSection.classList.toggle('hidden'); if (pmgOhmicRow) pmgOhmicRow.classList.toggle('hidden'); pmgBtn.textContent = isHidden ? 'Desativar Seção PMG' : 'Ativar Seção PMG'; pmgBtn.classList.toggle('bg-gray-200'); pmgBtn.classList.toggle('bg-yellow-400'); if (!isHidden) { pmgSection.querySelectorAll('input').forEach(i => i.value = ''); if (pmgOhmicRow) pmgOhmicRow.querySelectorAll('input').forEach(i => i.value = ''); recalc(); } }); } }, onClear: (container, getEl) => { const pmgBtn = getEl('togglePmg'); if (pmgBtn && pmgBtn.textContent.includes('Desativar')) { pmgBtn.click(); } } }, sections: [ { name: 'ESTATOR PRINCIPAL', type: 'insulation', containerType: 'main', rows: [ { id: 'gen-estator-uxmassa', label: 'U x Massa' }, { id: 'gen-estator-vxmassa', label: 'V x Massa' }, { id: 'gen-estator-wxmassa', label: 'W x Massa' }, { id: 'gen-estator-uxv', label: 'U x V' }, { id: 'gen-estator-uxw', label: 'U x W' }, { id: 'gen-estator-wxv', label: 'W x V' }, ]}, { name: 'ROTOR PRINCIPAL', type: 'insulation', containerType: 'main', rows: [{ id: 'gen-rotor-principal', label: 'Rotor x Massa' }] }, { name: 'EXCITATRIZ MOTRIZ', type: 'insulation', containerType: 'main', rows: [{ id: 'gen-excitatriz-estator', label: 'Estator x Massa' }, { id: 'gen-excitatriz-rotor', label: 'Rotor x Massa' }] }, { name: 'EXCITAÇÃO AUXILIAR (PMG)', type: 'insulation', containerType: 'pmg', rows: [{ id: 'gen-pmg-estator', label: 'Estator x Massa' }] }, { name: 'RESISTÊNCIA AQUECIMENTO', type: 'heating', containerType: 'extra', rows: [{ id: 'gen-heating-massa', label: 'Massa' }] }, { name: 'MEDIÇÃO RESISTÊNCIA ÔHMICA', type: 'ohmic', containerType: 'extra', rows: [ { id: 'gen-ohm-uxu', label: 'Fase U x U (V)' }, { id: 'gen-ohm-rotorp', label: 'Rotor Principal' }, { id: 'gen-ohm-vxv', label: 'Fase V x V (W)' }, { id: 'gen-ohm-rotore', label: 'Rotor Excitatriz' }, { id: 'gen-ohm-wxw', label: 'Fase W x W (U)' }, { id: 'gen-ohm-estatore', label: 'Estator Ex. Motriz' }, { id: 'gen-ohm-pmg', label: 'PMG', isPmg: true }, ]}, { name: 'DIODOS ROTATIVOS', type: 'diodes', containerType: 'extra', rows: [{ id: 'gen-diodes-dir' }, { id: 'gen-diodes-rev' }] }, { name: 'ASSINATURA', type: 'signature', containerType: 'extra', rows: [{ id: 'gen-responsavelTecnico', label: 'Responsável Técnico' }] } ], htmlTemplates: { ...motorConfig.htmlTemplates, 'ohmic': (s) => { let body = ''; for (let i = 0; i < 3; i++) { const r1 = s.rows[i*2]; const r2 = s.rows[i*2+1]; body += `<tr><td class="label-cell">${r1.label}</td><td><input type="number" step="any" data-row="${r1.id}" data-col="reg" class="input-yellow"></td><td><span data-row="${r1.id}" data-col="corr" class="output-span output-blue"></span></td><td class="label-cell"><div class="flex items-center justify-between"><span>${r2.label}</span><select data-row="${r2.id}" data-col="unit" class="unit-selector"><option>MΩ</option><option>Ω</option><option>mΩ</option><option>µΩ</option></select></div></td><td><input type="number" step="any" data-row="${r2.id}" data-col="reg" class="input-yellow"></td><td><span data-row="${r2.id}" data-col="corr" class="output-span output-blue"></span></td></tr>`; } const pmgRow = s.rows.find(r => r.isPmg); if (pmgRow) { body += `<tr id="gen-pmg-ohmic-row" class="hidden"><td class="label-cell"><div class="flex items-center justify-between"><span>${pmgRow.label}</span><select data-row="${pmgRow.id}" data-col="unit" class="unit-selector"><option>MΩ</option><option>Ω</option><option>mΩ</option><option>µΩ</option></select></div></td><td><input type="number" step="any" data-row="${pmgRow.id}" data-col="reg" class="input-yellow"></td><td><span data-row="${pmgRow.id}" data-col="corr" class="output-span output-blue"></span></td><td colspan="3"></td></tr>`; } return `<thead><tr><th>CONEXÃO</th><th>Valor Registrado</th><th>Corrigido à 25°C</th><th>CONEXÃO</th><th>Valor Registrado</th><th>Corrigido à 25°C</th></tr></thead><tbody>${body}</tbody>`; }, 'diodes': (s) => { let body = `<tr><td class="label-cell">Reversa (OL)</td>${Array.from({length: 6}, (_, i) => `<td><input type="text" data-row="gen-diodes-rev" data-col="d${i+1}" class="input-yellow" value="OL"></td>`).join('')}</tr><tr><td class="label-cell">Direta (Vdc)</td>${Array.from({length: 6}, (_, i) => `<td><input type="number" step="any" data-row="gen-diodes-dir" data-col="d${i+1}" class="input-yellow"></td>`).join('')}</tr>`; let body2 = `<tr><td class="label-cell">Reversa (OL)</td>${Array.from({length: 6}, (_, i) => `<td><input type="text" data-row="gen-diodes-rev" data-col="d${i+7}" class="input-yellow" value="OL"></td>`).join('')}</tr><tr><td class="label-cell">Direta (Vdc)</td>${Array.from({length: 6}, (_, i) => `<td><input type="number" step="any" data-row="gen-diodes-dir" data-col="d${i+7}" class="input-yellow"></td>`).join('')}</tr>`; return `<thead><tr><th>Polarização</th>${Array.from({length: 6}, (_, i) => `<th>D${i+1}</th>`).join('')}</tr></thead><tbody>${body}</tbody><thead><tr><th>Polarização</th>${Array.from({length: 6}, (_, i) => `<th>D${i+7}</th>`).join('')}</tr></thead><tbody>${body2}</tbody>`; } }, testData: { header: { cliente: 'Estaleiro Naval', local: 'Navio Exemplo', data: new Date().toISOString().split('T')[0], tecnico: 'Téc. Exemplo', equipamento: 'Gerador Principal #1', numeroSerie: 'SN-5678', avr: 'AVR-123', tensao: '440V', potencia: '550 kVA', tempAmbiente: 25, tempEnrolamento: 50, umidadeRelativa: 70 }, sections: { 'ESTATOR PRINCIPAL': { 'gen-estator-uxmassa': [1200, 1500, 2000], 'gen-estator-vxmassa': [1300, 1600, 2100], 'gen-estator-wxmassa': [1250, 1550, 2050], 'gen-estator-uxv': [3000, 4000, 5000], 'gen-estator-uxw': [3100, 4100, 5100], 'gen-estator-wxv': [3050, 4050, 5050] }, 'ROTOR PRINCIPAL': { 'gen-rotor-principal': [500, 600, 800] }, 'EXCITATRIZ MOTRIZ': { 'gen-excitatriz-estator': [800, 900, 1100], 'gen-excitatriz-rotor': [700, 850, 1000] }, 'EXCITAÇÃO AUXILIAR (PMG)': { 'gen-pmg-estator': [1000, 1200, 1500] }, 'RESISTÊNCIA AQUECIMENTO': { 'gen-heating-massa': 1.5 }, 'MEDIÇÃO RESISTÊNCIA ÔHMICA': { 'gen-ohm-uxu': 1.1, 'gen-ohm-rotorp': 2.2, 'gen-ohm-vxv': 1.2, 'gen-ohm-rotore': 3.3, 'gen-ohm-wxw': 1.1, 'gen-ohm-estatore': 4.4, 'gen-ohm-pmg': 5.5 }, 'DIODOS ROTATIVOS': { 'gen-diodes-dir': { d1_d6: [0.432, 0.438, 0.441, 0.429, 0.435, 0.440], d7_d12: [0.425, 0.431, 0.428, 0.433, 0.439, 0.427] } }, 'ASSINATURA': { 'gen-responsavelTecnico': { reg: 'Roosevelt Santos' } } } } };

    // --- SISTEMA DE NAVEGAÇÃO E TELAS ---
    const screens = { 
        menu: document.getElementById('menu-screen'), 
        cover: document.getElementById('cover-screen'), 
        index: document.getElementById('index-screen'), 
        savedReports: document.getElementById('saved-reports-screen'),
        companyManagement: document.getElementById('company-management-screen'),
        equipamentos: document.getElementById('equipamentos-screen'),
        gen: document.getElementById('generator-app-screen'), 
        motor: document.getElementById('motor-app-screen'), 
        transformer: document.getElementById('transformer-app-screen'), 
        adminPanel: document.getElementById('admin-panel-screen'),
    };
    const wipModal = document.getElementById('wip-modal');
    
    // --- DECLARAÇÃO DE FUNÇÕES ---

    function showToast(message, type = 'info') {
        const notificationArea = document.getElementById('notification-area');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        notificationArea.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 500);
        }, 3000);
    }

    async function getCompanies() {
        if (!currentUserId) return [];
        const docRef = doc(db, "users", currentUserId, "data", "companies");
        const docSnap = await getDoc(docRef);

        if (docSnap.exists() && docSnap.data().list) {
            return docSnap.data().list;
        } else {
            const defaultCompanies = [
                { id: 'unitech', name: 'UNITECH-NIT', address: 'Rua Galvão Nº 28, Barreto – Niterói – Rio de Janeiro', phones: 'Telefones: (21) 96762-2155 / (21) 97119-2155', phone2: '(21)2608-4184' }
            ];
            await saveCompanies(defaultCompanies);
            return defaultCompanies;
        }
    }

    async function saveCompanies(companies) {
        if (!currentUserId) return;
        const docRef = doc(db, "users", currentUserId, "data", "companies");
        await setDoc(docRef, { list: companies });
    }

    function populateCompanyDropdown() {
        const companySelect = document.getElementById('company-select');
        const originalValue = companySelect.value;
        companySelect.innerHTML = '';
        companyList.forEach(company => {
            const option = document.createElement('option');
            option.value = company.id;
            option.textContent = company.name;
            companySelect.appendChild(option);
        });
        
        if (companyList.some(c => c.id === originalValue)) {
            companySelect.value = originalValue;
        }

        const selectedCompany = companyList.find(c => c.id === companySelect.value);
        currentCompany = selectedCompany || companyList[0];
        if (currentCompany) {
            companySelect.dispatchEvent(new Event('change'));
        }
    }

    function renderCompanyList() {
        const listEl = document.getElementById('company-list');
        listEl.innerHTML = '';
        if (companyList.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500">Nenhuma empresa cadastrada.</p>';
            return;
        }
        companyList.forEach(company => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 rounded-lg border';
            div.innerHTML = `
                <div>
                    <p class="font-semibold">${company.name}</p>
                    <p class="text-xs text-gray-500">${company.address || 'Sem endereço'}</p>
                </div>
                <div class="flex gap-2">
                    <button data-edit-id="${company.id}" class="text-blue-500 hover:text-blue-700 font-bold py-1 px-2 rounded">Editar</button>
                    <button data-delete-id="${company.id}" class="text-red-500 hover:text-red-700 font-bold py-1 px-2 rounded">Apagar</button>
                </div>
            `;
            listEl.appendChild(div);
        });
    }

    function resetCompanyForm() {
        const form = document.getElementById('company-form');
        form.reset();
        document.getElementById('company-id').value = '';
        document.getElementById('company-form-title').textContent = 'Adicionar Nova Empresa';
        document.getElementById('company-form-submit-btn').textContent = 'Adicionar Empresa';
        document.getElementById('company-form-cancel-btn').classList.add('hidden');
    }
    
    async function getSavedFullReports() {
        if (!currentUserId) return [];
        const reportsCol = collection(db, "users", currentUserId, "reports");
        const reportSnapshot = await getDocs(reportsCol);
        const reportList = reportSnapshot.docs.map(doc => ({...doc.data(), firestoreId: doc.id}));
        return reportList;
    }

    function resetCurrentReport() {
        localReportsCache = [];
        document.getElementById('cover-cliente').value = '';
        document.getElementById('cover-local').value = '';
        initializeCoverApp(); 
        updateIndexPage(); 
    }

    async function saveFullReport() {
        if (!currentUserId) {
            showToast('Você precisa estar logado para salvar.', 'error');
            return;
        }

        const cliente = document.getElementById('cover-cliente').value.trim();
        const local = document.getElementById('cover-local').value.trim();

        if (!cliente || !local) {
            showToast('Preencha "Cliente" e "Embarcação" na capa antes de salvar.', 'error');
            showScreen(screens.cover);
            return;
        }

        if (localReportsCache.length === 0) {
            showToast('Não há nenhuma planilha para salvar no relatório.', 'error');
            return;
        }
        
        const fullReport = {
            coverData: {
                cliente: cliente,
                local: local,
                imageDataUrl: coverImageDataUrl, 
                companyKey: document.getElementById('company-select').value
            },
            reportSheets: JSON.parse(JSON.stringify(localReportsCache)),
            savedAt: new Date().toISOString()
        };

        try {
            const reportsCol = collection(db, "users", currentUserId, "reports");
            await addDoc(reportsCol, fullReport);
            showToast(`Relatório para "${cliente}" salvo com sucesso!`, 'success');
            resetCurrentReport();
            showScreen(screens.menu);
        } catch (error) {
            console.error("Erro ao salvar relatório: ", error);
            showToast(`Erro ao salvar: ${error.message}`, 'error');
        }
    }

    async function loadFullReport(reportId) {
        const savedReports = await getSavedFullReports();
        const reportToLoad = savedReports.find(r => r.firestoreId === reportId);

        if (!reportToLoad) {
            showToast("Erro: Relatório não encontrado.", 'error');
            return;
        }

        resetCurrentReport();

        document.getElementById('cover-cliente').value = reportToLoad.coverData.cliente;
        document.getElementById('cover-local').value = reportToLoad.coverData.local;
        
        coverImageDataUrl = reportToLoad.coverData.imageDataUrl;
        document.getElementById('cover-preview-image').src = coverImageDataUrl;

        document.getElementById('company-select').value = reportToLoad.coverData.companyKey || 'unitech';
        document.getElementById('company-select').dispatchEvent(new Event('change'));

        localReportsCache = reportToLoad.reportSheets;

        initializeCoverApp();
        updateIndexPage();

        showToast(`Relatório para "${reportToLoad.coverData.cliente}" carregado!`, 'info');
        showScreen(screens.menu);
    }
    
    async function deleteSavedFullReport(reportId) {
        if (!currentUserId) return;
        try {
            await deleteDoc(doc(db, "users", currentUserId, "reports", reportId));
            showToast('Relatório apagado.', 'success');
            await showSavedReportsScreen();
        } catch (error) {
            console.error("Erro ao apagar relatório: ", error);
            showToast(`Erro ao apagar: ${error.message}`, 'error');
        }
    }

    function updateIndexPage() {
        const indexList = document.getElementById('index-content-list');
        indexList.innerHTML = ''; 

        document.getElementById('cover-preview-cliente').textContent = document.getElementById('cover-cliente').value.toUpperCase() || 'CLIENTE';
        document.getElementById('cover-preview-local').textContent = document.getElementById('cover-local').value.toUpperCase() || 'EMBARCAÇÃO';
        
        if (currentCompany) {
            document.getElementById('index-company-name').textContent = currentCompany.name || '';
            document.getElementById('index-company-address').textContent = currentCompany.address || '';
            document.getElementById('index-company-phones').textContent = currentCompany.phones || '';
            document.getElementById('index-company-phone2').textContent = currentCompany.phone2 || '';
        }

        if (!localReportsCache || localReportsCache.length === 0) {
            indexList.innerHTML = '<p class="text-gray-500 text-center mt-8">Nenhuma planilha de equipamento foi adicionada a este relatório ainda.</p>';
            return;
        }

        let html = '<h2 class="text-xl font-bold mb-4">Equipamentos Analisados:</h2><ul class="list-none space-y-2">';
        localReportsCache.forEach((report, index) => {
             html += `
                <li class="flex items-center justify-between p-2 rounded-md hover:bg-gray-100">
                    <span>${index + 1}. <a href="#" class="text-blue-600 hover:underline" data-report-index="${index}">${report.header.equipamento || 'Planilha sem nome'}</a></span>
                    <button data-delete-index="${index}" class="text-red-500 hover:text-red-700 font-bold text-xl px-2" title="Remover esta planilha do relatório atual">&times;</button>
                </li>`;
        });
        html += '</ul>';
        indexList.innerHTML = html;
    }
    
    async function showSavedReportsScreen() {
        const listEl = document.getElementById('saved-reports-list');
        listEl.innerHTML = '<p class="text-gray-500 text-center">Carregando relatórios...</p>';
        const savedReports = await getSavedFullReports();
        
        if (savedReports.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500 text-center">Nenhum relatório salvo na nuvem ainda.</p>';
        } else {
            listEl.innerHTML = savedReports.map(report => `
                <div class="flex items-center justify-between p-3 rounded-lg border hover:bg-gray-50">
                    <div>
                        <a href="#" data-load-id="${report.firestoreId}" class="font-semibold text-blue-700 hover:underline">${report.coverData.cliente} - ${report.coverData.local}</a>
                        <p class="text-xs text-gray-500">Salvo em: ${new Date(report.savedAt).toLocaleString('pt-BR')}</p>
                    </div>
                    <button data-delete-id="${report.firestoreId}" class="text-red-500 hover:text-red-700 font-bold text-2xl px-3" title="Apagar este relatório salvo">&times;</button>
                </div>
            `).join('');
        }
        showScreen(screens.savedReports);
    }

    function editSheetFromIndex(index) {
        const sheetData = localReportsCache[index];
        if (!sheetData) {
            console.error("Planilha não encontrada no índice:", index);
            return;
        }
        const configMap = { 'gen': generatorConfig, 'motor': motorConfig, 'transformer': transformerConfig };
        const config = configMap[sheetData.type];
        if (!config) {
            console.error("Configuração não encontrada para o tipo de planilha:", sheetData.type);
            return;
        }
        currentlyEditingIndex = index;
        const container = document.getElementById(config.containerId);
        showScreen(screens[config.prefix]);
        populateSheetFromData(container, sheetData, config);
        const addBtn = document.getElementById(`${config.prefix}-add-sheet-btn`);
        if (addBtn) {
            addBtn.textContent = 'Salvar Alterações na Planilha';
            addBtn.disabled = false;
        }
    }
    
    const showScreen = (screenElement, updateHistory = true) => {
        const screenName = Object.keys(screens).find(key => screens[key] === screenElement);
        
        if (!screenName && screenElement) return;

        Object.values(screens).forEach(screen => { 
            if (screen && screen.id !== 'main-app-wrapper' && screen.id !== 'auth-screen') {
                screen.classList.add('hidden');
            }
        }); 
        if (screenElement) screenElement.classList.remove('hidden');

        if (updateHistory && screenName && history.state?.screen !== screenName) {
            history.pushState({ screen: screenName }, '', `#${screenName}`);
        }
    };
    
    function createPlaceholderDataUrl(width, height, text) {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#E2E8F0';
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = '#475569';
        ctx.font = 'bold 20px Inter';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, width / 2, height / 2);
        return canvas.toDataURL();
    }

    function initializeCoverApp() { 
        const inputs = { 
            cliente: document.getElementById('cover-cliente'), 
            local: document.getElementById('cover-local'), 
        }; 
        const imageUpload = document.getElementById('cover-image-upload'); 
        const previews = { 
            cliente: document.getElementById('cover-preview-cliente'), 
            local: document.getElementById('cover-preview-local'), 
            image: document.getElementById('cover-preview-image'), 
        }; 
        function updatePreviewText() { 
            previews.cliente.textContent = inputs.cliente.value.toUpperCase() || 'CLIENTE'; 
            previews.local.textContent = inputs.local.value.toUpperCase() || 'EMBARCAÇÃO'; 
        } 
        Object.values(inputs).forEach(input => input.addEventListener('input', updatePreviewText)); 
        imageUpload.addEventListener('change', (event) => { 
            const file = event.target.files[0]; 
            if (file) { 
                const reader = new FileReader();
                reader.onload = (e) => {
                    coverImageDataUrl = e.target.result; 
                    previews.image.src = coverImageDataUrl;
                };
                reader.readAsDataURL(file);
            } 
        }); 
        
        if (!previews.image.src) {
            coverImageDataUrl = createPlaceholderDataUrl(400, 200, 'Imagem da Embarcação');
            previews.image.src = coverImageDataUrl;
        }

        updatePreviewText(); 
    }

    const createApp = (config) => { 
        const appContainer = document.getElementById(config.containerId); 
        if (!appContainer) return; 
        const getEl = (id) => document.getElementById(`${config.prefix}-${id}`); 
        const recalculate = (container = appContainer) => { const tempInput = container.querySelector(`#${config.prefix}-${config.tempInputId}`); const temp = parseFloat(tempInput?.value); const hasTemp = !isNaN(temp); const KtIns = hasTemp ? getKtInsulation(temp, config.insulation.targetTemp) : 1; const KtOhm = hasTemp ? getKtOhmic(temp, config.ohmic.targetTemp) : 1; config.sections.forEach(section => { if (section.type === 'insulation') { section.rows.forEach(row => { const getVal = (col) => container.querySelector(`input[data-row="${row.id}"][data-col="${col}"]`)?.value || ''; const updateSpan = (col, value, bgColor = '#e0f2fe', textColor = 'black') => { const el = container.querySelector(`span[data-row="${row.id}"][data-col="${col}"]`); if (el) { el.textContent = value; el.style.backgroundColor = bgColor; el.style.color = textColor; } }; const updateDiv = (col, value, bgColor = 'transparent', textColor = 'white') => { const el = container.querySelector(`div[data-row="${row.id}"][data-col="${col}"]`); if(el) { el.textContent = value; el.style.backgroundColor = bgColor; el.style.color = textColor; } }; const reg30s = parseFloat(getVal('reg30s')); const reg1min = parseFloat(getVal('reg1min')); const reg10min = parseFloat(getVal('reg10min')); const highValueThreshold = 21000; const isHigh30s = reg30s > highValueThreshold; const isHigh1min = reg1min > highValueThreshold; const isHigh10min = reg10min > highValueThreshold; const isAnyHigh = isHigh30s || isHigh1min || isHigh10min; const corr30sNum = !isNaN(reg30s) ? (hasTemp ? reg30s * KtIns : reg30s) : NaN; const corr1minNum = !isNaN(reg1min) ? (hasTemp ? reg1min * KtIns : reg1min) : NaN; const corr10minNum = !isNaN(reg10min) ? (hasTemp ? reg10min * KtIns : reg10min) : NaN; let ia_val, ip_val, ia_result, ip_result; if (isAnyHigh) { ia_val = 1.6; ip_val = 4.0; ia_result = { status: 'Excelente', color: statusColors['Excelente'] }; ip_result = { status: 'Excelente', color: statusColors['Excelente'] }; } else { ia_val = (reg1min > 0 && reg30s > 0) ? (reg1min / reg30s) : null; ip_val = (reg10min > 0 && reg1min > 0) ? (reg10min / reg1min) : null; ia_result = evaluateIA(ia_val); ip_result = evaluateIP(ip_val); } const iaTextColor = darkTextStatus.includes(ia_result.status) ? 'black' : 'white'; const ipTextColor = darkTextStatus.includes(ip_result.status) ? 'black' : 'white'; updateSpan('corr30s', isHigh30s ? '>21000' : (!isNaN(corr30sNum) ? corr30sNum.toFixed(0) : '')); updateSpan('corr1min', isHigh1min ? '>21000' : (!isNaN(corr1minNum) ? corr1minNum.toFixed(0) : '')); updateSpan('corr10min', isHigh10min ? '>21000' : (!isNaN(corr10minNum) ? corr10minNum.toFixed(0) : '')); updateSpan('ia_val', ia_val !== null ? ia_val.toFixed(2) : ''); updateSpan('ip_val', ip_val !== null ? ip_val.toFixed(2) : ''); if (config.layout === 'grid') { updateDiv('ia_status', ia_result.status, ia_result.color, iaTextColor); updateDiv('ip_status', ip_result.status, ip_result.color, ipTextColor); } else { updateSpan('ia_status', ia_result.status, ia_result.color, iaTextColor); updateSpan('ip_status', ip_result.status, ip_result.color, ipTextColor); } }); } else if (section.type === 'ohmic') { section.rows.forEach(row => { const regValue = parseFloat(container.querySelector(`input[data-row="${row.id}"][data-col="reg"]`)?.value || ''); const corrValueNum = !isNaN(regValue) ? (hasTemp ? regValue * KtOhm : regValue) : NaN; const span = container.querySelector(`span[data-row="${row.id}"][data-col="corr"]`); if(span) span.textContent = !isNaN(corrValueNum) ? corrValueNum.toFixed(2) : ''; }); } }); }; 
        const createTables = () => { config.containerIds.forEach(container => { const el = document.getElementById(container.id); if(el) el.innerHTML = ''; }); config.sections.forEach(section => { let html = `<section data-section-name="${section.name}">`; html += `<h2 class="section-title">${section.name}</h2>`; if (section.type === 'insulation') { if (config.layout === 'grid') { html += `<div id="${config.prefix}-insulation-grid" class="overflow-x-auto shadow-md">${createGridInsulation(section)}</div>`; } else { html += `<div class="overflow-x-auto shadow-md rounded-lg"><table class="data-table">${createTableInsulation(section)}</table></div>`; html += `<div class="overflow-x-auto shadow-md rounded-lg mt-4"><table class="data-table mt-4 indices-table">${createTableIndices(section)}</table></div>`; } } else { html += `<div class="overflow-x-auto shadow-md rounded-lg"><table class="data-table">${config.htmlTemplates[section.type](section)}</table></div>`; } html += `</section>`; const targetContainerId = config.containerIds.find(c => c.type === (section.containerType || 'main')).id; const targetContainer = document.getElementById(targetContainerId); if(targetContainer) targetContainer.innerHTML += html; }); }; const createTableInsulation = (section) => `<thead><tr><th rowspan="2">CONEXÃO</th><th colspan="3">Valor Registrado (MΩ)</th><th colspan="3">Corrigido à ${config.insulation.targetTemp}°C (MΩ)</th></tr><tr><th>30 Seg</th><th>01 min</th><th>10 min</th><th>30 Seg</th><th>01 min</th><th>10 min</th></tr></thead><tbody>${section.rows.map(row => `<tr><td class="label-cell">${row.label}</td><td><input type="number" step="any" data-row="${row.id}" data-col="reg30s" class="input-yellow"></td><td><input type="number" step="any" data-row="${row.id}" data-col="reg1min" class="input-yellow"></td><td><input type="number" step="any" data-row="${row.id}" data-col="reg10min" class="input-yellow"></td><td><span data-row="${row.id}" data-col="corr30s" class="output-span output-blue"></span></td><td><span data-row="${row.id}" data-col="corr1min" class="output-span output-blue"></span></td><td><span data-row="${row.id}" data-col="corr10min" class="output-span output-blue"></span></td></tr>`).join('')}</tbody>`; const createTableIndices = (section) => `<thead><tr><th>CONEXÃO</th><th>IA Valor</th><th>IA Status</th><th>IP Valor</th><th>IP Status</th></tr></thead><tbody>${section.rows.map(row => `<tr><td class="label-cell">${row.label}</td><td><span data-row="${row.id}" data-col="ia_val" class="output-span output-blue"></span></td><td><span data-row="${row.id}" data-col="ia_status" class="output-span"></span></td><td><span data-row="${row.id}" data-col="ip_val" class="output-span output-blue"></span></td><td><span data-row="${row.id}" data-col="ip_status" class="output-span"></span></td></tr>`).join('')}</tbody>`; const createGridInsulation = (section) => { let gridHtml = ''; section.rows.forEach(test => { gridHtml += `<div class="insulation-cell"><div class="cell-title">${test.title}</div><div class="cell-content"><div class="measurement-row"><div class="measurement-item"><label>30s</label><div class="input-group"><input type="number" step="any" data-row="${test.id}" data-col="reg30s" class="input-yellow"><span class="unit">MΩ</span></div></div><div class="measurement-item"><label>1min</label><div class="input-group"><input type="number" step="any" data-row="${test.id}" data-col="reg1min" class="input-yellow"><span class="unit">MΩ</span></div></div><div class="measurement-item"><label>10min</label><div class="input-group"><input type="number" step="any" data-row="${test.id}" data-col="reg10min" class="input-yellow"><span class="unit">MΩ</span></div></div></div><div class="correction-title">Correção para ${config.insulation.targetTemp}°C</div><div class="measurement-row"><div class="measurement-item"><span data-row="${test.id}" data-col="corr30s" class="output-span output-blue"></span></div><div class="measurement-item"><span data-row="${test.id}" data-col="corr1min" class="output-span output-blue"></span></div><div class="measurement-item"><span data-row="${test.id}" data-col="corr10min" class="output-span output-blue"></span></div></div><div class="indices-row"><div class="index-item"><label>Índice de Absorção</label><span data-row="${test.id}" data-col="ia_val" class="output-span output-blue"></span></div><div class="index-item"><label>Índice de Polarização</label><span data-row="${test.id}" data-col="ip_val" class="output-span output-blue"></span></div></div><div class="indices-row mt-2"><div data-row="${test.id}" data-col="ia_status" class="status-cell"></div><div data-row="${test.id}" data-col="ip_status" class="status-cell"></div></div></div></div>`; }); return gridHtml; }; const clearForm = (config, keepHeader = false) => { const appContainer = document.getElementById(config.containerId); const getEl = (id) => document.getElementById(`${config.prefix}-${id}`); const fieldsToKeep = ['cliente', 'local', 'data']; const headerData = {}; if(keepHeader) { fieldsToKeep.forEach(id => { const el = getEl(id); if (el) headerData[id] = el.value; }); } appContainer.querySelectorAll('input:not([type=text][value=OL])').forEach(input => input.value = ''); appContainer.querySelectorAll('span[data-row], div[data-row]').forEach(el => { el.textContent = ''; el.style.backgroundColor = el.matches('.output-blue') ? '#e0f2fe' : 'transparent'; el.style.color = 'black'; }); if(keepHeader) { fieldsToKeep.forEach(id => { const el = getEl(id); if (el) el.value = headerData[id]; }); } if (config.specialHandlers && config.specialHandlers.onClear) { config.specialHandlers.onClear(appContainer, getEl); } recalculate(); }; const collectSheetData = () => { const data = { header: {}, sections: {}, type: config.prefix, appName: config.appName }; appContainer.querySelectorAll('header input, header select').forEach(input => { const key = input.id.replace(`${config.prefix}-`, ''); data.header[key] = input.value; }); appContainer.querySelectorAll('div.grid input').forEach(input => { const key = input.id.replace(`${config.prefix}-`, ''); data.header[key] = input.value; }); appContainer.querySelectorAll('section[data-section-name]').forEach(sectionEl => { if (sectionEl.parentElement.classList.contains('hidden')) { return; } const sectionName = sectionEl.dataset.sectionName; data.sections[sectionName] = {}; sectionEl.querySelectorAll('input[data-row], select[data-row]').forEach(input => { const row = input.dataset.row; const col = input.dataset.col || 'reg'; if (!data.sections[sectionName][row]) data.sections[sectionName][row] = {}; data.sections[sectionName][row][col] = input.value; }); }); return data; }; 
        createTables(); 
        appContainer.addEventListener('input', (e) => (e.target.matches('input, select')) && recalculate()); 
        if (config.specialHandlers && config.specialHandlers.init) { 
            config.specialHandlers.init(appContainer, recalculate, getEl, (keep) => clearForm(config, keep), collectSheetData, config); 
        } 
        recalculate(); 
        window[`recalculate_${config.prefix}`] = recalculate; 
    };
    
    function populateSheetFromData(container, reportData, config) { Object.entries(reportData.header).forEach(([key, value]) => { const el = container.querySelector(`#${config.prefix}-${key}`); if (el) el.value = value; }); Object.entries(reportData.sections).forEach(([sectionName, sectionData]) => { Object.entries(sectionData).forEach(([rowId, rowData]) => { Object.entries(rowData).forEach(([colId, value]) => { const input = container.querySelector(`input[data-row="${rowId}"][data-col="${colId}"], select[data-row="${rowId}"][data-col="${colId}"]`); if (input) input.value = value; }); }); }); if (config.prefix === 'gen') { const pmgBtn = container.querySelector('#gen-togglePmg'); const pmgSection = container.querySelector('#gen-pmg-section-container'); const hasPmgData = reportData.sections['EXCITAÇÃO AUXILIAR (PMG)']; const isPmgSectionHidden = pmgSection.classList.contains('hidden'); if (hasPmgData && isPmgSectionHidden) { pmgSection.classList.remove('hidden'); } else if (!hasPmgData && !isPmgSectionHidden) { pmgSection.classList.add('hidden'); } } window[`recalculate_${config.prefix}`](container); }
    
    function isFormDirty(container) {
        const inputs = container.querySelectorAll('input[type="number"], input[type="text"]');
        return Array.from(inputs).some(input => {
            const id = input.id || '';
            const value = input.value.trim();
            // Ignora campos de cabeçalho pré-preenchidos e campos com valor padrão "OL"
            if (id.includes('-cliente') || id.includes('-local') || value === 'OL') {
                return false;
            }
            return value !== '';
        });
    }

    // --- INICIALIZAÇÃO E EVENT LISTENERS ---
    
    document.getElementById('company-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const companyId = document.getElementById('company-id').value;
        const companyName = document.getElementById('company-name').value;
        
        if (!companyName.trim()) {
            showToast('O nome da empresa é obrigatório.', 'error');
            return;
        }

        const newCompanyData = {
            name: companyName,
            address: document.getElementById('company-address').value,
            phones: document.getElementById('company-phones').value,
            phone2: document.getElementById('company-phone2').value
        };

        if (companyId) {
            const companyIndex = companyList.findIndex(c => c.id === companyId);
            if (companyIndex > -1) {
                companyList[companyIndex] = { ...companyList[companyIndex], ...newCompanyData };
                showToast('Empresa atualizada com sucesso!', 'success');
            }
        } else {
            newCompanyData.id = Date.now().toString();
            companyList.push(newCompanyData);
            showToast('Empresa adicionada com sucesso!', 'success');
        }

        await saveCompanies(companyList);
        renderCompanyList();
        populateCompanyDropdown();
        resetCompanyForm();
    });

    document.getElementById('company-list').addEventListener('click', async (e) => {
        const editId = e.target.dataset.editId;
        const deleteId = e.target.dataset.deleteId;

        if (editId) {
            const companyToEdit = companyList.find(c => c.id === editId);
            if (companyToEdit) {
                document.getElementById('company-id').value = companyToEdit.id;
                document.getElementById('company-name').value = companyToEdit.name;
                document.getElementById('company-address').value = companyToEdit.address || '';
                document.getElementById('company-phones').value = companyToEdit.phones || '';
                document.getElementById('company-phone2').value = companyToEdit.phone2 || '';
                
                document.getElementById('company-form-title').textContent = 'Editar Empresa';
                document.getElementById('company-form-submit-btn').textContent = 'Salvar Alterações';
                document.getElementById('company-form-cancel-btn').classList.remove('hidden');
            }
        }

        if (deleteId) {
            if (confirm('Tem certeza que deseja apagar esta empresa?')) {
                companyList = companyList.filter(c => c.id !== deleteId);
                await saveCompanies(companyList);
                renderCompanyList();
                populateCompanyDropdown();
                resetCompanyForm(); 
                showToast('Empresa apagada.', 'info');
            }
        }
    });

    document.getElementById('company-form-cancel-btn').addEventListener('click', resetCompanyForm);

    const setupSheetScreen = (prefix) => {
        const btn = document.getElementById(`${prefix}-btn`);
        const configMap = { 'gen': generatorConfig, 'motor': motorConfig, 'transformer': transformerConfig };
        const config = configMap[prefix];

        if (!btn || !config) {
            console.error(`Botão ou configuração para '${prefix}' não encontrado.`);
            return;
        }

        btn.addEventListener('click', () => {
            const usageCount = parseInt(localStorage.getItem(config.usageKey) || '0');

            if (usageCount >= config.usageLimit) {
                const usageLimitOverlay = document.getElementById('usage-limit-overlay');
                usageLimitOverlay.classList.remove('hidden');
                usageLimitOverlay.classList.add('flex');
                return;
            }

            const newUsageCount = usageCount + 1;
            localStorage.setItem(config.usageKey, newUsageCount.toString());

            const remainingUses = config.usageLimit - newUsageCount;
            const counterEl = document.getElementById(`${prefix}-usage-counter`);
            if (counterEl) {
                counterEl.textContent = `Você ainda tem ${remainingUses} usos.`;
                if (remainingUses <= 5) {
                    counterEl.classList.remove('text-gray-600', 'bg-gray-100');
                    counterEl.classList.add('text-red-700', 'bg-red-100');
                } else {
                    counterEl.classList.add('text-gray-600', 'bg-gray-100');
                    counterEl.classList.remove('text-red-700', 'bg-red-100');
                }
            }

            currentlyEditingIndex = null; 
            const addBtn = document.getElementById(`${prefix}-add-sheet-btn`);
            if(addBtn) {
                addBtn.textContent = 'Adicionar ao Relatório';
                addBtn.disabled = true;
            }
            if (currentCompany) {
                document.getElementById(`${prefix}-company-name-header`).textContent = currentCompany.name;
            }
            document.getElementById(`${prefix}-cliente`).value = document.getElementById('cover-cliente').value;
            document.getElementById(`${prefix}-local`).value = document.getElementById('cover-local').value;
            showScreen(screens[prefix]);
        });
    };
    
    // --- CHAMADAS DE INICIALIZAÇÃO ---
    createApp(motorConfig);
    createApp(transformerConfig);
    createApp(generatorConfig);
    setupSheetScreen('gen');
    setupSheetScreen('motor');
    setupSheetScreen('transformer');
    initializeCoverApp();
    
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.screen) {
            const screenName = event.state.screen;
            showScreen(screens[screenName], false);
        } else {
            showScreen(screens.menu, false);
        }
    });

    document.getElementById('cover-btn').addEventListener('click', () => { 
        if (currentCompany) {
            document.getElementById('cover-preview-company-name').textContent = currentCompany.name || '';
            document.getElementById('cover-preview-company-address').textContent = currentCompany.address || '';
            document.getElementById('cover-preview-company-phones').textContent = currentCompany.phones || '';
            document.getElementById('cover-preview-company-phone2').textContent = currentCompany.phone2 || '';
        }
        showScreen(screens.cover); 
    });
    document.getElementById('index-btn').addEventListener('click', () => { updateIndexPage(); showScreen(screens.index); });
    document.getElementById('saved-reports-btn').addEventListener('click', () => { showSavedReportsScreen(); });
    document.getElementById('save-full-report-btn').addEventListener('click', saveFullReport);
    document.getElementById('cover-save-report-btn').addEventListener('click', saveFullReport);
    document.getElementById('manage-companies-btn').addEventListener('click', () => {
        renderCompanyList();
        showScreen(screens.companyManagement);
    });
    document.getElementById('equipamentos-btn').addEventListener('click', () => showScreen(screens.equipamentos));
    document.getElementById('company-management-back-to-cover-btn').addEventListener('click', () => showScreen(screens.cover));
    document.querySelectorAll('[id$="-back-to-menu-btn"]').forEach(btn => { 
        btn.addEventListener('click', (e) => {
            const screenContainer = btn.closest('[id$="-screen"]');
            if (screenContainer) {
                const appContainer = screenContainer.querySelector('[id$="-app-container"]');
                if (appContainer && isFormDirty(appContainer)) {
                    if (!confirm('Você tem alterações não salvas. Deseja sair mesmo assim?')) {
                        return; 
                    }
                }
            }
            showScreen(screens.menu)
        }); 
    });
    document.querySelectorAll('.wip-btn').forEach(btn => btn.addEventListener('click', () => { wipModal.classList.remove('hidden'); wipModal.classList.add('flex'); }));
    document.getElementById('close-wip-modal').addEventListener('click', () => { wipModal.classList.add('hidden'); wipModal.classList.remove('flex'); });
    
    document.getElementById('saved-reports-list').addEventListener('click', async (e) => {
        const loadButton = e.target.closest('[data-load-id]');
        const deleteButton = e.target.closest('[data-delete-id]');

        if (loadButton) {
            e.preventDefault();
            await loadFullReport(loadButton.dataset.loadId);
        }
        if (deleteButton) {
            e.preventDefault();
            if (confirm('Tem certeza que deseja apagar este relatório permanentemente?')) {
                await deleteSavedFullReport(deleteButton.dataset.deleteId);
            }
        }
    });

    document.getElementById('index-content-list').addEventListener('click', (e) => {
        const reportLink = e.target.closest('[data-report-index]');
        const deleteButton = e.target.closest('[data-delete-index]');

        if (reportLink) {
            e.preventDefault();
            editSheetFromIndex(parseInt(reportLink.dataset.reportIndex, 10));
        }
        if (deleteButton) {
            e.preventDefault();
            if (confirm('Tem certeza que deseja remover esta planilha do relatório atual?')) {
                const indexToRemove = parseInt(deleteButton.dataset.deleteIndex, 10);
                localReportsCache.splice(indexToRemove, 1);
                showToast('Planilha removida do relatório.', 'info');
                updateIndexPage();
            }
        }
    });
});
</script>
</body>
</html>
