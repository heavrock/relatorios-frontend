<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Relatórios Técnicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG4WdKCRpI72DhH1ZA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* --- ESTILOS GERAIS E MEGAGEM --- */
        body { font-family: 'Inter', sans-serif; font-size: 14px; }
        .header-info { display: grid; grid-template-columns: auto 1fr; gap: 4px 8px; align-items: center; }
        .header-info label { font-weight: 600; text-align: right; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .data-table th, .data-table td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: center; vertical-align: middle; }
        .data-table th { background-color: #f3f4f6; font-weight: 600; }
        .data-table td.label-cell { text-align: left; font-weight: 500; background-color: #f9fafb; }
        .input-yellow { background-color: #fef9c3; width: 100%; text-align: center; border: 1px solid #fde047; border-radius: 4px; padding: 4px; }
        .input-yellow::placeholder { color: #a1a1aa; }
        .output-span { display: block; width: 100%; height: 100%; padding: 4px; min-height: 28px; border-radius: 4px; transition: background-color 0.3s; }
        .output-blue { background-color: #e0f2fe; }
        .section-title { background-color: #dbeafe; color: #1e3a8a; font-weight: 700; text-align: center; padding: 8px; margin-top: 1rem; margin-bottom: 0.25rem; border-radius: 6px; }
        .unit-selector { padding: 2px 4px; font-size: 12px; border-radius: 4px; border: 1px solid #ccc; background-color: white; margin-left: 8px; }
        .menu-button { background-image: linear-gradient(to right, #4f46e5 0%, #7c3aed 51%, #4f46e5 100%); transition: 0.5s; background-size: 200% auto; box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.75); }
        .menu-button:hover { background-position: right center; }
        .menu-button:disabled { background-image: none; background-color: #9ca3af; cursor: not-allowed; box-shadow: none; }
        #transformer-insulation-grid { display: grid; grid-template-columns: repeat(1, 1fr); border: 2px solid #9ca3af; border-radius: 8px; overflow: hidden; margin-top: 1rem; }
        @media (min-width: 768px) { #transformer-insulation-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { #transformer-insulation-grid { grid-template-columns: repeat(3, 1fr); } }
        .insulation-cell { border-bottom: 1px solid #d1d5db; }
        .insulation-cell:last-child { border-bottom: none; }
        @media (min-width: 1024px) { .insulation-cell { border-right: 1px solid #d1d5db; } .insulation-cell:nth-child(3n) { border-right: none; } .insulation-cell:nth-last-child(-n+3) { border-bottom: none; } }
        @media (min-width: 768px) and (max-width: 1023px) { .insulation-cell { border-right: 1px solid #d1d5db; } .insulation-cell:nth-child(2n) { border-right: none; } .insulation-cell:nth-last-child(-n+2) { border-bottom: none; } }
        .cell-title { background-color: #e5e7eb; font-weight: 600; padding: 6px; text-align: center; border-bottom: 1px solid #d1d5db; font-size: 12px; }
        .cell-content { padding: 8px; }
        .measurement-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; align-items: center; margin-bottom: 6px; }
        .measurement-item { text-align: center; }
        .measurement-item label { font-size: 11px; font-weight: 500; display: block; margin-bottom: 2px; }
        .measurement-item .input-group { display: flex; align-items: center; justify-content: center; }
        .measurement-item input { max-width: 70px; padding: 2px 4px; font-size: 13px; }
        .measurement-item span.unit { font-size: 12px; font-weight: 500; margin-left: 4px; }
        .correction-title { text-align: center; font-weight: 500; font-size: 12px; padding: 4px; background-color: #f9fafb; border-top: 1px solid #d1d5db; border-bottom: 1px solid #d1d5db; margin: 8px -8px; }
        .indices-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .index-item { text-align: center; }
        .index-item label { font-size: 12px; font-weight: 600; display: block; margin-bottom: 2px; }
        .index-item span { display: block; padding: 4px; border-radius: 4px; font-weight: 500; min-height: 28px; }
        .status-cell { padding: 6px; border-radius: 6px; text-align: center; font-weight: bold; color: white; font-size: 12px; min-height: 32px; display: flex; align-items: center; justify-content: center; width: 100%; }
        .report-page { border: 1px solid #ccc; padding: 2rem; max-width: 800px; aspect-ratio: 210 / 297; margin: 2rem auto; background: white; display: flex; flex-direction: column; }
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 2500; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0; transform: translateX(100%); transition: opacity 0.5s, transform 0.5s; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, .3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .confirm-modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .confirm-modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center; }
        .pdf-page-render { width: 210mm; min-height: 297mm; padding: 15mm; margin: 0; display: flex; flex-direction: column; background: white; box-shadow: none; border: none; }
        .pdf-fix-colors .input-yellow { background-color: #fef9c3 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .pdf-fix-colors .output-blue { background-color: #e0f2fe !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        #index-page { display: flex; flex-direction: column; }
        #index-page .index-title { font-size: 1.25rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        #index-page .index-list-item { display: flex; justify-content: space-between; align-items: baseline; font-size: 1rem; padding: 0.75rem 0.25rem; }
        #index-page #index-company-logo { height: 3.5rem; }
        #index-page #index-rep-logo1, #index-page #index-rep-logo2 { height: 2.25rem; }
        #index-page footer { margin-top: auto; padding-top: 2rem; }
        
        /* --- ESTILOS ADICIONAIS DO RELATÓRIO DE BORDO --- */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .bordo-report-page { background: white; width: 210mm; min-height: 297mm; margin: 2rem auto; padding: 15mm; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .bordo-report-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 1rem; }
        .bordo-report-header .company-info { text-align: right; font-size: 10px; }
        .bordo-report-title-bar { background-color: #dbeafe; color: #1e3a8a; font-weight: 700; text-align: center; padding: 8px; margin-top: 1.5rem; margin-bottom: 1.5rem; border-radius: 6px; }
        .bordo-report-footer { margin-top: auto; display: flex; justify-content: center; align-items: center; gap: 2rem; padding-top: 1rem; }
        .bordo-report-footer img { height: 35px; }
        .data-table-report { width: 100%; border-collapse: collapse; font-size: 12px; }
        .data-table-report th, .data-table-report td { border: 1px solid #ccc; padding: 4px 8px; }
        .data-table-report th { background-color: #f0f0f0; text-align: left; }
        .data-table-report tbody tr { height: 1.6em; }
        .row-selected { background-color: #a5b4fc !important; }
        .bordo-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 1500; padding: 1rem; }
        .photo-slot { border: 2px dashed #9ca3af; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 250px; background-color: #f9fafb; position: relative; }
        .photo-slot .image-preview { width: 100%; height: calc(100% - 36px); object-fit: cover; border-radius: 0.5rem 0.5rem 0 0; }
        .photo-slot .upload-label { position: absolute; top: 0; left: 0; right: 0; bottom: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #6b7280; }
        .photo-slot .upload-label:hover { background-color: rgba(0,0,0,0.05); }
        .photo-slot input[type="file"] { display: none; }
        .photo-slot .description-input { width: 100%; border: none; border-top: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem; border-radius: 0 0 0.5rem 0.5rem; background-color: #f3f4f6; }
        .no-print { /* Utility class to hide elements during print */ }
        @media print { .no-print { display: none !important; } .bordo-report-page { margin: 0; box-shadow: none; border: none; } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="notification-area"></div>

    <div id="auth-screen">
        <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4">
            <h1 class="text-4xl font-bold text-white mb-8">Relatórios Técnicos</h1>
            
            <div id="login-form-container" class="w-full max-w-sm">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Acessar Conta</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-indigo-300 mb-2">Email</label>
                            <input type="email" id="login-email" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-indigo-300 mb-2">Senha</label>
                            <input type="password" id="login-password" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <button type="submit" class="w-full menu-button text-white font-bold py-3 px-6 rounded-xl text-lg">Entrar</button>
                    </form>
                    <p class="text-center text-gray-400 mt-6">
                        Não tem uma conta? <a href="#" id="show-register-link" class="text-indigo-300 hover:underline">Crie uma agora</a>
                    </p>
                </div>
            </div>

            <div id="register-form-container" class="w-full max-w-sm hidden">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Criar Nova Conta</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="register-name" class="block text-indigo-300 mb-2">Nome Completo</label>
                            <input type="text" id="register-name" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <div class="mb-4">
                            <label for="register-email" class="block text-indigo-300 mb-2">Email</label>
                            <input type="email" id="register-email" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="block text-indigo-300 mb-2">Senha</label>
                            <input type="password" id="register-password" required class="w-full p-3 rounded-lg border-2 border-indigo-400 bg-gray-600 text-white focus:outline-none focus:border-indigo-200">
                        </div>
                        <button type="submit" class="w-full menu-button text-white font-bold py-3 px-6 rounded-xl text-lg">Criar Conta</button>
                    </form>
                    <p class="text-center text-gray-400 mt-6">
                        Já tem uma conta? <a href="#" id="show-login-link" class="text-indigo-300 hover:underline">Faça o login</a>
                    </p>
                </div>
            </div>

            <div id="pending-approval-container" class="w-full max-w-sm hidden">
                <div class="bg-gray-700 p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-2xl font-bold text-white mb-4">Aguardando Aprovação</h2>
                    <p class="text-indigo-300">Sua conta foi criada com sucesso e está aguardando a aprovação do administrador. Você será notificado por e-mail quando seu acesso for liberado.</p>
                     <button id="pending-back-to-login" class="mt-6 bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition">Voltar para Login</button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app-wrapper" class="hidden">
        
        <div id="report-type-selection-screen" class="hidden">
            <div class="min-h-screen bg-gray-800 flex flex-col items-center justify-center p-4 text-white">
                <h1 class="text-4xl font-bold mb-4">Painel de Controle</h1>
                <p id="selection-user-display-name" class="text-lg text-indigo-300 mb-8"></p>
                <h2 class="text-2xl font-semibold mb-6">Selecione o Tipo de Relatório</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl mb-8">
                    <button id="megagem-report-btn" class="menu-button text-white font-bold py-6 px-6 rounded-xl text-xl">RELATÓRIO TÉCNICO<br>(MEGAGEM)</button>
                    <button id="bordo-report-btn" class="menu-button text-white font-bold py-6 px-6 rounded-xl text-xl">RELATÓRIO TÉCNICO<br>(BORDO)</button>
                </div>
                <div class="flex gap-4">
                     <button id="selection-profile-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Meu Perfil</button>
                     <button id="selection-logout-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Sair</button>
                </div>
            </div>
        </div>

        <div id="menu-screen" class="hidden">
            </div>
        <div id="profile-screen" class="hidden">
            </div>
        <div id="admin-panel-screen" class="hidden">
            </div>
        <div id="equipamentos-screen" class="hidden">
            </div>
        <div id="cover-screen" class="hidden">
            </div>
        <div id="index-screen" class="hidden">
            </div>
        <div id="saved-reports-screen" class="hidden">
            </div>
        <div id="company-management-screen" class="hidden">
            </div>
        <div id="generator-app-screen" class="hidden">
            </div>
        <div id="motor-app-screen" class="hidden">
            </div>
        <div id="transformer-app-screen" class="hidden">
            </div>

        <div id="bordo-app-screen" class="hidden p-2 sm:p-6">
            </div>
        <div id="bordo-itens-screen" class="hidden p-4 sm:p-6">
            </div>
        <div id="bordo-report-preview-screen" class="hidden">
            </div>
        <div id="horasTrabalhadas-modal" class="bordo-modal">
            </div>
        <div id="horasViagem-modal" class="bordo-modal">
            </div>
        <div id="materiais-modal" class="bordo-modal">
             </div>
        <div id="comentarios-modal" class="bordo-modal">
            </div>
        <div id="descricaoServicos-modal" class="bordo-modal">
             </div>
        <div id="relatorioFotografico-modal" class="bordo-modal">
             </div>

        <div id="wip-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
             <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
                 <h3 class="text-xl font-bold text-blue-800 mb-4">Em Desenvolvimento</h3>
                 <p class="text-gray-700 mb-6">Esta funcionalidade estará disponível em breve!</p>
                 <button id="close-wip-modal" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Fechar</button>
             </div>
        </div>
        <div id="pdf-loader-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center text-center text-white p-8 z-[200]">
             <div>
                 <svg class="animate-spin h-10 w-10 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                 </svg>
                 <h2 class="text-2xl font-bold">Gerando Relatório em PDF...</h2>
                 <p class="text-lg mt-2">Isso pode levar alguns segundos. Por favor, aguarde.</p>
             </div>
        </div>
    </div>

<script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Módulo de serviço do Firebase
    const firebaseService = { /* ... código completo e inalterado do firebaseService ... */ };
    
    // Objeto de Estado Centralizado
    const appState = { /* ... código completo e inalterado do appState ... */ };


document.addEventListener('DOMContentLoaded', () => {
    firebaseService.init();
    if (!firebaseService.auth) { /* ... Lógica de erro de inicialização ... */ return; }

    // ==================================================================================
    // --- MÓDULO DE NAVEGAÇÃO UNIFICADO ---
    // ==================================================================================
    const navigation = {
        screens: { 
            reportTypeSelection: document.getElementById('report-type-selection-screen'),
            menu: document.getElementById('menu-screen'), cover: document.getElementById('cover-screen'), index: document.getElementById('index-screen'), savedReports: document.getElementById('saved-reports-screen'),
            companyManagement: document.getElementById('company-management-screen'), equipamentos: document.getElementById('equipamentos-screen'), gen: document.getElementById('generator-app-screen'), 
            motor: document.getElementById('motor-app-screen'), transformer: document.getElementById('transformer-app-screen'), adminPanel: document.getElementById('admin-panel-screen'), profile: document.getElementById('profile-screen'),
            bordoApp: document.getElementById('bordo-app-screen'), bordoItens: document.getElementById('bordo-itens-screen'), bordoReportPreview: document.getElementById('bordo-report-preview-screen'),
        },
        modals: {
            horasTrabalhadas: document.getElementById('horasTrabalhadas-modal'), horasViagem: document.getElementById('horasViagem-modal'), materiais: document.getElementById('materiais-modal'),
            comentarios: document.getElementById('comentarios-modal'), descricaoServicos: document.getElementById('descricaoServicos-modal'), relatorioFotografico: document.getElementById('relatorioFotografico-modal'),
        },
        currentScreen: null,
        to: function(screenName, updateHistory = true) { /* ... código completo e inalterado da função to() ... */ },
        showModal: function(modalName) { /* ... código da função showModal ... */ },
        hideModal: function(modalName) { /* ... código da função hideModal ... */ },
        init: function(defaultScreen = 'reportTypeSelection') { /* ... código completo e inalterado da função init() ... */ },
        checkDirtyStateAndNavigate: async function(targetScreen) { /* ... código completo e inalterado ... */ }
    };

    // ==================================================================================
    // --- MÓDULO DE UI E FEEDBACK (INALTERADO) ---
    // ==================================================================================
    const uiFeedback = { /* ... código completo e inalterado do uiFeedback ... */ };

    // ==================================================================================
    // --- LÓGICA DE AUTENTICAÇÃO, ADMIN E PERFIL (INALTERADA) ---
    // ==================================================================================
    /* ... todo o código completo e inalterado para auth, admin e perfil vai aqui ... */
    

    // ==================================================================================
    // --- LÓGICA PRINCIPAL DO RELATÓRIO DE MEGAGEM (INALTERADA) ---
    // ==================================================================================
    /* ... todo o código completo e inalterado para o relatório de megagem (constantes, configs, createApp, etc.) vai aqui ... */


    // ==================================================================================
    // --- NOVO MÓDULO: RELATÓRIO DE BORDO ---
    // ==================================================================================
    const bordoReportManager = {
        // ... (Aqui entra toda a lógica encapsulada do Relatório de Bordo: state, modalData, photoManager, saveDraft, loadDraft, saveToFirebase, exportPDF, init, etc.)
    };

    // --- INICIALIZAÇÃO E EVENT LISTENERS GERAIS ---
    createApp(motorConfig);
    createApp(transformerConfig);
    createApp(generatorConfig);
    setupSheetScreen('gen');
    setupSheetScreen('motor');
    setupSheetScreen('transformer');
    initializeCoverApp();
    
    // NOVO: Inicializa o módulo de Bordo
    bordoReportManager.init();
    
    // --- EVENT LISTENERS DE NAVEGAÇÃO (ATUALIZADOS) ---
    /* ... (Aqui entram todos os event listeners, antigos e novos, usando o objeto `navigation` unificado) ... */

});
</script>
</body>
</html>